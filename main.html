<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© | Ù„Ø§ Ø£Ø¨Ø±Ø­ Ø­ØªÙ‰ Ø£Ø¨Ù„Øº</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- START: Added meta tags to prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- END: Added meta tags to prevent caching -->
    <!-- START: Added for Commitment Document -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- END: Added for Commitment Document -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #00a884;
            --danger-color: #ff5c5c;
            --background-color: #121212;
            --card-background: #1e1e1e;
            --text-color: #FAFAFA;
            --secondary-text-color: #CCCCCC;
            --border-color: #383838;
            --day-color: #86efac;
            --hour-color: #3b82f6;
            --minute-color: #ec4899;
            --second-color: #facc15;
            --progress-bg: rgba(0, 0, 0, 0.2);
        }
        body, html {
            margin: 0; padding: 0; font-family: 'Tajawal', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            position: fixed; width: 100%; height: 100%; overflow: hidden;
        }
        .page { display: none; flex-direction: column; height: 100%; width: 100%; }
        .page.active { display: flex; }
        .home-container { display: flex; flex-direction: column; height: 100vh; }
        .content-area { flex-grow: 1; overflow-y: auto; padding: 1rem; padding-bottom: 80px; }
        .top-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            background-color: rgba(18, 18, 18, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .header-icons { display: flex; gap: 1.5rem; font-size: 1.5rem; color: var(--secondary-text-color); align-items: center;}
        .header-icons i { cursor: pointer; }
        .header-icons a { color: var(--secondary-text-color); text-decoration: none; }
        .notification-icon-wrapper { position: relative; cursor: pointer; }
        .notification-badge { position: absolute; top: -2px; right: -5px; width: 10px; height: 10px; background-color: var(--danger-color); border-radius: 50%; border: 2px solid var(--background-color); display: none; }
        .welcome-message { text-align: right; }
        .welcome-message h5 { margin: 0; font-weight: 700; color: var(--text-color);}
        .welcome-message p { margin: 0; font-size: 0.9rem; color: var(--secondary-text-color); }
        .progress-timer-card { 
            background: linear-gradient(135deg, #054238, #008069); 
            color: white; 
            border-radius: 20px; 
            padding: 1.5rem; 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 10px 25px rgba(0, 128, 105, 0.3); 
            margin-bottom: 1.5rem;
            background-size: cover;
            background-position: center;
        }
        .timer-settings-icon { position: absolute; top: 1rem; left: 1rem; background-color: rgba(255, 255, 255, 0.15); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 10; }
        .progress-rows-container { position: relative; z-index: 5; margin-top: 2rem; }
        .progress-row { display: flex; align-items: center; background-color: var(--progress-bg); border-radius: 12px; padding: 0.7rem 1rem; margin-bottom: 0.8rem; position: relative; overflow: hidden; }
        .progress-row:last-child { margin-bottom: 0; }
        .progress-bar-fill { position: absolute; left: 0; top: 0; height: 100%; border-radius: 12px; transition: width 0.5s ease-in-out; }
        .progress-row .row-content { position: relative; z-index: 2; display: flex; width: 100%; align-items: center; justify-content: space-between; }
        .progress-row .time-label { font-weight: 700; font-size: 1rem; }
        .progress-row .time-icon { font-size: 1.2rem; }
        #days-fill { background-color: var(--day-color); }
        #hours-fill { background-color: var(--hour-color); }
        #minutes-fill { background-color: var(--minute-color); }
        #seconds-fill { background-color: var(--second-color); }
        .action-button { background-color: var(--card-background); border-radius: 15px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; text-decoration: none; color: var(--text-color); box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 1rem; font-weight: 500; border: 1px solid var(--border-color); width: 100%; }
        .action-button.najda-style { background-color: rgba(255, 92, 92, 0.1); color: var(--danger-color); border: 1px solid rgba(255, 92, 92, 0.5); justify-content: center; gap: 10px; font-size: 1.2rem; font-weight: 700; }
        .action-button.najda-style i { font-size: 1.5rem; }
        .bottom-nav { 
            display: flex; 
            justify-content: space-around; 
            padding: 0.5rem 0; 
            background-color: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2); 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            z-index: 100; 
            border-top: 1px solid rgba(56, 56, 56, 0.5); 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text-color); text-decoration: none; font-size: 0.75rem; cursor: pointer; width: 14%; height: 50px; justify-content: center; }
        .nav-item i { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.special-item { transform: translateY(-20px); position: relative; } 
        .special-item .icon-background { background: linear-gradient(135deg, #00a884, #00c896); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0, 168, 132, 0.4); }
        .special-item i { color: white; font-size: 2rem; margin: 0; }
        .chat-notification-badge {
            position: absolute;
            top: -8px; 
            right: 25px; 
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 13px;
            font-weight: bold;
            display: none; 
            justify-content: center;
            align-items: center;
            border: 2px solid var(--card-background);
            z-index: 1;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1050; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content-custom { background-color: var(--card-background); border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transform: scale(0.9); transition: transform 0.3s ease; width: 90%; max-width: 400px; }
        .modal-overlay.show .modal-content-custom { transform: scale(1); }
        #settings-modal-overlay { align-items: flex-end; }
        #settings-modal-content { background-color: var(--background-color); width: 100%; max-width: 800px; border-top-left-radius: 20px; border-top-right-radius: 20px; border-bottom-left-radius: 0; border-bottom-right-radius: 0; transform: translateY(100%); }
        #settings-modal-overlay.show #settings-modal-content { transform: translateY(0); }
        .modal-header-custom { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .modal-header-custom h5 { margin: 0; font-weight: 700; color: #FFFFFF; }
        .modal-header-custom i { font-size: 1.2rem; cursor: pointer; color: var(--secondary-text-color); }
        .modal-body-custom { padding: 1.5rem; }
        .icon-container.yellow { background-color: #fffbe6; color: #f9c74f; }
        .icon-container.blue { background-color: #e6f7ff; color: #34b7f1; }
        .icon-container.green { background-color: #e6f9f0; color: #00a884; }
        .icon-container.red { background-color: #ffebee; color: #ff5c5c; }
        .confirm-modal-body { text-align: center; padding: 2rem 1.5rem; }
        .confirm-modal-body .confirm-icon { font-size: 4rem; color: var(--text-color); margin-bottom: 1rem; }
        .confirm-modal-body p { font-size: 1.1rem; font-weight: 500; margin-bottom: 2rem; }
        .confirm-modal-footer { display: flex; gap: 1rem; padding: 0 1.5rem 1.5rem; }
        .confirm-btn { flex: 1; padding: 0.8rem; border-radius: 12px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; }
        .confirm-btn-accept { background-color: var(--primary-color); color: white; }
        .confirm-btn-cancel { background-color: var(--danger-color); color: white; }
        #breathing-circle-container { width: 200px; height: 200px; border: 5px solid rgba(255, 255, 255, 0.7); border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        #breathing-circle { width: 100%; height: 100%; background-color: white; border-radius: 50%; transform: scale(0.2); animation-duration: 19s; animation-iteration-count: infinite; animation-name: breathe; animation-timing-function: ease-in-out; }
        @keyframes breathe { 0% { transform: scale(0.2); } 21% { transform: scale(1); } 58% { transform: scale(1); } 100% { transform: scale(0.2); } }
        .notification-item { position: relative; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; padding-left: 30px; }
        .notification-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .notification-title { font-weight: 700; color: #FFFFFF; }
        .notification-body { color: var(--secondary-text-color); font-size: 0.9rem; }
        .notification-date { font-size: 0.8rem; color: #aaa; }
        .delete-notification-btn { position: absolute; left: 5px; top: 50%; transform: translateY(-50%); color: var(--danger-color); cursor: pointer; font-size: 1.2rem; display: none; }
        #quote-page { 
            justify-content: center; 
            align-items: center; 
            padding: 2rem; 
            text-align: center; 
            color: white; 
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out;
        }
        .quote-box { position: relative; background-color: rgba(0, 0, 0, 0.4); border: 2px solid rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 25px; padding: 4rem 2rem; width: 100%; max-width: 500px; }
        .quote-box::before, .quote-box::after { font-family: serif; font-size: 6rem; font-weight: bold; color: white; position: absolute; opacity: 0.8; }
        .quote-box::before { content: 'â€'; top: -1.5rem; right: 1rem; }
        .quote-box::after { content: 'â€œ'; bottom: -4.5rem; left: 1rem; }
        .top-indicator-bar { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 35%; max-width: 150px; height: 5px; background-color: white; border-radius: 5px; opacity: 0.7; }
        #quote-text { font-size: 1.5rem; font-weight: 700; line-height: 1.7; text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); }
        #close-quote-btn { position: absolute; top: 20px; left: 20px; font-size: 1.8rem; cursor: pointer; z-index: 10; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .card-title { font-weight: 700; color: #FFFFFF; }
        .modal-title { color: #FFFFFF; }
        #notifications-modal .modal-content, #achievementsModal .modal-content, #congratsAchievementModal .modal-content, #userAchievementsModal .modal-content { background-color: var(--background-color); color: var(--text-color); }
        #notifications-modal .modal-header, #achievementsModal .modal-header, #congratsAchievementModal .modal-header, #userAchievementsModal .modal-header { border-bottom: 1px solid var(--border-color); }
        #notifications-modal .btn-close, #achievementsModal .btn-close, #congratsAchievementModal .btn-close, #userAchievementsModal .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .action-button.najda-style .bi-fire { animation: fire-flicker 1.5s ease-in-out infinite alternate; position: relative; top: 3px; }
        @keyframes fire-flicker { 0% { transform: scale(1.0) translateY(0) rotate(0); color: #ffad00; text-shadow: 0 0 4px #ff5c5c, 0 0 8px #ff5c5c, 0 0 12px #ffad00; } 25% { transform: scale(1.1) translateY(-2px) rotate(3deg); color: #facc15; text-shadow: 0 0 6px #ff5c5c, 0 0 10px #ff5c5c, 0 0 16px #facc15; } 50% { transform: scale(0.95) translateY(1px) rotate(-2deg); color: var(--danger-color); text-shadow: 0 0 4px #ff5c5c, 0 0 8px #ff5c5c, 0 0 12px #ffad00; } 75% { transform: scale(1.05) translateY(-1px) rotate(2deg); color: #facc15; text-shadow: 0 0 6px #ff5c5c, 0 0 12px #ff5c5c, 0 0 18px #facc15; } 100% { transform: scale(1.0) translateY(0) rotate(0); color: #ffad00; text-shadow: 0 0 4px #ff5c5c, 0 0 8px #ff5c5c, 0 0 12px #ffad00; } }
        .fire-alarm { width: 28px; height: 24px; position: relative; }
        .fire-alarm-dome { width: 100%; height: 20px; position: absolute; top: 0; left: 0; background: radial-gradient(circle at 50% 0%, #ff8a8a, #d10000 90%); border-radius: 14px 14px 3px 3px; overflow: hidden; z-index: 2; border: 1px solid #ff5c5c; }
        .fire-alarm-dome::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: repeating-linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 0px, rgba(255, 255, 255, 0.15) 1px, transparent 1px, transparent 3px); z-index: 3; }
        .fire-alarm-dome::after { content: ''; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,220,150,0.9) 0%, rgba(255,100,100,0) 35%); border-radius: 50%; transform: translate(-50%, -50%); animation: beacon-flash 1.2s infinite ease-in-out; z-index: 4; }
        .fire-alarm-base { width: 28px; height: 5px; background: linear-gradient(to top, #c00000, #e02020); position: absolute; bottom: 0; left: 0; border-radius: 0 0 4px 4px; z-index: 1; box-shadow: 0 2px 3px rgba(0,0,0,0.5); }
        @keyframes beacon-flash { 0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        .image-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            border-radius: 20px; 
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        .image-background.visible {
            opacity: 1;
        }
        .image-background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.45); 
            z-index: 2;
            border-radius: 20px; 
            display: none; 
            transition: opacity 0.5s ease-in-out;
        }
         .image-background-overlay.visible {
            display: block;
        }
        #app-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(18, 18, 18, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .lock-container {
            text-align: center;
            padding: 2rem;
            background-color: var(--card-background);
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }
        .lock-container .icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        #passcode-input {
            max-width: 200px;
            margin: 1.5rem auto;
            letter-spacing: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
            direction: ltr;
        }
        #passcode-input::placeholder {
            letter-spacing: normal;
        }
        #unlock-btn {
            width: 100%;
            max-width: 200px;
        }
        #passcode-error {
            display: none;
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        #ai-advice-card {
            position: relative;
            background-size: cover;
            background-position: center;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            overflow: hidden;
            transition: background-image 0.5s ease-in-out;
            margin-top: 1rem;
        }
        #ai-advice-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 1;
        }
        #ai-advice-content {
            position: relative;
            z-index: 2;
        }
        #ai-advice-text {
            font-size: 1.1rem;
            font-weight: 500;
            line-height: 1.8;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
        #ai-advice-refresh-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 3;
            font-size: 1.4rem;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        #ai-advice-refresh-btn:hover {
            transform: rotate(90deg);
            background-color: rgba(255, 255, 255, 0.2);
        }
        .spinner-grow-sm {
            width: 1rem;
            height: 1rem;
        }
        #inspiration-display, #salaf-story-display {
            position: relative;
            background-size: cover;
            background-position: center;
            color: white;
            overflow: hidden;
            transition: background-image 0.5s ease-in-out;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }
        #inspiration-display::before, #salaf-story-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 1;
            border-radius: 15px;
        }
        #inspiration-text, #salaf-story-text {
            position: relative;
            z-index: 2;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
        body.solid-black-bg {
            background-image: none !important;
            background-color: #000000 !important;
        }
        body.gradient-blue-bg {
            background-image: linear-gradient(135deg, #0f2027, #203a43, #2c5364) !important;
        }
        /* START: Achievement Styles */
        #achievements-grid, #user-achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        .achievement-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            transition: all 0.4s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .achievement-card-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #facc15; /* Gold */
            text-shadow: 0 0 15px rgba(250, 204, 21, 0.5);
        }
        .achievement-card-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }
        .achievement-card-date {
            font-size: 0.75rem;
            color: var(--secondary-text-color);
        }
        .achievement-card.locked {
            background-color: rgba(30, 30, 30, 0.7);
            border-color: #383838;
            color: #888;
            box-shadow: none;
            filter: grayscale(80%);
        }
        .achievement-card.locked .achievement-card-icon {
            color: #555;
            text-shadow: none;
        }
        #congrats-modal-body {
            text-align: center;
            padding: 2rem 1.5rem;
        }
        #congrats-icon {
            font-size: 5rem;
            color: #facc15; /* Gold color */
            margin-bottom: 1rem;
            animation: tada 1.5s ease-in-out;
        }
        @keyframes tada {
            from { transform: scale3d(1, 1, 1); }
            10%, 20% { transform: scale3d(0.9, 0.9, 0.9) rotate3d(0, 0, 1, -3deg); }
            30%, 50%, 70%, 90% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg); }
            40%, 60%, 80% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg); }
            to { transform: scale3d(1, 1, 1); }
        }
        #congrats-text {
            font-size: 1.2rem;
            font-weight: 700;
        }
        #congrats-user-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        /* END: Achievement Styles */

        /* START: Leaderboard Styles */
        #leaderboardModal .modal-content {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        #leaderboardModal .modal-header {
            border-bottom: 1px solid var(--border-color);
        }
        #leaderboardModal .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .leaderboard-item:hover {
            transform: translateY(-2px);
        }
        .leaderboard-rank {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--secondary-text-color);
            width: 35px;
            text-align: center;
        }
        .leaderboard-user-pic {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 1rem;
            border: 2px solid var(--border-color);
        }
        .leaderboard-user-info {
            flex-grow: 1;
            overflow: hidden;
        }
        .leaderboard-user-name {
            font-weight: 700;
            margin: 0;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .leaderboard-user-days {
            margin: 0;
            color: var(--primary-color);
            font-size: 0.9rem;
            font-weight: 500;
        }
        .leaderboard-delete-btn {
            color: var(--danger-color);
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        .leaderboard-delete-btn:hover {
            opacity: 1;
        }
        .leaderboard-restore-btn {
            color: var(--day-color); /* Greenish color */
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        .leaderboard-restore-btn:hover {
            opacity: 1;
        }
        .leaderboard-item.rank-1, .leaderboard-item.rank-2, .leaderboard-item.rank-3 {
            border-width: 2px;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .leaderboard-item.rank-1 { border-color: #FFD700; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), var(--card-background)); }
        .leaderboard-item.rank-2 { border-color: #C0C0C0; background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), var(--card-background)); }
        .leaderboard-item.rank-3 { border-color: #CD7F32; background: linear-gradient(135deg, rgba(205, 127, 50, 0.1), var(--card-background)); }
        .leaderboard-rank-medal {
            font-size: 2rem;
            width: 35px;
            text-align: center;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
        }
        .loading-spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        #leaderboard-footer-user-rank {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 700;
            border-top: 1px solid var(--border-color);
            border-bottom-left-radius: var(--bs-modal-inner-border-radius);
            border-bottom-right-radius: var(--bs-modal-inner-border-radius);
            margin: 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        #leaderboardModal .nav-tabs {
            border-bottom: none;
        }
        #leaderboardModal .nav-link {
            border: none;
            background: none;
            color: var(--secondary-text-color);
            width: 50%;
            text-align: center;
            font-size: 0.9rem;
            padding: 0.75rem 0.5rem;
        }
        #leaderboardModal .nav-link.active {
            background-color: var(--card-background);
            color: var(--primary-color);
            font-weight: 700;
            border-radius: 8px;
        }
        /* END: Leaderboard Styles */

        /* START: Added for Commitment Document */
        .action-button.commitment-style {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: 1px solid rgba(124, 58, 237, 0.7);
            justify-content: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .action-button.commitment-style i {
            font-size: 1.5rem;
        }

        #commitment-document-page {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f7f6;
            overflow-y: auto;
            position: relative;
        }
        #commitment-document-page .form-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            color: #374151;
        }
        #commitment-document-page textarea {
            resize: vertical;
            min-height: 120px;
        }
        #commitment-document-page .main-title { color: #108a71; }
        #commitment-document-page .edit-title { color: #0d9488; }
        #commitment-document-page .btn-save { background-color: #10b981; transition: background-color 0.3s; }
        #commitment-document-page .btn-save:hover { background-color: #059669; }
        #commitment-document-page .btn-edit { background-color: #0d9488; transition: background-color 0.3s; }
        #commitment-document-page .btn-edit:hover { background-color: #0f766e; }
        #commitment-document-page .btn-delete { background-color: #dc2626; transition: background-color 0.3s; }
        #commitment-document-page .btn-delete:hover { background-color: #b91c1c; }
        #commitment-document-page .btn-update { background-color: #0d9488; transition: background-color 0.3s; }
        #commitment-document-page .btn-update:hover { background-color: #0f766e; }

        #commitment-document-page #document-page {
            background-color: #f8fafc;
        }
        #commitment-document-page .document-container {
            background-color: white;
            border-radius: 1rem;
            padding: 2.5rem 3rem;
            margin: 2rem auto;
            max-width: 800px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.08), 0 8px 10px -6px rgb(0 0 0 / 0.08);
            border-top: 6px solid #10b981;
        }
        #commitment-document-page #document-content {
            color: #374151;
            font-size: 1.1rem;
            line-height: 2.2;
        }
        #commitment-document-page .icon {
            width: 24px;
            height: 24px;
            margin-left: 8px;
        }
        @media (max-width: 768px) {
            #commitment-document-page .document-container { padding: 2rem; }
            #commitment-document-page #document-content { font-size: 1rem; line-height: 2; }
        }
        @media (max-width: 480px) {
            #commitment-document-page #document-page { padding: 1rem 0.5rem; }
            #commitment-document-page .document-container { padding: 1.5rem; margin: 1rem auto; }
            #commitment-document-page #document-content { font-size: 0.95rem; line-height: 1.9; }
        }
        /* END: Added for Commitment Document */

        /* -- START: Animations for Commitment Document -- */
        #commitment-document-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            transform: translateY(100%);
            visibility: hidden;
            transition: transform 0.4s ease-in-out, visibility 0s 0.4s;
        }
        #commitment-document-page.page.active {
            transform: translateY(0);
            visibility: visible;
            transition: transform 0.4s ease-in-out;
            display: block !important;
        }
        #form-page, #document-page, #edit-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out, visibility 0s 0.3s;
            overflow-y: auto;
        }
        #form-page.visible, #document-page.visible, #edit-page.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transition: opacity 0.3s ease-in-out;
        }
        /* -- END: Animations for Commitment Document -- */

        /* -- START: Custom Modal Animation -- */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
        /* -- END: Custom Modal Animation -- */

        /* START: Loading Spinner Styles */
        .loading-spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .loading-spinner-overlay.show {
            display: flex;
            opacity: 1;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 7px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* END: Loading Spinner Styles */

        /* START: Sleep Improvement Styles */
        .action-button.sleep-style {
            background: linear-gradient(135deg, #2c3e50, #4b79a1);
            color: white;
            border: 1px solid rgba(75, 121, 161, 0.7);
            justify-content: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .action-button.sleep-style i {
            font-size: 1.5rem;
        }
        #sleep-improvement-page {
            background-color: var(--background-color);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1100;
            transform: translateX(100%);
            transition: transform 0.4s ease-in-out;
            display: flex !important;
            flex-direction: column;
        }
        #sleep-improvement-page.active {
            transform: translateX(0);
        }
        .sleep-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            flex-shrink: 0;
        }
        .sleep-header h5 {
            margin: 0;
            font-weight: 700;
        }
        #back-to-home-from-sleep-btn {
            font-size: 1.5rem;
            cursor: pointer;
        }
        .sleep-content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        .sleep-card {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .sleep-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .time-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .time-input-container {
            flex: 1;
        }
        .time-input-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--secondary-text-color);
        }
        .time-input-container input[type="time"] {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-color);
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
        }
        .user-option-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.8rem 1rem;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
            width: 100%;
        }
        .user-option-btn:hover {
            background-color: #008a70;
        }
        .daily-question-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .daily-question-options .user-option-btn {
            flex-grow: 1;
            width: auto;
        }
        #sleep-duration-display {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--secondary-text-color);
            margin-bottom: 1.5rem;
        }
        #sleep-chart-container {
            padding: 1rem;
            background-color: var(--card-background);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            height: 300px;
        }
        #weekly-analysis-container {
            min-height: 150px;
            line-height: 1.8;
            font-size: 1.05rem;
        }
        .last-updated-text {
            font-size: 0.8rem;
            color: #888;
            margin-top: 1rem;
            text-align: left;
        }
        .hidden-section {
            display: none;
        }
        /* END: Sleep Improvement Styles */
    </style>
</head>
<body style="visibility: hidden;">
    <div id="app-lock-overlay">
        <div class="lock-container">
            <i class="bi bi-shield-lock-fill icon"></i>
            <h5>Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù‚ÙÙ„</h5>
            <p class="text-secondary small">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="form-control" id="passcode-input" placeholder="----">
            <div id="passcode-error">Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­</div>
            <button id="unlock-btn" class="btn btn-primary mt-2">ÙØªØ­ Ø§Ù„Ù‚ÙÙ„</button>
        </div>
    </div>

    <div id="home-page" class="page active">
        <div class="home-container">
            <header class="top-header">
                <div class="header-icons">
                    <i class="bi bi-trophy-fill" data-bs-toggle="modal" data-bs-target="#achievementsModal"></i>
                    <i class="bi bi-bar-chart-steps" data-bs-toggle="modal" data-bs-target="#leaderboardModal"></i>
                    <div class="notification-icon-wrapper" data-bs-toggle="modal" data-bs-target="#notifications-modal">
                        <i class="bi bi-bell-fill"></i>
                        <span class="notification-badge"></span>
                    </div>
                    <a href="settings.html"><i class="bi bi-person-circle"></i></a>
                </div>
                <div class="welcome-message">
                    <h5 id="welcome-user"></h5>
                    <p id="current-date"></p>
                </div>
            </header>
            <main class="content-area">
                <div class="progress-timer-card">
                    <div class="image-background-overlay"></div>
                    <img class="image-background" id="counter-image-bg" src="" alt="Background">
                    <div class="timer-settings-icon d-none"><i class="bi bi-gear-fill"></i></div>
                    <div class="progress-rows-container">
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="days-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="days-value">0</span> Ø£ÙŠØ§Ù…</span>
                                <i class="bi bi-calendar-check-fill time-icon"></i>
                            </div>
                        </div>
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="hours-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="hours-value">0</span> Ø³Ø§Ø¹Ø§Øª</span>
                                <i class="bi bi-clock-fill time-icon"></i>
                            </div>
                        </div>
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="minutes-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="minutes-value">0</span> Ø¯Ù‚Ø§Ø¦Ù‚</span>
                                <i class="bi bi-clock-history time-icon"></i>
                            </div>
                        </div>
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="seconds-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="seconds-value">0</span> Ø«ÙˆØ§Ù†ÙŠ</span>
                                <i class="bi bi-hourglass-split time-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                 <div id="inspiration-container" class="mb-3">
                    <button id="inspiration-btn" class="action-button" style="justify-content: center; text-align: center; gap: 10px; font-weight: 700; width: 100%;">
                        <span>ğŸ”¥Ø¹Ù†Ø¯ÙŠ Ø±ØºØ¨Ø© Ø´Ø¯ÙŠØ¯Ø©ØŒØ£Ø¹Ø·Ù†ÙŠ Ø­Ù„Ø§ Ø¬Ø°Ø±ÙŠØ§ğŸ”¥</span>
                    </button>
                    <div id="inspiration-display" class="p-3 mt-2 d-none" style="background-color: var(--card-background); border-radius: 15px; border: 1px solid var(--border-color);">
                        <p id="inspiration-text" class="mb-0"></p>
                    </div>
                </div>

                <!-- START: New Salaf Story Button -->
                <div id="salaf-story-container" class="mb-3">
                    <button id="salaf-story-btn" class="action-button" style="justify-content: center; text-align: center; gap: 10px; font-weight: 700; width: 100%; background: linear-gradient(135deg, #4a90e2, #50e3c2); border: 1px solid #4a90e2;">
                        <span>ğŸ“– Ø¹Ø·Ù†ÙŠ Ø¬Ø±Ø¹Ø© Ø¥ÙŠÙ…Ø§Ù†ÙŠØ© Ù…Ù† Ù‚ØµØµ Ø§Ù„Ø³Ù„Ù</span>
                    </button>
                    <div id="salaf-story-display" class="p-3 mt-2 d-none" style="background-color: var(--card-background); border-radius: 15px; border: 1px solid var(--border-color);">
                        <p id="salaf-story-text" class="mb-0"></p>
                    </div>
                </div>
                <!-- END: New Salaf Story Button -->

                <button id="start-timer-btn" class="btn btn-success btn-lg w-100 mb-3 d-none">Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯</button>
                <button id="najda-button" class="action-button najda-style">
                    <i class="bi bi-fire"></i>
                    <span>Ø§Ù„Ù†Ø¬Ø¯Ø©!</span>
                    <div class="fire-alarm">
                        <div class="fire-alarm-dome"></div>
                        <div class="fire-alarm-base"></div>
                    </div>
                </button>
                <!-- START: Added Button -->
                <button id="commitment-btn" class="action-button commitment-style">
                    <i class="bi bi-file-text-fill"></i>
                    <span>ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø¥Ù„ØªØ²Ø§Ù…</span>
                </button>
                <!-- END: Added Button -->

                <!-- START: New Sleep AI Button -->
                <button id="sleep-ai-btn" class="action-button sleep-style">
                    <i class="bi bi-moon-stars-fill"></i>
                    <span>Ù†ÙˆÙ…Ùƒ Ù…Ø®Ø±Ø¨Ø·ØŸ ØªØ¹Ø§Ù„ Ø£Ø³Ø§Ø¹Ø¯Ùƒ</span>
                </button>
                <!-- END: New Sleep AI Button -->
<!-- START: Mohammed Abdullah Way Button -->
<button class="action-button" data-bs-toggle="modal" data-bs-target="#mohammedAbdullahWayModal" style="background: linear-gradient(135deg, #8E44AD, #3498DB); border-color: #8E44AD; justify-content: center; gap: 10px; font-weight: 700;">
    <i class="bi bi-compass-fill"></i>
    <span>Ø·Ø±ÙŠÙ‚ Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù„ØªØ±Ùƒ Ø§Ù„Ø¥Ø¯Ù…Ø§Ù†</span>
</button>
<!-- END: Mohammed Abdullah Way Button -->
<!-- START: Mohammed Abdullah Way Modal -->
<div class="modal fade" id="mohammedAbdullahWayModal" tabindex="-1" aria-labelledby="mohammedAbdullahWayModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="background-color: var(--background-color); color: var(--text-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" id="mohammedAbdullahWayModalLabel">Ø®Ø·ÙˆØ§Øª Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù„ØªØ±Ùƒ Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1) grayscale(100%) brightness(200%);"></button>
            </div>
            <div class="modal-body">
                <p>Ø¯Ø§ÙŠÙ… ÙŠØ³Ø£Ù„ÙˆÙ†ÙŠ Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ÙƒÙŠÙ ØªØ±ÙƒØª Ø§Ù„Ø§Ø¨Ø§Ø­ÙŠØ©. Ø£ÙˆÙ„Ø§Ù‹ Ø¨ÙØ¶Ù„ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠ Ø«Ù… Ø¨Ø®Ø·ÙˆØ§Øª Ø¨Ø±Ø³Ù„Ù‡Ø§ Ø§Ù„Ø§Ù† Ø¨ØªÙÙŠØ¯Ùƒ Ù„ØªØ¬Ø¹Ù„ Ø§Ù„Ø§Ù‚Ù„Ø§Ø¹ Ø¨Ø·Ø±ÙŠÙ‚Ù‡ Ø³Ù‡Ù„Ù‡.</p>
                <ol style="line-height: 2.2; padding-right: 1.5rem;">
                    <li class="mb-3">Ø§Ø¹Ù„Ù… ÙŠÙ‚ÙŠÙ†Ø§Ù‹ Ø¨Ø¯Ø§Ø®Ù„Ùƒ Ø§Ù†Ùƒ ØªØ³ØªØ·ÙŠØ¹ ØªØ±ÙƒÙ‡Ø§ØŒ Ø£Ù†Øª Ù„Ø³Øª Ù…Ø®ØªÙ„ÙØ§Ù‹ Ø¹Ù† Ø§Ù„Ø§Ø®Ø±ÙŠÙ†.</li>
                    <li class="mb-3">Ù„ÙŠØ³ Ù‡Ù†Ø§Ùƒ Ø§ÙŠ Ø´ÙŠ ØªØ®Ø³Ø±Ù‡ Ø¨Ù„ Ø§Ù„Ø¹ÙƒØ³ Ù‡Ù†Ø§Ùƒ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ù…ÙƒØ§Ø³Ø¨.</li>
                    <li class="mb-3">Ù…Ø§ÙÙŠÙ‡ Ø´ÙŠ Ø§Ø³Ù…Ù‡ "Ø²Ù„Ù‡ ÙˆØ§Ø­Ø¯Ù‡" Ù„Ø§Ù† Ø§Ù„Ø²Ù„Ù‡ Ø¨ØªØ¬Ø± Ø§Ù„Ø§Ù†ØªÙƒØ§Ø³Ù‡.</li>
                    <li class="mb-3">Ù„Ø§ ØªÙ†Ø¸Ø± Ù„Ù„Ø§Ø¨Ø§Ø­ÙŠÙ‡ Ø§Ù†Ù‡Ø§ Ø¹Ø§Ø¯Ù‡ Ø¹Ø§Ø¯ÙŠÙ‡ØŒ Ø§Ù†Ø¸Ø± Ù„Ù‡Ø§ Ø§Ù†Ù‡Ø§ Ù…Ø§Ø¯Ù‡ Ø§Ø¯Ù…Ø§Ù†ÙŠÙ‡ ØªØ¬Ù„Ø¨ Ø§Ù„Ø¯Ù…Ø§Ø±.</li>
                    <li class="mb-3">Ù„Ø§ ØªØ¬Ø¹Ù„ Ù…Ø­Ø§ÙˆÙ„ØªÙƒ Ù…Ø´ÙƒÙˆÙƒÙ‡ØŒ Ø®Ù„Ùƒ Ø¹Ù†Ø¯Ùƒ ÙŠÙ‚ÙŠÙ† Ø§Ù†Ù‡Ø§ Ù…Ø­Ø§ÙˆÙ„ØªÙƒ Ø§Ù„Ø§Ø®ÙŠØ±Ù‡ ÙˆØ§Ù†Ùƒ Ø³ØªÙ†Ø¬Ø­ ÙÙŠÙ‡Ø§ ğŸ¤.</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<!-- END: Mohammed Abdullah Way Modal -->

            </main>
            <nav class="bottom-nav">
                <a href="main.html" class="nav-item active"><i class="bi bi-house-door-fill"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
                <a href="diaries.html" class="nav-item"><i class="bi bi-book-fill"></i><span>Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª</span></a>
                <a href="articles.html" class="nav-item"><i class="bi bi-check2-square"></i><span>Ø§Ù„Ø¹Ø§Ø¯Ø§Øª</span></a>
                <a href="chat.html" class="nav-item special-item">
                    <div class="icon-background"><i class="bi bi-chat-dots-fill"></i></div>
                    <span>Ø¯Ø±Ø¯Ø´Ø©</span>
                    <span class="chat-notification-badge"></span>
                </a>
                <a href="follow-up.html" class="nav-item"><i class="bi bi-signpost-split-fill"></i><span>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</span></a>
                <a href="library.html" class="nav-item"><i class="bi bi-collection-fill"></i><span>Ø§Ù„Ù…ÙƒØªØ¨Ø©</span></a>
                <a href="settings.html" class="nav-item"><i class="bi bi-gear-fill"></i><span>Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª</span></a>
            </nav>
        </div>
    </div>
    
    <div id="breathing-page" class="page" style="background: linear-gradient(to top, #28b485, #7ed56f); justify-content: center; align-items: center; text-align: center; color: white; padding: 1rem;">
        <i class="bi bi-x-lg" id="close-breathing-btn" style="position: absolute; top: 20px; right: 20px; font-size: 1.8rem; cursor: pointer; z-index: 10;"></i>
        <div id="breathing-circle-container"><div id="breathing-circle"></div></div>
        <h1 id="breathing-text" style="font-size: 4rem; margin-top: 2rem; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">Ø´Ù‡ÙŠÙ‚</h1>
        <div id="breathing-timer" style="font-size: 1.5rem; color: white; margin-top: 1rem; font-weight: bold;"></div>
        <button id="skip-to-quote-btn" class="btn btn-outline-light mt-4">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ <i class="bi bi-arrow-left-short"></i></button>
        <p style="font-size: 1.1rem; max-width: 300px; margin-top: 1.5rem;">Ø®Ø° Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† ÙˆÙ‚ØªÙƒ Ù„Ù„ØªÙ†ÙØ³ Ø­ÙŠØ« ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ ØªÙ‡Ø¯Ø¦Ø© Ø¹Ù‚Ù„Ùƒ</p>
    </div>

    <div id="quote-page" class="page">
        <div class="top-indicator-bar"></div>
        <i class="bi bi-x-lg" id="close-quote-btn"></i>
        <div class="quote-box">
            <p id="quote-text"></p>
        </div>
    </div>

    <!-- START: Commitment Document Page -->
    <div id="commitment-document-page" class="page">
        <button id="back-to-home-btn" style="position: fixed; top: 20px; left: 20px; z-index: 1000; background: rgba(0,0,0,0.2); border: none; color: #333; border-radius: 50%; width: 44px; height: 44px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;">
            <i class="bi bi-arrow-right-circle-fill"></i>
        </button>
        
        <!-- Page 1: Create Form -->
        <div id="form-page">
            <div class="min-h-screen py-8">
                <div class="container mx-auto p-4 md:p-8 max-w-4xl">
                    <header class="text-center mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold main-title mb-2">ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø¥Ù„ØªØ²Ø§Ù…</h1>
                        <p class="text-lg text-gray-600">Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ØŒ Ø³ØªØ³Ø§Ø¹Ø¯Ùƒ ÙƒØ«ÙŠØ±Ø§Ù‹ Ø¹Ù„Ù‰ ØªØ°ÙƒÙŠØ± ÙˆØªØ­ÙÙŠØ² Ù†ÙØ³Ùƒ Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±!</p>
                    </header>
                    
                    <form id="commitment-form">
                        <div class="form-card"><label for="damages" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>Ù…Ø§ Ù‡ÙŠ Ø£Ø¶Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ù…Ø§Ù† Ø§Ù„ØªÙŠ Ø£ØµØ§Ø¨ØªÙƒØŸ</label><p class="text-gray-500 mb-4">Ø§ÙƒØªØ¨ Ø£Ø¶Ø±Ø§Ø± Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø£Ø«Ø±Øª Ø¨Ùƒ ÙˆØ¬Ø¹Ù„ØªÙƒ ØªÙÙƒØ± Ø¬Ø¯ÙŠØ§ Ø¨Ø§Ù„ØªØ¹Ø§ÙÙŠØŒ Ø£Ø¶Ø±Ø§Ø± Ø¹Ù„Ù‰ ØµØ­ØªÙƒ Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© ÙˆØ§Ù„Ù†ÙØ³ÙŠØ© ÙˆØ§Ù„Ø¨Ø¯Ù†ÙŠØ© ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ÙˆØ§Ù„Ø¹Ù‚Ù„ÙŠØ©.</p><textarea id="damages" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="fears" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"></path></svg>Ù…Ø§Ù‡ÙŠ Ù…Ø®Ø§ÙˆÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† ØªØ±Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¯Ø©ØŸ</label><p class="text-gray-500 mb-4">Ø§ÙƒØªØ¨ Ù…Ø®Ø§ÙˆÙÙƒ Ø§Ù„ØªÙŠ ØªÙˆÙ‡Ù…Ùƒ Ø¨Ø£Ù†Ùƒ ØªØ­ØªØ§Ø¬ Ù„ØªÙ„Ùƒ Ø§Ù„Ø¹Ø§Ø¯Ø© Ù…Ø«Ù„ Ø£Ù†Ù‡ Ù„Ø§ Ø­Ù„ Ø¥Ù„Ø§ Ø¨Ø§Ù„Ø²ÙˆØ§Ø¬ Ø£Ùˆ Ø£Ù† ØªØ±ÙƒÙ‡Ø§ ÙŠØ³Ø¨Ø¨ Ø®Ù„Ù„ Ø¬Ù†Ø³ÙŠ Ø£Ùˆ Ø£Ù† Ø§Ù„ØªØ¹Ø§ÙÙŠ Ù…Ø³ØªØ­ÙŠÙ„.</p><textarea id="fears" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="responses" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.311a7.5 7.5 0 0 1-7.5 0c-1.421-.492-2.682-.998-3.624-1.516a6.002 6.002 0 0 1-1.49-1.84c-.31-1.024-.23-2.111.22-3.084.45-.972 1.165-1.823 2.06-2.502a12.022 12.022 0 0 1 1.732-1.041"></path></svg>Ø¨Ù…Ø§Ø°Ø§ ØªØ±Ø¯ Ø¹Ù„Ù‰ Ù…Ø®Ø§ÙˆÙÙƒ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø·Ù‚ÙŠØŸ</label><p class="text-gray-500 mb-4">Ø§ÙƒØªØ¨ Ù…Ø§ ØªØ¹Ø±ÙÙ‡ Ù…Ù† Ø±Ø¯ÙˆØ¯ Ù…Ù†Ø·Ù‚ÙŠØ© Ù„ØªØ°ÙƒØ± Ø¨Ù‡Ø§ Ù†ÙØ³Ùƒ Ø¹Ù†Ø¯Ù…Ø§ ØªÙ†Ø³Ù‰ Ø£Ùˆ ØªØ¶Ø¹Ù.</p><textarea id="responses" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="benefits" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-6.75c-.621 0-1.125.504-1.125 1.125v3.375m9 0h-9"></path></svg>Ù…Ø§Ù‡ÙŠ ÙÙˆØ§Ø¦Ø¯ Ø§Ù„ØªØ¹Ø§ÙÙŠ Ø§Ù„ØªÙŠ ØªØ·Ù…Ø­ Ù„Ø§ÙƒØªØ³Ø§Ø¨Ù‡Ø§ØŸ</label><p class="text-gray-500 mb-4">Ø§ÙƒØªØ¨ ÙÙˆØ§Ø¦Ø¯ Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆÙˆØ§Ù‚Ø¹ÙŠØ© ÙŠÙ…ÙƒÙ† Ø§ÙƒØªØ³Ø§Ø¨Ù‡Ø§ ØªØ¯Ø±ÙŠØ¬ÙŠØ§ Ø¨Ø§Ù„ØªØ¹Ø§ÙÙŠ.</p><textarea id="benefits" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="escape-plan" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"></path></svg>Ù…Ø§Ù‡ÙŠ Ø®Ø·Ø© Ù‡Ø±ÙˆØ¨Ùƒ Ø¹Ù†Ø¯ Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø±ØºØ¨Ø© Ø§Ù„Ù…Ù„Ø­Ø©ØŸ</label><p class="text-gray-500 mb-4">Ø¶Ø¹ Ø¹Ø§Ø¯Ø§Øª Ø³Ø±ÙŠØ¹Ø© ÙˆÙ‚ØµÙŠØ±Ø©ØŒ Ù…Ø«Ù„ ØªØ¬Ù†Ø¨ Ø§Ù„Ù‡Ø§ØªÙØŒ ÙˆÙ…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŒ ØªÙ…Ø§Ø±ÙŠÙ† Ø±ÙŠØ§Ø¶ÙŠØ©ØŒ Ø§Ø³ØªØ­Ù…Ø§Ù…ØŒ ÙˆØºÙŠØ±Ù‡Ø§ Ù…Ù† Ø¹Ø§Ø¯Ø§Øª ØªØ´ØºÙ„Ùƒ Ø¹Ù† Ø§Ù„ØªÙÙƒÙŠØ± Ø¨Ø§Ù„Ø²Ù„Ù„.</p><textarea id="escape-plan" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="message" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75"></path></svg>Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ùƒ Ù„Ù†ÙØ³Ùƒ.</label><p class="text-gray-500 mb-4">ØªÙ…Ù‡Ù„ Ù‚Ù„ÙŠÙ„Ø§ ÙˆØªÙÙƒØ±.. Ø§Ø¬Ø¹Ù„Ù‡Ø§ Ù…Ø¤Ø«Ø±Ø© ØªÙ„Ø§Ù…Ø³ Ø¹Ù‚Ù„Ùƒ ÙˆÙ‚Ù„Ø¨Ùƒ ÙˆØ±ÙˆØ­Ùƒ..</p><textarea id="message" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <button type="submit" class="w-full btn-save text-white font-bold py-4 px-4 rounded-lg text-xl">Ø­ÙØ¸</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Page 2: View Document -->
        <div id="document-page" class="hidden">
            <div class="min-h-screen flex flex-col justify-center items-center py-8 px-4">
                 <div class="document-container">
                    <div id="document-content" class="text-justify">
                        <p class="text-center text-2xl font-bold mb-6">Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</p>
                        <p class="mb-5">Ø¨Ø¥Ø¯Ø±Ø§ÙƒÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ‚ Ù„Ù…Ø¹Ø§Ù†Ø§Ø© Ø­ÙŠØ§ØªÙŠ ØªØ­Øª ÙˆØ·Ø£Ø© Ø§Ù„Ø¥Ø¯Ù…Ø§Ù† ÙˆØ¢Ø«Ø§Ø±Ù‡ Ø§Ù„Ø³Ù„Ø¨ÙŠØ© Ø¹Ù„Ù‰ ØµØ­ØªÙŠ ÙˆØ¹Ù„Ø§Ù‚Ø§ØªÙŠ ÙˆÙ…Ø³ØªÙ‚Ø¨Ù„ÙŠØŒ Ø£Ù‚Ø± ÙˆØ£Ù„ØªØ²Ù… Ø£Ù…Ø§Ù… Ø§Ù„Ù„Ù‡ Ø«Ù… Ù†ÙØ³ÙŠ Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„ØªØ¹Ø§ÙÙŠ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø­ÙŠØ§Ø© Ù…Ù„ÙŠØ¦Ø© Ø¨Ø§Ù„Ø£Ù…Ù„ ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø².</p>
                        <p class="mb-5">Ø£Ù‚Ø± Ø¨Ø£Ù† Ø§Ù„Ø¥Ø¯Ù…Ø§Ù† Ù‚Ø¯ ØªØ±Ùƒ Ø£Ø«Ø±Ø§Ù‹ Ø¨Ø§Ù„ØºØ§Ù‹ ÙÙŠ Ø­ÙŠØ§ØªÙŠ Ø¨ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø£Ø¶Ø±Ø§Ø± Ø£Ø¨Ø±Ø²Ù‡Ø§: <strong id="damages-output" class="font-semibold"></strong></p>
                        <p class="mb-5">Ø£Ø¹Ù„Ù… Ø£Ù† Ù‚Ø±Ø§Ø± Ø§Ù„ØªØºÙŠÙŠØ± Ù„ÙŠØ³ Ø³Ù‡Ù„Ø§ Ù„ÙƒÙ† Ø³Ø£ØªØ­Ù…Ù„ Ø§Ù„ØµØ¹Ø§Ø¨ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡ Ù„Ø£Ù†ÙŠ Ø£Ø±ÙŠØ¯ Ø£Ù† Ø£ØµØ¨Ø­ Ø¥Ù†Ø³Ø§Ù†Ø§ Ø¬Ø¯ÙŠØ¯Ø§ Ù…Ù…Ø§ ÙŠØ³ØªÙ„Ø²Ù… Ø£Ù† Ø£Ø·Ø±Ø­ Ø¨ÙƒÙ„ Ø´ÙØ§ÙÙŠØ© Ù…Ø®Ø§ÙˆÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† ØªØ±Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¯Ù…Ø±Ø© ÙˆÙ‡Ø°Ù‡ Ø§Ù„Ù…Ø®Ø§ÙˆÙ ØªØªÙ…Ø«Ù„ Ø¨Ù€: <strong id="fears-output" class="font-semibold"></strong></p>
                        <p class="mb-5">ÙˆÙ„ÙƒÙ† Ø¬Ù…ÙŠØ¹ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø®Ø§ÙˆÙ Ø£ÙˆÙ‡Ø§Ù… ÙƒØ§Ø°Ø¨Ø© ÙˆØ­Ø¨Ø§Ù„ ÙŠØªÙˆØ¬Ø¨ Ø¹Ù„ÙŠ Ù‚Ø·Ø¹Ù‡Ø§ Ù„Ø£Ø²ÙŠØ­ ØµØ®Ø±Ø© Ø§Ù„Ø¥Ø¯Ù…Ø§Ù† Ù…Ù† Ø­ÙŠØ§ØªÙŠ Ùˆ Ø³Ø£Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ù†Ø·Ù‚ÙŠØ§ Ø¨Ø§Ù„ØªØ§Ù„ÙŠ: <strong id="responses-output" class="font-semibold"></strong></p>
                        <p class="mb-5">Ø¥Ù† Ø§Ù„ØªØ¹Ø§ÙÙŠ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„ÙŠ Ù‡Ùˆ Ø±Ø­Ù„Ø© Ù†Ø­Ùˆ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø°Ø§Øª ÙˆØ§Ù„Ø¹ÙŠØ´ Ø¨ÙƒØ±Ø§Ù…Ø© ÙˆÙ…Ø³Ø¤ÙˆÙ„ÙŠØ©ØŒ ÙˆØ£Ø·Ù…Ø­ Ù…Ù† Ø®Ù„Ø§Ù„Ù‡ Ø¥Ù„Ù‰ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„ÙÙˆØ§Ø¦Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ©: <strong id="benefits-output" class="font-semibold"></strong></p>
                        <p class="mb-5">ÙˆÙÙŠ Ø³Ø¨ÙŠÙ„ ÙƒÙ„ Ù…Ø§ Ø³Ø¨Ù‚ ÙˆÙ„Ø£Ù†ÙŠ Ø¹Ù„Ù…Øª ÙŠÙ‚ÙŠÙ†Ø§ Ø¨Ø£Ù† Ø§Ù„Ø¯Ù…Ø§Øº ÙŠÙƒÙˆÙ† Ø¨Ø­Ø§Ù„Ø© Ø³ÙƒØ± ÙˆØ¶Ø¹Ù Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¹Ù†Ø¯ Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø±ØºØ¨Ø© Ø§Ù„Ù…Ù„Ø­Ø© ÙˆØ£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙˆÙ„Ø£Ù† Ø§Ù„ØªØ¹Ø§ÙÙŠ ÙŠØ³ØªØ­Ù‚ ÙØ¥Ù†Ù†ÙŠ Ø³Ø£Ù„ØªØ²Ù… Ø¨Ø®Ø·Ø© Ø§Ù„Ù‡Ø±ÙˆØ¨ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø£ÙŠØ© Ø¨ÙˆØ§Ø¯Ø± Ø¥Ø¯Ù…Ø§Ù†ÙŠØ© Ø­ÙŠØ« Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ§Ù„ÙŠ: <strong id="escape-plan-output" class="font-semibold"></strong></p>
                        <p class="mb-5">ÙˆØ®ØªØ§Ù…Ø§Ù‹ ÙÙ‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù†ÙØ³ÙŠ Ø§Ù„ØªÙˆØ§Ù‚Ø© Ù„Ù„ØµÙ„Ø§Ø­ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¥Ù„Ù‰ ØªÙ„Ùƒ Ø§Ù„Ù†ÙØ³ Ø§Ù„Ø·ÙŠØ¨Ø© Ø§Ù„ØªØ§Ø¦Ø¨Ø© Ù„Ù…ÙˆÙ„Ø§Ù‡Ø§ Ø¬Ù„ ÙˆØ¹Ù„Ø§: <strong id="message-output" class="font-semibold"></strong></p>
                        <div class="mt-12 text-left"><p class="font-bold">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: <span id="user-signature"></span></p><p class="font-bold">Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="current-date-doc"></span></p></div>
                    </div>
                </div>
                <div class="flex justify-center items-center space-x-4 space-x-reverse py-8">
                    <button id="edit-btn" class="flex items-center justify-center btn-edit text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg><span>ØªØ¹Ø¯ÙŠÙ„</span></button>
                    <button id="delete-btn" class="flex items-center justify-center btn-delete text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span>Ø­Ø°Ù</span></button>
                </div>
            </div>
        </div>

        <!-- Page 3: Edit Form -->
        <div id="edit-page" class="hidden">
            <div class="min-h-screen py-8">
                <div class="container mx-auto p-4 md:p-8 max-w-4xl">
                     <header class="text-center mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold edit-title mb-2">ØªØ¹Ø¯ÙŠÙ„ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø¥Ù„ØªØ²Ø§Ù…</h1>
                        <p class="text-lg text-gray-600">Ù‚Ù… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ²Ø§Ù…Ø§ØªÙƒ ÙˆØ£Ù‡Ø¯Ø§ÙÙƒ.</p>
                    </header>
                    <form id="commitment-form-edit">
                        <div class="form-card"><label for="edit-damages" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>Ù…Ø§ Ù‡ÙŠ Ø£Ø¶Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ù…Ø§Ù† Ø§Ù„ØªÙŠ Ø£ØµØ§Ø¨ØªÙƒØŸ</label><p class="text-gray-500 mb-4">Ø§ÙƒØªØ¨ Ø£Ø¶Ø±Ø§Ø± Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø£Ø«Ø±Øª Ø¨Ùƒ ÙˆØ¬Ø¹Ù„ØªÙƒ ØªÙÙƒØ± Ø¬Ø¯ÙŠØ§ Ø¨Ø§Ù„ØªØ¹Ø§ÙÙŠØŒ Ø£Ø¶Ø±Ø§Ø± Ø¹Ù„Ù‰ ØµØ­ØªÙƒ Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© ÙˆØ§Ù„Ù†ÙØ³ÙŠØ© ÙˆØ§Ù„Ø¨Ø¯Ù†ÙŠØ© ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ÙˆØ§Ù„Ø¹Ù‚Ù„ÙŠØ©.</p><textarea id="edit-damages" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-fears" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"></path></svg>Ù…Ø§Ù‡ÙŠ Ù…Ø®Ø§ÙˆÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† ØªØ±Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¯Ø©ØŸ</label><p class="text-gray-500 mb-4">Ø§ÙƒØªØ¨ Ù…Ø®Ø§ÙˆÙÙƒ Ø§Ù„ØªÙŠ ØªÙˆÙ‡Ù…Ùƒ Ø¨Ø£Ù†Ùƒ ØªØ­ØªØ§Ø¬ Ù„ØªÙ„Ùƒ Ø§Ù„Ø¹Ø§Ø¯Ø© Ù…Ø«Ù„ Ø£Ù†Ù‡ Ù„Ø§ Ø­Ù„ Ø¥Ù„Ø§ Ø¨Ø§Ù„Ø²ÙˆØ§Ø¬ Ø£Ùˆ Ø£Ù† ØªØ±ÙƒÙ‡Ø§ ÙŠØ³Ø¨Ø¨ Ø®Ù„Ù„ Ø¬Ù†Ø³ÙŠ Ø£Ùˆ Ø£Ù† Ø§Ù„ØªØ¹Ø§ÙÙŠ Ù…Ø³ØªØ­ÙŠÙ„.</p><textarea id="edit-fears" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-responses" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.311a7.5 7.5 0 0 1-7.5 0c-1.421-.492-2.682-.998-3.624-1.516a6.002 6.002 0 0 1-1.49-1.84c-.31-1.024-.23-2.111.22-3.084.45-.972 1.165-1.823 2.06-2.502a12.022 12.022 0 0 1 1.732-1.041"></path></svg>Ø¨Ù…Ø§Ø°Ø§ ØªØ±Ø¯ Ø¹Ù„Ù‰ Ù…Ø®Ø§ÙˆÙÙƒ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø·Ù‚ÙŠØŸ</label><p class="text-gray-500 mb-4">Ø§ÙƒØªØ¨ Ù…Ø§ ØªØ¹Ø±ÙÙ‡ Ù…Ù† Ø±Ø¯ÙˆØ¯ Ù…Ù†Ø·Ù‚ÙŠØ© Ù„ØªØ°ÙƒØ± Ø¨Ù‡Ø§ Ù†ÙØ³Ùƒ Ø¹Ù†Ø¯Ù…Ø§ ØªÙ†Ø³Ù‰ Ø£Ùˆ ØªØ¶Ø¹Ù.</p><textarea id="edit-responses" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-benefits" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-6.75c-.621 0-1.125.504-1.125 1.125v3.375m9 0h-9"></path></svg>Ù…Ø§Ù‡ÙŠ ÙÙˆØ§Ø¦Ø¯ Ø§Ù„ØªØ¹Ø§ÙÙŠ Ø§Ù„ØªÙŠ ØªØ·Ù…Ø­ Ù„Ø§ÙƒØªØ³Ø§Ø¨Ù‡Ø§ØŸ</label><p class="text-gray-500 mb-4">Ø§ÙƒØªØ¨ ÙÙˆØ§Ø¦Ø¯ Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆÙˆØ§Ù‚Ø¹ÙŠØ© ÙŠÙ…ÙƒÙ† Ø§ÙƒØªØ³Ø§Ø¨Ù‡Ø§ ØªØ¯Ø±ÙŠØ¬ÙŠØ§ Ø¨Ø§Ù„ØªØ¹Ø§ÙÙŠ.</p><textarea id="edit-benefits" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-escape-plan" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"></path></svg>Ù…Ø§Ù‡ÙŠ Ø®Ø·Ø© Ù‡Ø±ÙˆØ¨Ùƒ Ø¹Ù†Ø¯ Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø±ØºØ¨Ø© Ø§Ù„Ù…Ù„Ø­Ø©ØŸ</label><p class="text-gray-500 mb-4">Ø¶Ø¹ Ø¹Ø§Ø¯Ø§Øª Ø³Ø±ÙŠØ¹Ø© ÙˆÙ‚ØµÙŠØ±Ø©ØŒ Ù…Ø«Ù„ ØªØ¬Ù†Ø¨ Ø§Ù„Ù‡Ø§ØªÙØŒ ÙˆÙ…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŒ ØªÙ…Ø§Ø±ÙŠÙ† Ø±ÙŠØ§Ø¶ÙŠØ©ØŒ Ø§Ø³ØªØ­Ù…Ø§Ù…ØŒ ÙˆØºÙŠØ±Ù‡Ø§ Ù…Ù† Ø¹Ø§Ø¯Ø§Øª ØªØ´ØºÙ„Ùƒ Ø¹Ù† Ø§Ù„ØªÙÙƒÙŠØ± Ø¨Ø§Ù„Ø²Ù„Ù„.</p><textarea id="edit-escape-plan" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-message" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75"></path></svg>Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ùƒ Ù„Ù†ÙØ³Ùƒ.</label><p class="text-gray-500 mb-4">ØªÙ…Ù‡Ù„ Ù‚Ù„ÙŠÙ„Ø§ ÙˆØªÙÙƒØ±.. Ø§Ø¬Ø¹Ù„Ù‡Ø§ Ù…Ø¤Ø«Ø±Ø© ØªÙ„Ø§Ù…Ø³ Ø¹Ù‚Ù„Ùƒ ÙˆÙ‚Ù„Ø¨Ùƒ ÙˆØ±ÙˆØ­Ùƒ..</p><textarea id="edit-message" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        
                        <button type="submit" class="w-full btn-update text-white font-bold py-4 px-4 rounded-lg text-xl">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Commitment Document Page -->

    <!-- START: Sleep Improvement Page -->
    <div id="sleep-improvement-page" class="page">
        <header class="sleep-header">
            <i class="bi bi-arrow-right" id="back-to-home-from-sleep-btn"></i>
            <h5>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù†ÙˆÙ… Ø§Ù„Ø°ÙƒÙŠ</h5>
            <div style="width: 24px;"></div> <!-- Spacer -->
        </header>
        <main class="sleep-content-area">
            <!-- Section for daily sleep logging -->
            <div id="sleep-log-section" class="sleep-card">
                <h2 class="sleep-card-title">ØªØ³Ø¬ÙŠÙ„ Ù†ÙˆÙ… Ø§Ù„Ù„ÙŠÙ„Ø©</h2>
                <div class="time-input-group">
                    <div class="time-input-container">
                        <label for="sleep-time-input">Ù…ØªÙ‰ Ù†Ù…Øª ØªÙ‚Ø±ÙŠØ¨Ø§</label>
                        <input type="time" id="sleep-time-input">
                    </div>
                    <div class="time-input-container">
                        <label for="wake-time-input">ÙˆÙ…ØªÙ‰ ØµØ­ÙŠØª</label>
                        <input type="time" id="wake-time-input">
                    </div>
                </div>
                <p class="text-secondary small text-center mb-3">Ù…Ù„Ø§Ø­Ø¸Ø©: AM ÙŠØ¹Ù†ÙŠ ØµØ¨Ø§Ø­Ø§ (Ù…Ù† 12:00 Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ Ø¥Ù„Ù‰ 11:59 ØµØ¨Ø§Ø­Ø§)ØŒ Ùˆ PM ÙŠØ¹Ù†ÙŠ Ù…Ø³Ø§Ø¡ (Ù…Ù† 12:00 Ø¸Ù‡Ø±Ø§Ù‹ Ø¥Ù„Ù‰ 11:59 Ù…Ø³Ø§Ø¡).</p>
                <div id="sleep-duration-display" class="hidden-section"></div>
                <div class="d-flex gap-2">
                    <button id="cancel-sleep-time-btn" class="user-option-btn" style="background-color: var(--danger-color); flex-basis: 30%;">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="submit-sleep-time-btn" class="user-option-btn" style="flex-grow: 1;">ØªØ³Ø¬ÙŠÙ„ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø©</button>
                </div>
            </div>

            <!-- Section for the dynamic daily question -->
            <div id="daily-question-section" class="sleep-card hidden-section">
                <h2 class="sleep-card-title" id="daily-question-text"></h2>
                <div class="daily-question-options" id="daily-question-options-container">
                    <!-- Options will be injected here -->
                </div>
            </div>

            <!-- Section for analysis and chart -->
            <div id="sleep-analysis-section" class="hidden-section">
                <div class="sleep-card">
                    <h2 class="sleep-card-title">Ù…Ù„Ø®Øµ Ù†ÙˆÙ…Ùƒ Ø¢Ø®Ø± Ø§Ø³Ø¨ÙˆØ¹</h2>
                    <div id="sleep-chart-container">
                        <canvas id="sleepChart"></canvas>
                    </div>
                </div>
                <div class="sleep-card">
                    <h2 class="sleep-card-title">ØªØ­Ù„ÙŠÙ„ Ù†ÙˆÙ…Ùƒ Ø§Ù„Ø§Ø³Ø¨ÙˆØ¹ÙŠ</h2>
                    <div id="weekly-analysis-container">
                        <!-- AI weekly analysis will be injected here -->
                    </div>
                     <p class="last-updated-text" id="analysis-last-updated"></p>
                </div>
            </div>
        </main>
    </div>
    <!-- END: Sleep Improvement Page -->

    <div class="modal-overlay" id="settings-modal-overlay">
        <div class="modal-content-custom" id="settings-modal-content">
            <header class="modal-header-custom"><h5>Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯</h5><i class="bi bi-x-lg" id="close-settings-button"></i></header>
            <div class="modal-body-custom">
                <button class="action-button" id="reset-timer-button"><span>ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯</span><div class="icon-container yellow"><i class="bi bi-arrow-counterclockwise"></i></div></button>
                <button class="action-button" id="set-date-button"><span>ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯</span><div class="icon-container blue"><i class="bi bi-calendar-plus-fill"></i></div></button>
                <div id="developer-background-options" class="d-none">
                    <button class="action-button" id="set-image-button">
                        <span>ØªØ¹ÙŠÙŠÙ† ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ©</span>
                        <div class="icon-container green"><i class="bi bi-image"></i></div>
                    </button>
                    <button class="action-button" id="remove-background-button">
                        <span>Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</span>
                        <div class="icon-container red"><i class="bi bi-trash-fill"></i></div>
                    </button>
                </div>
                <input type="datetime-local" id="date-time-picker" style="opacity: 0; position: absolute; left: -9999px; width: 1px; height: 1px;">
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="confirm-reset-modal">
        <div class="modal-content-custom">
            <div class="confirm-modal-body"><div class="confirm-icon"><i class="bi bi-arrow-counterclockwise"></i></div><p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ³Ù…Ø© Ø§Ù„ØªÙŠ Ø­ØµÙ„Øª Ø¹Ù„ÙŠÙ‡Ø§.</p></div>
            <div class="confirm-modal-footer"><button class="confirm-btn confirm-btn-cancel" id="cancel-reset-button">Ø±Ø¬ÙˆØ¹</button><button class="confirm-btn confirm-btn-accept" id="confirm-reset-action-button">ØªØµÙÙŠØ±</button></div>
        </div>
    </div>

    <div class="modal fade" id="notifications-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notifications-list"></div>
                <div class="modal-footer">
                    <button id="open-send-modal-btn" type="button" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#send-notification-modal">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="send-notification-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="notification-title" class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" class="form-control" id="notification-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±">
                    </div>
                    <div class="mb-3">
                        <label for="notification-message" class="form-label">Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                        <textarea class="form-control" id="notification-message" rows="4" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-close" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="send-notification-btn">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- START: Achievements Modals -->
    <div class="modal fade" id="achievementsModal" tabindex="-1" aria-labelledby="achievementsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="achievementsModalLabel">Ø³Ø¬Ù„ Ø§Ù„Ø£ÙˆØ³Ù…Ø©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="achievements-grid">
                        <!-- Achievement cards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="congratsAchievementModal" tabindex="-1" aria-labelledby="congratsAchievementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body" id="congrats-modal-body">
                    <div id="congrats-icon"><i class="bi bi-trophy-fill"></i></div>
                    <h5 id="congrats-user-text" class="mb-1"></h5>
                    <p id="congrats-text" class="text-secondary"></p>
                    <button type="button" class="btn btn-primary mt-3" data-bs-dismiss="modal">Ø±Ø§Ø¦Ø¹!</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Achievements Modals -->

    <!-- START: Leaderboard Modal -->
    <div class="modal fade" id="leaderboardModal" tabindex="-1" aria-labelledby="leaderboardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header flex-column align-items-stretch p-2">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <h5 class="modal-title" id="leaderboardModalLabel">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h5>
                        <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div id="leaderboard-tabs-container" class="d-none w-100 mt-2">
                        <ul class="nav nav-tabs" id="leaderboardTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="leaderboard-list-tab" data-bs-toggle="tab" data-bs-target="#leaderboard-list-pane" type="button" role="tab" aria-controls="leaderboard-list-pane" aria-selected="true">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="banned-list-tab" data-bs-toggle="tab" data-bs-target="#banned-list-pane" type="button" role="tab" aria-controls="banned-list-pane" aria-selected="false">Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†</button>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-body p-0" id="leaderboard-body-container">
                     <div class="tab-content" id="leaderboardTabContent">
                        <div class="tab-pane fade show active p-3" id="leaderboard-list-pane" role="tabpanel" tabindex="0">
                            <!-- Leaderboard content will be injected here -->
                        </div>
                        <div class="tab-pane fade p-3" id="banned-list-pane" role="tabpanel" tabindex="0">
                            <!-- Banned users list will be injected here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center p-0" id="leaderboard-footer-user-rank">
                    <!-- User's rank will be injected here -->
                </div>
            </div>
        </div>
    </div>
    <!-- END: Leaderboard Modal -->

    <!-- START: User Achievements Modal -->
    <div class="modal fade" id="userAchievementsModal" tabindex="-1" aria-labelledby="userAchievementsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userAchievementsModalLabel">Ø£ÙˆØ³Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="user-achievements-grid">
                        <!-- User achievements will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END: User Achievements Modal -->


    <input type="file" accept="image/*" id="image-file-picker" style="display: none;">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // --- START: Added Spinner Functions ---
        function showSpinner() {
            const spinner = document.getElementById('loading-spinner-overlay');
            if (spinner) {
                spinner.classList.add('show');
            }
        }

        function hideSpinner() {
            const spinner = document.getElementById('loading-spinner-overlay');
            if (spinner) {
                spinner.classList.remove('show');
            }
        }
        // --- END: Added Spinner Functions ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, getDocs, arrayUnion, updateDoc, deleteDoc, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGgZmhJ_mMezlf7xElisvzJ8l9D758d4g",
            authDomain: "my-chat-app-daaf8.firebaseapp.com",
            projectId: "my-chat-app-daaf8",
            storageBucket: "my-chat-app-daaf8.firebasestorage.app",
            messagingSenderId: "789086064752",
            appId: "1:789086064752:web:d081f1b6832dabca1d64b5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // START: Achievements Logic
        const milestones = [
            { days: 1, name: "ÙˆØ³Ø§Ù… Ø´Ø±Ø§Ø±Ø© Ø§Ù„ØªØºÙŠÙŠØ±", icon: "bi-lightbulb-fill" },
            { days: 3, name: "ÙˆØ³Ø§Ù… Ø¨Ø°Ø±Ø© Ø§Ù„ØµÙ…ÙˆØ¯", icon: "bi-tree-fill" },
            { days: 7, name: "ÙˆØ³Ø§Ù… Ø¹Ø¨ÙˆØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", icon: "bi-calendar-check-fill" },
            { days: 14, name: "ÙˆØ³Ø§Ù… Ø­ØµÙ† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†", icon: "bi-shield-shaded" },
            { days: 21, name: "ÙˆØ³Ø§Ù… ØªØ±Ø³ÙŠØ® Ø§Ù„Ø¹Ø§Ø¯Ø©", icon: "bi-pin-map-fill" },
            { days: 30, name: "ÙˆØ³Ø§Ù… Ù†Ø¬Ù…Ø© Ø§Ù„Ø´Ù‡Ø±", icon: "bi-star-fill" },
            { days: 40, name: "ÙˆØ³Ø§Ù… Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ† Ø§Ù„Ø­Ø§Ø³Ù…Ø©", icon: "bi-clipboard2-check-fill" },
            { days: 45, name: "ÙˆØ³Ø§Ù… Ù…Ø­Ø§Ø±Ø¨ Ø§Ù„Ù€ 45", icon: "bi-shield-plus" },
            { days: 60, name: "ÙˆØ³Ø§Ù… Ù‚Ù…Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠÙ†", icon: "bi-moon-stars-fill" },
            { days: 90, name: "ÙˆØ³Ø§Ù… Ø¬ÙˆÙ‡Ø±Ø© Ø§Ù„ÙØµÙ„", icon: "bi-gem" },
            { days: 100, name: "ÙˆØ³Ø§Ù… Ø¨Ø·Ù„ Ø§Ù„Ù…Ø¦Ø©", icon: "bi-1-circle-fill" },
            { days: 120, name: "ÙˆØ³Ø§Ù… Ø±Ø¨Ø§Ù† Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±", icon: "bi-compass-fill" },
            { days: 150, name: "ÙˆØ³Ø§Ù… ÙØ§Ø±Ø³ Ø§Ù„Ø®Ù…Ø³Ø© Ø£Ø´Ù‡Ø±", icon: "bi-flag-fill" },
            { days: 180, name: "ÙˆØ³Ø§Ù… Ø´Ù…Ø³ Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø§Ù…", icon: "bi-sun-fill" },
            { days: 250, name: "ÙˆØ³Ø§Ù… ØµØ®Ø±Ø© Ø§Ù„ØµØ¨Ø±", icon: "bi-bricks" },
            { days: 300, name: "ÙˆØ³Ø§Ù… ÙƒÙˆÙƒØ¨ Ø§Ù„Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©", icon: "bi-stars" },
            { days: 365, name: "ÙˆØ³Ø§Ù… Ø¯ÙˆØ±Ø© ÙÙ„ÙƒÙŠØ© ÙƒØ§Ù…Ù„Ø©", icon: "bi-globe-americas" },
            { days: 500, name: "ÙˆØ³Ø§Ù… Ø¨Ø±Ù‚ Ø§Ù„Ù‚ÙˆØ©", icon: "bi-lightning-charge-fill" },
            { days: 650, name: "ÙˆØ³Ø§Ù… Ø¬Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø§Ø¯Ø©", icon: "bi-filter-circle-fill" }, // Represents a mountain icon
            { days: 750, name: "ÙˆØ³Ø§Ù… Ø£Ø³Ø·ÙˆØ±Ø© Ø­ÙŠØ©", icon: "bi-person-vcard-fill" },
            { days: 850, name: "ÙˆØ³Ø§Ù… Ø­ÙƒÙŠÙ… Ø§Ù„Ù…Ø«Ø§Ø¨Ø±Ø©", icon: "bi-mortarboard-fill" },
            { days: 1000, name: "ÙˆØ³Ø§Ù… ØªØ§Ø¬ Ø§Ù„Ø£Ù„ÙÙŠØ©", icon: "bi-trophy-fill" }
        ];
        let lastCheckedDay = -1; 
        const congratsModalEl = document.getElementById('congratsAchievementModal');
        const congratsModal = new bootstrap.Modal(congratsModalEl);

        async function resetAchievements() {
            const user = auth.currentUser;
            if (!user || user.isAnonymous) return;
            showSpinner();
            try {
                const achievementsColRef = collection(db, "users", user.uid, "achievements");
                const querySnapshot = await getDocs(achievementsColRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
            } catch (error) {
                console.error("Error resetting achievements:", error);
            } finally {
                hideSpinner();
            }
        }

        async function checkAndAwardAchievements(days) {
            const user = auth.currentUser;
            if (!user || user.isAnonymous || days < 1) return;
            showSpinner();
            try {
                for (const milestone of milestones) {
                    if (days >= milestone.days) {
                        const achievementRef = doc(db, "users", user.uid, "achievements", String(milestone.days));
                        try {
                            const achievementSnap = await getDoc(achievementRef);
                            if (!achievementSnap.exists()) {
                                await setDoc(achievementRef, {
                                    name: milestone.name,
                                    icon: milestone.icon,
                                    dateAwarded: serverTimestamp()
                                });
                                const userName = user.displayName || 'ÙŠØ§ Ø¨Ø·Ù„';
                                document.getElementById('congrats-user-text').textContent = `Ù…Ø¨Ø§Ø±Ùƒ ÙŠØ§ ${userName}!`;
                                document.getElementById('congrats-text').textContent = `Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ "${milestone.name}"`;
                                document.getElementById('congrats-icon').innerHTML = `<i class="${milestone.icon}"></i>`;
                                congratsModal.show();
                            }
                        } catch (error) {
                            console.error(`Error checking achievement for ${milestone.days} days:`, error);
                        }
                    } else {
                        break; 
                    }
                }
            } finally {
                hideSpinner();
            }
        }

        async function displayAchievements() {
            const grid = document.getElementById('achievements-grid');
            const currentDays = window.currentStreakDays || 0;
            grid.innerHTML = ''; 

            milestones.forEach(milestone => {
                const requiredDays = milestone.days;
                const card = document.createElement('div');
                card.classList.add('achievement-card');
                let iconClass, cardTitle = milestone.name, cardSubText;

                if (currentDays >= requiredDays) {
                    card.classList.remove('locked');
                    iconClass = milestone.icon;
                    cardSubText = `Ø£ÙƒÙ…Ù„Øª ${requiredDays} Ø£ÙŠØ§Ù… Ø¨Ù†Ø¬Ø§Ø­!`;
                } else {
                    card.classList.add('locked');
                    iconClass = 'bi bi-lock-fill';
                    cardSubText = `Ø£ÙƒÙ…Ù„ ${requiredDays} ÙŠÙˆÙ…Ø§Ù‹ Ù„ÙØªØ­Ù‡`;
                }
                
                card.innerHTML = `
                    <div class="achievement-card-icon"><i class="${iconClass}"></i></div>
                    <div class="achievement-card-title">${cardTitle}</div>
                    <div class="achievement-card-date">${cardSubText}</div>
                `;
                grid.appendChild(card);
            });
        }
        // END: Achievements Logic

        // START: Leaderboard Logic
        /**
         * Normalizes a Date object to the start of its day in UTC (00:00:00).
         * This function is crucial for timezone-independent day calculations.
         * @param {Date} date The input date.
         * @returns {Date} A new Date object set to the beginning of the day in UTC.
         */
        function getUTCDayStart(date) {
            const d = new Date(date);
            d.setUTCHours(0, 0, 0, 0);
            return d;
        }

        async function displayBannedList() {
            const bannedListBody = document.getElementById('banned-list-pane');
            bannedListBody.innerHTML = `<div class="loading-spinner-container"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            showSpinner();
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("isBannedFromLeaderboard", "==", true));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    bannedListBody.innerHTML = '<p class="text-center text-secondary mt-3">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† ÙØ§Ø±ØºØ©.</p>';
                    return;
                }

                let bannedListHTML = '<ul class="leaderboard-list">';
                querySnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const profilePic = userData.photoURL || 'https://placehold.co/100x100/1e1e1e/fafafa?text=?';
                    const restoreButtonHTML = `<i class="bi bi-arrow-counterclockwise leaderboard-restore-btn" data-userid="${userDoc.id}" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±"></i>`;

                    bannedListHTML += `
                        <li class="leaderboard-item" id="banned-user-${userDoc.id}">
                            <img src="${profilePic}" alt="User Picture" class="leaderboard-user-pic" style="margin-left: 1rem; margin-right: 0;">
                            <div class="leaderboard-user-info">
                                <h6 class="leaderboard-user-name">${userData.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</h6>
                            </div>
                            ${restoreButtonHTML}
                        </li>`;
                });
                bannedListHTML += '</ul>';
                bannedListBody.innerHTML = bannedListHTML;

                document.querySelectorAll('#leaderboardModal .leaderboard-restore-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const userIdToRestore = event.target.dataset.userid;
                        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                            showSpinner();
                            try {
                                const userToUpdateRef = doc(db, "users", userIdToRestore);
                                await updateDoc(userToUpdateRef, { isBannedFromLeaderboard: false });
                                event.target.closest('.leaderboard-item').remove();
                            } catch (error) { console.error("Error unbanning user: ", error); }
                            finally { hideSpinner(); }
                        }
                    });
                });

            } catch (error) {
                console.error("Error fetching banned list: ", error);
                bannedListBody.innerHTML = '<p class="text-center text-danger mt-3">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</p>';
            } finally {
                hideSpinner();
            }
        }

        async function displayLeaderboard() {
            const leaderboardListPane = document.getElementById('leaderboard-list-pane');
            const leaderboardFooter = document.getElementById('leaderboard-footer-user-rank');
            const tabsContainer = document.getElementById('leaderboard-tabs-container');
            const modalTitle = document.getElementById('leaderboardModalLabel');
            const user = auth.currentUser;
            if (!user) return;

            leaderboardListPane.innerHTML = `<div class="loading-spinner-container"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            leaderboardFooter.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border spinner-border-sm text-light" role="status"></div></div>`;
            document.getElementById('banned-list-pane').innerHTML = '';
            
            let allRankedUsers = [];

            showSpinner();
            try {
                let currentUserRole = 'user';
                if (!user.isAnonymous) {
                    const currentUserDoc = await getDoc(doc(db, "users", user.uid));
                    if (currentUserDoc.exists()) {
                        currentUserRole = currentUserDoc.data().role || 'user';
                    }
                }

                if (currentUserRole === 'developer') {
                    tabsContainer.classList.remove('d-none');
                    modalTitle.classList.add('d-none');
                    const bannedTab = document.getElementById('banned-list-tab');
                    if (!bannedTab.hasAttribute('data-listener-added')) {
                        bannedTab.addEventListener('click', displayBannedList);
                        bannedTab.setAttribute('data-listener-added', 'true');
                    }
                } else {
                    tabsContainer.classList.add('d-none');
                    modalTitle.classList.remove('d-none');
                }

                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("timerStartDate", "asc"));
                
                const querySnapshot = await getDocs(q);
                
                allRankedUsers = querySnapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.timerStartDate && data.role !== 'developer' && data.isBannedFromLeaderboard !== true;
                });
                
                if (allRankedUsers.length === 0) {
                    leaderboardListPane.innerHTML = '<p class="text-center text-secondary mt-3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© Ø¨Ø¹Ø¯.</p>';
                } else {
                    let leaderboardHTML = '<ul class="leaderboard-list">';
                    allRankedUsers.forEach((userDoc, index) => {
                        const userData = userDoc.data();
                        const startDate = userData.timerStartDate.toDate();
                        
                        // -- BEGIN ROBUST TIMEZONE FIX --
                        const startDayUTC = getUTCDayStart(startDate);
                        const todayUTC = getUTCDayStart(new Date());

                        let recoveryDays = 0;
                        if (!isNaN(startDayUTC.getTime())) {
                            const diffTime = todayUTC.getTime() - startDayUTC.getTime();
                            recoveryDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                        }
                        // -- END ROBUST TIMEZONE FIX --

                        const rank = index + 1;
                        const rankClass = rank <= 3 ? `rank-${rank}` : '';
                        let rankDisplay = rank <= 3 ? `<div class="leaderboard-rank-medal">${['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][rank - 1]}</div>` : `<div class="leaderboard-rank">${rank}</div>`;
                        const profilePic = userData.photoURL || 'https://placehold.co/100x100/1e1e1e/fafafa?text=?';
                        const deleteButtonHTML = currentUserRole === 'developer' ? `<i class="bi bi-x-circle-fill leaderboard-delete-btn" data-userid="${userDoc.id}" title="Ø­Ø¸Ø± Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©"></i>` : '';
                        
                        leaderboardHTML += `
                            <li class="leaderboard-item ${rankClass}" id="user-rank-${userDoc.id}" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#userAchievementsModal" data-userid="${userDoc.id}">
                                ${rankDisplay}
                                <img src="${profilePic}" alt="User Picture" class="leaderboard-user-pic">
                                <div class="leaderboard-user-info">
                                    <h6 class="leaderboard-user-name">${userData.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</h6>
                                    <p class="leaderboard-user-days">${recoveryDays} ÙŠÙˆÙ…</p>
                                </div>
                                ${deleteButtonHTML}
                            </li>`;
                    });
                    leaderboardHTML += '</ul>';
                    leaderboardListPane.innerHTML = leaderboardHTML;
                }
                
                if (currentUserRole === 'developer') {
                    document.querySelectorAll('#leaderboardModal .leaderboard-delete-btn').forEach(button => {
                        button.addEventListener('click', async (event) => {
                            event.stopPropagation(); // Prevent modal from opening
                            const userIdToBan = event.target.dataset.userid;
                            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©ØŸ")) {
                                showSpinner();
                                try {
                                    const userToUpdateRef = doc(db, "users", userIdToBan);
                                    await updateDoc(userToUpdateRef, { isBannedFromLeaderboard: true });
                                    event.target.closest('.leaderboard-item').remove();
                                } catch (error) { console.error("Error banning user: ", error); }
                                finally { hideSpinner(); }
                            }
                        });
                    });
                }

                // Inner function to calculate and display user's rank
                const findUserRank = async () => {
                    if (user.isAnonymous) {
                         leaderboardFooter.innerHTML = 'Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨';
                         return;
                    }
                    const currentUserDoc = await getDoc(doc(db, "users", user.uid));
                    if (!currentUserDoc.exists() || !currentUserDoc.data().timerStartDate) {
                        leaderboardFooter.innerHTML = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨';
                        return;
                    }

                    const userRankIndex = allRankedUsers.findIndex(doc => doc.id === user.uid);

                    if (userRankIndex !== -1) {
                        leaderboardFooter.innerHTML = `ğŸŒŸ ØªØ±ØªÙŠØ¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${userRankIndex + 1} ğŸŒŸ`;
                    } else {
                        leaderboardFooter.innerHTML = 'Ø£Ù†Øª ØºÙŠØ± Ù…ÙØµÙ†Ù‘Ù Ø­Ø§Ù„ÙŠÙ‹Ø§';
                    }
                };

                findUserRank();

            } catch (error) {
                console.error("Error fetching leaderboard: ", error);
                leaderboardListPane.innerHTML = '<p class="text-center text-danger mt-3">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>';
                leaderboardFooter.innerHTML = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨';
            } finally {
                hideSpinner();
            }
        }
        // END: Leaderboard Logic

        // START: User Achievements Modal Logic
        async function displayUserAchievements(userId) {
            const grid = document.getElementById('user-achievements-grid');
            grid.innerHTML = `<div class="loading-spinner-container w-100 d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            showSpinner();
            try {
                const achievementsRef = collection(db, "users", userId, "achievements");
                const q = query(achievementsRef, orderBy("dateAwarded", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    grid.innerHTML = '<p class="text-center text-secondary mt-3 w-100" style="grid-column: 1 / -1;">Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø£ÙŠ ÙˆØ³Ø§Ù… Ø¨Ø¹Ø¯.</p>';
                    return;
                }

                let achievementsHTML = '';
                querySnapshot.forEach(doc => {
                    const achievement = doc.data();
                    const date = achievement.dateAwarded?.toDate().toLocaleDateString('ar-EG', { day: 'numeric', month: 'short', year: 'numeric' }) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    
                    achievementsHTML += `
                        <div class="achievement-card">
                            <div class="achievement-card-icon"><i class="${achievement.icon || 'bi-trophy-fill'}"></i></div>
                            <div class="achievement-card-title">${achievement.name}</div>
                            <div class="achievement-card-date">Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡ ÙÙŠ: ${date}</div>
                        </div>
                    `;
                });
                grid.innerHTML = achievementsHTML;

            } catch (error) {
                console.error("Error fetching user achievements:", error);
                grid.innerHTML = '<p class="text-center text-danger mt-3 w-100" style="grid-column: 1 / -1;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ³Ù…Ø©.</p>';
            } finally {
                hideSpinner();
            }
        }
        // END: User Achievements Modal Logic


        function initializeGlobalChatNotifications(userId) {
            const chatBadge = document.querySelector('.chat-notification-badge');
            if (!chatBadge) return;

            let publicUnreadCount = 0;
            let privateUnreadCount = 0;

            function updateBadge() {
                const totalUnread = publicUnreadCount + privateUnreadCount;
                if (totalUnread > 0) {
                    chatBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                    chatBadge.style.display = 'flex';
                } else {
                    chatBadge.style.display = 'none';
                }
            }

            if (window.publicListenerUnsubscribe) window.publicListenerUnsubscribe();
            if (window.privateListenerUnsubscribe) window.privateListenerUnsubscribe();

            const lastReadTimestamp = parseInt(localStorage.getItem('lastReadTimestamp') || '0');
            const messagesRef = collection(db, "messages");
            const publicQuery = query(messagesRef, where("createdAt", ">", Timestamp.fromMillis(lastReadTimestamp)));
            window.publicListenerUnsubscribe = onSnapshot(publicQuery, (snapshot) => {
                let count = 0;
                snapshot.forEach(doc => { if (doc.data().senderId !== userId) count++; });
                publicUnreadCount = count;
                updateBadge();
            });

            const userIsAnonymous = auth.currentUser ? auth.currentUser.isAnonymous : true;
            if (!userIsAnonymous) {
                const privateChatsQuery = query(collection(db, "private_chats"), where("participants", "array-contains", userId));
                window.privateListenerUnsubscribe = onSnapshot(privateChatsQuery, (snapshot) => {
                    let count = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!data[`hidden_for_${userId}`]) count += (data[`unread_count_${userId}`] || 0);
                    });
                    privateUnreadCount = count;
                    updateBadge();
                });
            } else {
                 privateUnreadCount = 0;
                 updateBadge();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            function applyBackgroundPreference() {
                const savedTheme = localStorage.getItem('appBackgroundTheme') || 'default';
                const body = document.body;
                body.classList.remove('solid-black-bg', 'gradient-blue-bg');
                if (savedTheme === 'solid-black') {
                    body.classList.add('solid-black-bg');
                } else if (savedTheme === 'gradient-blue') {
                    body.classList.add('gradient-blue-bg');
                }
            }
            applyBackgroundPreference();

            let startTime = null;
            let timerInterval = null;
            window.currentStreakDays = 0;
            let currentUserRole = 'user';
            let breathingTimeouts = [];
            let countdownInterval = null;
            let lastSolution = null;
            const welcomeUserEl = document.getElementById('welcome-user');
            const openSendModalBtn = document.getElementById('open-send-modal-btn');
            const startTimerBtn = document.getElementById('start-timer-btn');
            const timerSettingsIcon = document.querySelector('.timer-settings-icon');
            const notificationBadge = document.querySelector('.notification-badge');
            const notificationsModalEl = document.getElementById('notifications-modal');
            let latestNotificationTimestamp = null;
            const natureImages = [
                'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80',
                'https://images.unsplash.com/photo-1488866022504-f2584929ca5f?w=800&q=80',
                'https://images.unsplash.com/photo-1542314831-068cd1dbb563?w=800&q=80',
                'https://images.unsplash.com/photo-1507525428034-b723a996f6ea?w=800&q=80'
            ];
            let lastImageIndex = -1;
            let modalsInitialized = false;

            const appLockOverlay = document.getElementById('app-lock-overlay');
            const passcodeError = document.getElementById('passcode-error');
            const unlockBtn = document.getElementById('unlock-btn');
            const passcodeInput = document.getElementById('passcode-input');
            const RELOCK_TIME = 3 * 60 * 1000;

            function getLockData() {
                try {
                    return JSON.parse(localStorage.getItem('app_lock_config')) || { enabled: false, passcode: null };
                } catch (e) {
                    return { enabled: false, passcode: null };
                }
            }

            function initializeModalListeners() {
                if (modalsInitialized) return;

                const achievementsModalEl = document.getElementById('achievementsModal');
                achievementsModalEl.addEventListener('show.bs.modal', displayAchievements);

                const leaderboardModalEl = document.getElementById('leaderboardModal');
                leaderboardModalEl.addEventListener('show.bs.modal', displayLeaderboard);
                
                const userAchievementsModalEl = document.getElementById('userAchievementsModal');
                userAchievementsModalEl.addEventListener('show.bs.modal', (event) => {
                    const triggerElement = event.relatedTarget; 
                    if (triggerElement) {
                        const userId = triggerElement.getAttribute('data-userid');
                        if (userId) {
                            const userName = triggerElement.querySelector('.leaderboard-user-name').textContent;
                            const modalTitleEl = userAchievementsModalEl.querySelector('.modal-title');
                            if(modalTitleEl) {
                                modalTitleEl.textContent = `Ø£ÙˆØ³Ù…Ø© ${userName}`;
                            }
                            displayUserAchievements(userId);
                        }
                    }
                });
                
                modalsInitialized = true;
            }
            
            function initializeAppLock() {
                const lockData = getLockData();
                if (!lockData.enabled) return;
                const lastUnlock = localStorage.getItem('app_last_unlock') || 0;
                const timeSinceUnlock = Date.now() - lastUnlock;
                if (timeSinceUnlock >= RELOCK_TIME) {
                    appLockOverlay.style.display = 'flex';
                }
            }

            function handleUnlock() {
                const enteredPasscode = passcodeInput.value;
                const lockData = getLockData();
                passcodeError.style.display = 'none';
                if (enteredPasscode === lockData.passcode) {
                    localStorage.setItem('app_last_unlock', Date.now());
                    appLockOverlay.style.display = 'none';
                    passcodeInput.value = '';
                } else {
                    passcodeError.style.display = 'block';
                    passcodeInput.classList.add('is-invalid');
                    setTimeout(() => passcodeInput.classList.remove('is-invalid'), 1000);
                }
            }

            unlockBtn.addEventListener('click', handleUnlock);
            passcodeInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleUnlock();
            });

            function callGeminiAPI(prompt) {
                showSpinner();
                return new Promise((resolve, reject) => {
                    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyYn_lPlFg25E8QTJQGie4ams49eYQekl-qZ9mm9oB4BkLyBtuTS2ZX9pw6D5mfj1Io/exec";
                    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                    window[callbackName] = function(data) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        if (data.error) {
                            resolve("Ø¹ÙÙˆÙ‹Ø§ØŒ Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ù…Ø¤Ù‚ØªØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.");
                        } else {
                            resolve(data.text);
                        }
                        hideSpinner();
                    };
                    const script = document.createElement('script');
                    script.src = WEB_APP_URL + '?callback=' + callbackName + '&prompt=' + encodeURIComponent(prompt);
                    script.onerror = function() {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve("Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¢Ø®Ø± Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ");
                        hideSpinner();
                    };
                    document.body.appendChild(script);
                });
            }

            function setupGeminiFeatures() {
                const inspirationBtn = document.getElementById('inspiration-btn');
                
                inspirationBtn.addEventListener('click', async () => {
                    const inspirationDisplay = document.getElementById('inspiration-display');
                    const inspirationText = document.getElementById('inspiration-text');
                    inspirationBtn.disabled = true;
                    inspirationBtn.innerHTML = `<span>Ù„Ø­Ø¸Ø© Ø£ÙÙƒØ± Ù„Ùƒ Ø¨Ø­Ù„... <i class="bi bi-hourglass-split"></i></span>`;
                    
                    let basePrompt = `Ø£Ù†Ø§ Ø¹Ù†Ø¯ÙŠ Ø±ØºØ¨Ø©Ø§Ø³Ù…Ø¹ ÙŠØ§ ØµØ§Ø­Ø¨ÙŠ Ø£Ù†Ø§ ÙÙŠÙ†ÙŠ Ø¨Ù„Ø§ ÙˆØ£Ø­Ø³ Ø¥Ù†ÙŠ Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø£Ø·ÙŠØ­ ÙÙŠ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ© ÙˆØ§Ù„Ø±ØºØ¨Ø© Ù‚ÙˆÙŠØ© Ù…Ø±Ø© Ø£Ø¨ØºØ§Ùƒ Ø¨ØµÙØªÙƒ Ù†Ø§ØµØ­ Ø£Ù…ÙŠÙ† ÙˆÙØ§Ù‡Ù… Ø¹Ù„Ù‰ Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ù„Ù Ø§Ù„ØµØ§Ù„Ø­ ØªØ¹Ø·ÙŠÙ†ÙŠ Ø­Ù„ Ø¹Ù…Ù„ÙŠ ÙˆÙÙˆØ±ÙŠ Ø£Ù‚Ø¯Ø± Ø£Ø³ÙˆÙŠÙ‡ Ø§Ù„Ø­ÙŠÙ† Ø¹Ø´Ø§Ù† Ø£Ø·ÙÙŠ Ù‡Ø°ÙŠ Ø§Ù„Ù†Ø§Ø±

        Ù„ÙƒÙ† Ø¹Ù†Ø¯ÙŠ Ø´Ø±ÙˆØ· ØµØ§Ø±Ù…Ø© Ù„Ø§Ø²Ù… ØªÙ„ØªØ²Ù… ÙÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø­Ø±Ù:

        1.  **Ø§Ù„Ù„Ù‡Ø¬Ø© ÙˆØ§Ù„Ø£Ø³Ù„ÙˆØ¨:** ØªÙƒÙ„Ù… Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø¹Ø§Ù…ÙŠØ© ÙˆÙƒØ£Ù†Ùƒ ØªØ³ÙˆÙ„Ù Ù…Ø¹ Ø®ÙˆÙŠÙƒ ÙÙŠ Ø£Ø²Ù…Ø© Ù„Ø§ ØªÙƒÙ„Ù…Ù†ÙŠ ÙƒØ£Ù†Ùƒ Ø¢Ù„Ø© Ø£Ùˆ Ø®Ø·ÙŠØ¨.

        2.  **Ø§Ù„ØªÙ†Ø³ÙŠÙ‚:** Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø£ÙŠ ØªØ´ÙƒÙŠÙ„ Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ±Ù‚ÙŠÙ… Ù†Ù‡Ø§Ø¦ÙŠØ§ Ù„Ø§ ÙØ§ØµÙ„Ø© ÙˆÙ„Ø§ Ù†Ù‚Ø·Ø© ÙˆÙ„Ø§ Ø´ÙŠ.

        3.  **Ø§Ù„Ø·ÙˆÙ„:** Ø¹Ø·Ù†ÙŠ ÙƒÙ„Ø§Ù… Ø·ÙˆÙŠÙ„ ÙˆÙ…ÙØµÙ„ ÙˆØ®Ø´ ÙÙŠ ØµÙ„Ø¨ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø¹Ù„Ù‰ Ø·ÙˆÙ„.

        4.  **Ø§Ù„Ø£Ù‡Ù… Ù…Ù† Ù‡Ø°Ø§ ÙƒÙ„Ù‡ (Ø´Ø±Ø· Ø£Ø³Ø§Ø³ÙŠ): Ø§Ù„ØªÙ†ÙˆØ¹ Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±.** ÙƒÙ„ Ù…Ø±Ø© Ø£Ù‚ÙˆÙ„ Ù„Ùƒ 'Ø£Ø¨ØºÙ‰ Ø­Ù„ Ø«Ø§Ù†ÙŠ' Ù„Ø§Ø²Ù… ØªØ¹Ø·ÙŠÙ†ÙŠ Ø­Ù„ Ø¬Ø¯ÙŠØ¯ ÙˆÙ…Ø®ØªÙ„Ù ØªÙ…Ø§Ù…Ø§ Ø¹Ù† ÙƒÙ„ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù„ÙŠ Ø¹Ø·ÙŠØªÙ†ÙŠ Ø¥ÙŠØ§Ù‡Ø§ Ù‚Ø¨Ù„. Ù„Ø§ ØªØ¹ÙŠØ¯ ØµÙŠØ§ØºØ© Ù†ÙØ³ Ø§Ù„ÙÙƒØ±Ø© ÙˆÙ„Ø§ ØªÙƒØ±Ø± Ø£ÙŠ Ù†ØµÙŠØ­Ø©. Ø¥Ø°Ø§ Ø­Ø³ÙŠØª Ø¥Ù†Ùƒ Ø¨ØªÙƒØ±Ø± ÙˆÙ‚Ù ÙˆÙ‚ÙˆÙ„ Ù„ÙŠ Ù…Ø§ Ø¹Ù†Ø¯ÙŠ Ø´ÙŠ Ø¬Ø¯ÙŠØ¯. Ù„Ø§Ø²Ù… ÙƒÙ„ Ø­Ù„ ÙŠÙƒÙˆÙ† ÙÙƒØ±Ø© Ù…Ø³ØªÙ‚Ù„Ø© ÙˆØ¬Ø¯ÙŠØ¯Ø©.

        ÙŠÙ„Ø§ Ø§Ù„Ø­ÙŠÙ† Ø¹Ø·Ù†ÙŠ Ø£ÙˆÙ„ Ø­Ù„ Ø¬Ø°Ø±ÙŠ ÙˆÙÙˆØ±ÙŠ.
        `;
                    if (lastSolution) basePrompt += `\nØ§Ù„Ø­Ù„ Ø§Ù„Ù„ÙŠ Ø¹Ø·ÙŠØªÙ†ÙŠ Ø¥ÙŠØ§Ù‡ Ù‚Ø¨Ù„ Ù‡Ùˆ: ${lastSolution}. Ù„Ø§ ØªÙƒØ±Ø±Ù‡ ÙˆØ¹Ø·Ù†ÙŠ Ø´ÙŠ Ø¬Ø¯ÙŠØ¯.`;

                    const generatedText = await callGeminiAPI(basePrompt);
                    if (generatedText && !generatedText.includes('Ø®Ø·Ø£')) lastSolution = generatedText;
                    
                    let newImageIndex;
                    do { newImageIndex = Math.floor(Math.random() * natureImages.length); } while (newImageIndex === lastImageIndex && natureImages.length > 1);
                    lastImageIndex = newImageIndex; 
                    inspirationDisplay.style.backgroundImage = `url('${natureImages[newImageIndex]}')`;
                    inspirationText.innerHTML = generatedText.replace(/\n/g, '<br>');
                    inspirationDisplay.classList.remove('d-none');
                    inspirationBtn.disabled = false;
                    inspirationBtn.innerHTML = `<span>ğŸ”¥ Ø£Ø¨ØºÙ‰ Ø­Ù„ Ø«Ø§Ù†ÙŠ</span>`;
                });

                // START: ADDED for Salaf Story Button
                const salafStoryBtn = document.getElementById('salaf-story-btn');
                const salafStoryDisplay = document.getElementById('salaf-story-display');
                const salafStoryText = document.getElementById('salaf-story-text');
                let lastSalafStory = null; // Separate tracking variable

                salafStoryBtn.addEventListener('click', async () => {
                    salafStoryDisplay.classList.remove('d-none');
                    salafStoryText.innerHTML = `<div class="d-flex justify-content-center align-items:center p-4"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
                    salafStoryBtn.disabled = true;
                    salafStoryBtn.innerHTML = `<span>Ù„Ø­Ø¸Ø© Ù†Ø¬ÙŠØ¨ Ù„Ùƒ Ù‚ØµØ© ØªØ±ÙˆÙ‚Ùƒ... <i class="bi bi-hourglass-split"></i></span>`;

                    // The new prompt requested by the user
                    let salafPrompt = `Ø¨ØµÙØªÙƒ Ù†Ø§ØµØ­  Ø§Ù…ÙŠÙ† ÙˆÙØ§Ù‡Ù… Ø¹Ù„Ù‰ Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ù„Ù Ø§Ù„ØµØ§Ù„Ø­ Ø§Ø³Ù…Ø¹ ÙŠØ§ ØµØ§Ø­Ø¨ÙŠ Ø£Ø¨ØºØ§Ùƒ ØªØ³ÙˆÙ„Ù Ù„ÙŠ Ø³Ø§Ù„ÙØ© Ø¹Ù† ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„ØµØ§Ù„Ø­ÙŠÙ† ÙˆÙƒÙŠÙ ÙƒØ§Ù† Ø®ÙˆÙÙ‡ Ù…Ù† Ø§Ù„Ù„Ù‡ ÙˆØªÙ‚ÙˆØ§Ù‡ ÙˆÙƒÙŠÙ ÙƒØ§Ù† ÙŠØ¬Ø§Ù‡Ø¯ Ù†ÙØ³Ù‡ Ø¹Ø´Ø§Ù† ÙŠØªØ±Ùƒ Ø§Ù„Ù…Ø¹Ø§ØµÙŠ ÙˆÙƒÙŠÙ Ù„Ù‚Ù‰ Ù„Ø°Ø© Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆØ§Ø±Ø¨Ø· Ù„ÙŠ Ù‡Ø§Ù„ÙƒÙ„Ø§Ù… Ø¨Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„ØªØ¹Ø§ÙÙŠ Ù…Ù† Ø§Ù„Ø¥Ø¯Ù…Ø§Ù† ÙˆÙƒÙŠÙ Ø¥Ù† Ù„Ø°Ø© Ø§Ù„Ø·Ø§Ø¹Ø© Ø£Ø­Ù„Ù‰ ÙˆØ£Ø¨Ù‚Ù‰ Ù…Ù† Ù„Ø°Ø© Ø§Ù„Ù…Ø¹ØµÙŠØ© Ø§Ù„Ø²Ø§ÙŠÙ„Ø©

        Ø¨Ø³ Ø¹Ù†Ø¯ÙŠ ÙƒÙ… Ø´Ø±Ø· Ù…Ù‡Ù… Ù…Ø±Ø© Ù„Ø§Ø²Ù… ØªÙ…Ø´ÙŠ Ø¹Ù„ÙŠÙ‡Ø§:

        1.  **Ø§Ù„Ø´Ø®ØµÙŠØ§Øª:** Ù„Ø§ ØªØ¬ÙŠØ¨ Ù„ÙŠ Ø³ÙŠØ±Ø© Ø§Ù„Ø®Ù„ÙØ§Ø¡ Ø§Ù„Ø±Ø§Ø´Ø¯ÙŠÙ† Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© (Ø£Ø¨Ùˆ Ø¨ÙƒØ± ÙˆØ¹Ù…Ø± ÙˆØ¹Ø«Ù…Ø§Ù† ÙˆØ¹Ù„ÙŠ) Ù„Ø£Ù†ÙŠ Ø£Ø¹Ø±Ù Ù‚ØµØµÙ‡Ù…. Ø£Ø¨ØºØ§Ùƒ ØªØ¬ÙŠØ¨ Ù„ÙŠ Ù‚ØµØµ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ÙˆØ¬Ø¯ÙŠØ¯Ø© ÙƒÙ„ Ù…Ø±Ø© Ù…Ù† Ø­ÙŠØ§Ø© Ø§Ù„ØªØ§Ø¨Ø¹ÙŠÙ† ÙˆØªØ§Ø¨Ø¹ÙŠ Ø§Ù„ØªØ§Ø¨Ø¹ÙŠÙ† ÙˆØ§Ù„Ø¹Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ØµØ§Ù„Ø­ÙŠÙ† ÙˆØ§Ù„Ø¹Ø¨Ø§Ø¯ ÙˆØ§Ù„Ø²Ù‡Ø§Ø¯ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø¹ØµÙˆØ±. ÙŠØ¹Ù†ÙŠ ÙƒÙ„ Ù…Ø±Ø© Ø£Ø·Ù„Ø¨ Ù…Ù†Ùƒ Ø¹Ø·Ù†ÙŠ Ù‚ØµØ© Ù„Ø´Ø®ØµÙŠØ© Ù…Ø®ØªÙ„ÙØ© ØªÙ…Ø§Ù…Ø§ ÙˆÙ„Ø§ ØªÙƒØ±Ø± Ù„ÙŠ Ù†ÙØ³ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø£Ø¨Ø¯Ø§.

        2.  **Ø§Ù„Ù…Ù†Ù‡Ø¬:** Ù„Ø§ ØªØ·Ù„Ø¹ Ø¹Ù† Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ù„Ù Ø§Ù„ØµØ§Ù„Ø­ ÙÙŠ Ø·Ø±ÙŠÙ‚Ø© Ø³Ø±Ø¯Ùƒ Ù„Ù„Ù‚ØµØµ ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.

        3.  **Ø§Ù„Ù„Ù‡Ø¬Ø©:** ØªÙƒÙ„Ù… Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø¹Ø§Ù…ÙŠØ© ÙˆØ®Ù„Ùƒ Ø·Ø¨ÙŠØ¹ÙŠ ÙƒØ£Ù†Ùƒ ØªØ³ÙˆÙ„Ù Ù…Ø¹ Ø®ÙˆÙŠÙƒ ÙÙŠ Ø§Ø³ØªØ±Ø§Ø­Ø©.

        4.  **Ø§Ù„ØªÙ†Ø³ÙŠÙ‚:** Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ±Ù‚ÙŠÙ… (Ù„Ø§ ÙØ§ØµÙ„Ø© ÙˆÙ„Ø§ Ù†Ù‚Ø·Ø©) ÙˆÙ„Ø§ Ø£ÙŠ ØªØ´ÙƒÙŠÙ„ (ÙØªØ­Ø© Ø¶Ù…Ø© ÙƒØ³Ø±Ø©) Ù†Ù‡Ø§Ø¦ÙŠØ§.

        5.  **Ø§Ù„Ø·ÙˆÙ„:** Ø¹Ø·Ù†ÙŠ ÙƒÙ„Ø§Ù… Ø·ÙˆÙŠÙ„ ÙˆÙ…ÙØµÙ„ ÙˆØ³ÙˆÙ„Ù Ù…Ù† Ù‚Ù„Ø¨Ùƒ Ù„Ø§ ØªØ®ØªØµØ± Ø§Ù„Ø³Ø§Ù„ÙØ©.

        ÙŠÙ„Ø§ Ø§Ù„Ø­ÙŠÙ† Ø¹Ø·Ù†ÙŠ Ø£ÙˆÙ„ Ù‚ØµØ©.
        `;
                    if (lastSalafStory) {
                        salafPrompt += `\nØ§Ù„Ù‚ØµØ© Ø§Ù„Ù„ÙŠ Ø¹Ø·ÙŠØªÙ†ÙŠ Ø¥ÙŠØ§Ù‡Ø§ Ù‚Ø¨Ù„ ÙƒØ§Ù†Øª Ø¹Ù†: ${lastSalafStory.substring(0, 50)}. Ù„Ø§ ØªÙƒØ±Ø±Ù‡Ø§ ÙˆØ¹Ø·Ù†ÙŠ Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø©.`;
                    }

                    const generatedText = await callGeminiAPI(salafPrompt);

                    if (generatedText && !generatedText.includes('Ø®Ø·Ø£') && !generatedText.includes('Ù…Ø´ÙƒÙ„Ø©')) {
                        lastSalafStory = generatedText;
                    }
                    
                    let newImageIndex;
                    do {
                        newImageIndex = Math.floor(Math.random() * natureImages.length);
                    } while (newImageIndex === lastImageIndex && natureImages.length > 1);
                    lastImageIndex = newImageIndex;
                    salafStoryDisplay.style.backgroundImage = `url('${natureImages[newImageIndex]}')`;

                    salafStoryText.innerHTML = generatedText.replace(/\n/g, '<br>');
                    
                    salafStoryBtn.disabled = false;
                    salafStoryBtn.innerHTML = `<span>ğŸ“– Ø£Ø¨ØºÙ‰ Ù‚ØµØ© Ø«Ø§Ù†ÙŠØ©</span>`;
                });
                // END: ADDED for Salaf Story Button
            }

            onAuthStateChanged(auth, async (user) => {
                showSpinner();
                try {
                    if (user && (user.emailVerified || user.isAnonymous)) {
                        document.body.style.visibility = 'visible';
                        initializeAppLock();

                        setInterval(() => { if (document.visibilityState === 'visible') localStorage.setItem('app_last_unlock', Date.now()); }, 60 * 1000); 
                        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') initializeAppLock(); });
                        
                        initializeGlobalChatNotifications(user.uid);
                        listenForBackgroundImageChanges();

                        if (user.isAnonymous) {
                            welcomeUserEl.textContent = `Ù…Ø±Ø­Ø¨Ø§ Ù²ÙŠÙ‡Ø§ Ø§Ù„Ø²Ø§Ø¦Ø±`;
                            openSendModalBtn.classList.add('d-none');
                            const visitorTimerStart = localStorage.getItem('visitorTimerStart');
                            if (visitorTimerStart) {
                                startTime = new Date(parseInt(visitorTimerStart));
                                startTimerBtn.classList.add('d-none');
                                timerSettingsIcon.classList.remove('d-none');
                                updateTimer();
                                if(timerInterval) clearInterval(timerInterval);
                                timerInterval = setInterval(updateTimer, 1000);
                            } else {
                                startTimerBtn.classList.remove('d-none');
                                timerSettingsIcon.classList.add('d-none');
                                updateTimerDisplay(0, 0, 0, 0);
                            }
                            loadNotifications(null);
                        } else {
                            welcomeUserEl.textContent = `Ù…Ø±Ø­Ø¨Ø§ ${user.displayName || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'}`;
                            const userDocRef = doc(db, "users", user.uid);
                            const userDoc = await getDoc(userDocRef);
                            if (userDoc.exists()) {
                                currentUserRole = userDoc.data().role || 'user';
                                if (currentUserRole === 'developer') { 
                                    openSendModalBtn.classList.remove('d-none'); 
                                    document.getElementById('developer-background-options').classList.remove('d-none');
                                }
                                if (userDoc.data().timerStartDate) {
                                    startTime = userDoc.data().timerStartDate.toDate();
                                    startTimerBtn.classList.add('d-none'); 
                                    timerSettingsIcon.classList.remove('d-none'); 
                                    updateTimer();
                                    if (timerInterval) clearInterval(timerInterval);
                                    timerInterval = setInterval(updateTimer, 1000);
                                } else {
                                    startTimerBtn.classList.remove('d-none'); 
                                    timerSettingsIcon.classList.add('d-none'); 
                                    updateTimerDisplay(0,0,0,0); 
                                }
                            } else {
                                await setDoc(userDocRef, { role: 'user', lastSeenNotificationTimestamp: new Date(0), displayName: user.displayName, photoURL: user.photoURL }, { merge: true });
                                startTimerBtn.classList.remove('d-none');
                                timerSettingsIcon.classList.add('d-none');
                                updateTimerDisplay(0,0,0,0);
                            }
                            loadNotifications(user.uid);
                        }
                         initializeModalListeners();
                    } else {
                        window.location.href = 'index.html';
                    }
                } finally {
                    hideSpinner();
                }
            });

            startTimerBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                startTime = new Date();
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const userDocRef = doc(db, "users", user.uid);
                        await setDoc(userDocRef, { timerStartDate: startTime }, { merge: true });
                    } else {
                        localStorage.setItem('visitorTimerStart', startTime.getTime());
                    }
                    startTimerBtn.classList.add('d-none');
                    timerSettingsIcon.classList.remove('d-none');
                    updateTimer();
                    if (timerInterval) clearInterval(timerInterval);
                    timerInterval = setInterval(updateTimer, 1000);
                } finally {
                    hideSpinner();
                }
            });

            async function loadNotifications(userId) {
                const notificationsList = document.getElementById('notifications-list');
                let lastSeenTimestamp = new Date(0);
                const isUserRegistered = userId && auth.currentUser && !auth.currentUser.isAnonymous;


                showSpinner();
                try {
                    if (isUserRegistered) {
                        const userDoc = await getDoc(doc(db, "users", userId));
                        lastSeenTimestamp = userDoc.data()?.lastSeenNotificationTimestamp?.toDate() || new Date(0);
                    }

                    const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"));
                    onSnapshot(q, (snapshot) => {
                        notificationsList.innerHTML = "";
                        if (snapshot.empty) {
                            notificationsList.innerHTML = '<p class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                            notificationBadge.style.display = 'none';
                            return;
                        }

                        if (isUserRegistered) {
                            latestNotificationTimestamp = snapshot.docs[0].data().createdAt?.toDate();
                            notificationBadge.style.display = latestNotificationTimestamp > lastSeenTimestamp ? 'block' : 'none';
                        } else {
                            notificationBadge.style.display = 'none';
                        }

                        snapshot.forEach(docSnapshot => {
                            const notification = docSnapshot.data();
                            const date = notification.createdAt?.toDate().toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' }) || '';
                            const item = document.createElement('div');
                            item.className = 'notification-item';
                            const deleteIconHTML = (currentUserRole === 'developer' && isUserRegistered) ? `<i class="bi bi-trash delete-notification-btn" data-id="${docSnapshot.id}" style="display: inline-block;"></i>` : '';
                            item.innerHTML = `${deleteIconHTML}<div class="d-flex justify-content-between align-items-center"><h6 class="notification-title mb-1">${notification.title}</h6><span class="notification-date">${date}</span></div><p class="notification-body mb-0">${notification.message}</p>`;
                            notificationsList.appendChild(item);
                        });

                        if (currentUserRole === 'developer' && isUserRegistered) {
                            document.querySelectorAll('.delete-notification-btn').forEach(button => {
                                button.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±ØŸ')) {
                                        showSpinner();
                                        try {
                                            await deleteDoc(doc(db, "notifications", e.target.getAttribute('data-id')));
                                        } finally {
                                            hideSpinner();
                                        }
                                    }
                                });
                            });
                        }
                    });
                } finally {
                    hideSpinner();
                }
            }

            notificationsModalEl.addEventListener('show.bs.modal', async () => {
                const user = auth.currentUser;
                if (user && !user.isAnonymous && latestNotificationTimestamp) {
                    notificationBadge.style.display = 'none';
                    await updateDoc(doc(db, "users", user.uid), { lastSeenNotificationTimestamp: latestNotificationTimestamp });
                }
            });
            
            const sendNotificationModal = new bootstrap.Modal(document.getElementById('send-notification-modal'));
            document.getElementById('send-notification-btn').addEventListener('click', async () => {
                const title = document.getElementById('notification-title').value.trim();
                const message = document.getElementById('notification-message').value.trim();
                if (!title || !message) return;
                showSpinner();
                try {
                    await addDoc(collection(db, "notifications"), { title, message, createdAt: serverTimestamp() });
                    document.getElementById('notification-title').value = '';
                    document.getElementById('notification-message').value = '';
                    sendNotificationModal.hide();
                } finally {
                    hideSpinner();
                }
            });

            const dateElement = document.getElementById('current-date');
            const [daysValueEl, hoursValueEl, minutesValueEl, secondsValueEl] = ['days-value', 'hours-value', 'minutes-value', 'seconds-value'].map(id => document.getElementById(id));
            const [daysFillEl, hoursFillEl, minutesFillEl, secondsFillEl] = ['days-fill', 'hours-fill', 'minutes-fill', 'seconds-fill'].map(id => document.getElementById(id));
            
            dateElement.textContent = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            function updateTimerDisplay(d, h, m, s) {
                daysValueEl.textContent = d; hoursValueEl.textContent = h; minutesValueEl.textContent = m; secondsValueEl.textContent = s;
                daysFillEl.style.width = `${Math.min(d > 0 ? ((d % 30) / 29) * 100 : 0, 100)}%`;
                hoursFillEl.style.width = `${Math.min(h > 0 ? (h / 23) * 100 : 0, 100)}%`;
                minutesFillEl.style.width = `${Math.min(m > 0 ? (m / 59) * 100 : 0, 100)}%`;
                secondsFillEl.style.width = `${Math.min(s > 0 ? (s / 59) * 100 : 0, 100)}%`;
            }

            function updateTimer() {
                if (!startTime) { updateTimerDisplay(0,0,0,0); return; };
                const difference = new Date() - startTime;
                if (difference < 0) { updateTimerDisplay(0,0,0,0); return; }
                const days = Math.floor(difference / 86400000);
                const hours = Math.floor((difference % 86400000) / 3600000);
                const minutes = Math.floor((difference % 3600000) / 60000);
                const seconds = Math.floor((difference % 60000) / 1000);
                updateTimerDisplay(days, hours, minutes, seconds);

                window.currentStreakDays = days;
                if (days > lastCheckedDay) {
                    checkAndAwardAchievements(days);
                    lastCheckedDay = days;
                }
            }

            const settingsModalOverlay = document.getElementById('settings-modal-overlay');
            const confirmResetModal = document.getElementById('confirm-reset-modal');
            const closeSettingsModal = () => settingsModalOverlay.classList.remove('show');
            document.querySelector('.timer-settings-icon').addEventListener('click', () => settingsModalOverlay.classList.add('show'));
            document.getElementById('close-settings-button').addEventListener('click', closeSettingsModal);
            document.getElementById('set-date-button').addEventListener('click', () => document.getElementById('date-time-picker').showPicker());
            
            document.getElementById('date-time-picker').addEventListener('change', async (e) => {
                if (!e.target.value) return;
                const newStartTime = new Date(e.target.value);
                if (isNaN(newStartTime.getTime())) return;
                
                showSpinner();
                try {
                    const user = auth.currentUser;
                    if (user && !user.isAnonymous) {
                        await resetAchievements();
                        await setDoc(doc(db, "users", user.uid), { timerStartDate: newStartTime }, { merge: true });
                    } else {
                        localStorage.setItem('visitorTimerStart', newStartTime.getTime());
                    }
                    location.reload();
                } finally {
                    hideSpinner();
                }
            });

            document.getElementById('reset-timer-button').addEventListener('click', () => { closeSettingsModal(); setTimeout(() => confirmResetModal.classList.add('show'), 300); });
            const closeConfirmModal = () => confirmResetModal.classList.remove('show');
            document.getElementById('cancel-reset-button').addEventListener('click', closeConfirmModal);
            
            document.getElementById('confirm-reset-action-button').addEventListener('click', async () => {
                showSpinner();
                try {
                    const user = auth.currentUser;
                    if (user && !user.isAnonymous) await resetAchievements(); 
                    const newStartTime = new Date();
                    if (user && !user.isAnonymous) {
                        await setDoc(doc(db, "users", user.uid), { timerStartDate: newStartTime }, { merge: true });
                    } else {
                        localStorage.setItem('visitorTimerStart', newStartTime.getTime());
                    }
                    location.reload();
                } finally {
                    hideSpinner();
                }
            });


            const breathingPage = document.getElementById('breathing-page');
            const homePage = document.getElementById('home-page');
            const quotePage = document.getElementById('quote-page');
            
            function stopBreathingCycle() {
                breathingTimeouts.forEach(clearTimeout); breathingTimeouts = [];
                if (countdownInterval) clearInterval(countdownInterval);
            }

            async function showQuotePage() {
                let newImageIndex;
                do { newImageIndex = Math.floor(Math.random() * natureImages.length); } while (newImageIndex === lastImageIndex);
                lastImageIndex = newImageIndex;
                quotePage.style.backgroundImage = `url('${natureImages[newImageIndex]}')`;
                
                breathingPage.classList.remove('active');
                quotePage.classList.add('active');
                
                document.getElementById('quote-text').innerHTML = '<div class="spinner-border text-light"></div>';
                const prompt = "Ø¨ØµÙØªÙƒ Ù†Ø§ØµØ­ Ø£Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ù„Ù Ø§Ù„ØµØ§Ù„Ø­ Ø®Ø§Ø·Ø¨ Ø´Ø®Øµ Ø¹Ù„Ù‰ ÙˆØ´Ùƒ ÙŠØ·ÙŠØ­ ÙÙŠ Ù…Ø¹ØµÙŠØ© Ø§Ù„Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ© Ø£Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ© Ø¹Ø·Ù‡ ÙƒÙ„Ø§Ù… Ù‚ÙˆÙŠ ÙˆÙ…Ø¨Ø§Ø´Ø± ÙŠØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù‚Ù„ ÙˆØ§Ù„ØªØ±Ù‡ÙŠØ¨ ÙˆØ§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ø¹ÙˆØ§Ù‚Ø¨ Ø§Ù„ÙØ¹Ù„ Ø¹Ø´Ø§Ù† ÙŠØªØ±Ø§Ø¬Ø¹ ÙÙˆØ±Ø§ ØªÙƒÙ„Ù… Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø¹Ø§Ù…ÙŠØ© ÙˆØ±Ø¯Ùƒ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¨Ø¯ÙˆÙ† ØªØ´ÙƒÙŠÙ„ ÙˆØ¨Ø¯ÙˆÙ† Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ±Ù‚ÙŠÙ… Ù†Ù‡Ø§Ø¦ÙŠØ§ ÙˆØ®Ù„ÙŠÙ‡ Ù‚ØµÙŠØ± ÙˆÙ…Ø®ØªØµØ± ÙˆØ·Ø¨ÙŠØ¹ÙŠ ÙƒØ£Ù†Ùƒ ØªÙƒÙ„Ù… Ø®ÙˆÙŠÙƒ";
                document.getElementById('quote-text').innerHTML = await callGeminiAPI(prompt);
            }

            document.getElementById('najda-button').addEventListener('click', () => {
                stopBreathingCycle();
                homePage.classList.remove('active');
                breathingPage.classList.add('active');
                let remainingTime = 57;
                const breathingTimerEl = document.getElementById('breathing-timer');
                countdownInterval = setInterval(() => {
                    remainingTime--;
                    breathingTimerEl.textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remainingTime} Ø«Ø§Ù†ÙŠØ©`;
                    if (remainingTime < 0) { stopBreathingCycle(); showQuotePage(); }
                }, 1000);
                
                const breathingTextEl = document.getElementById('breathing-text');
                function cycle() {
                    breathingTextEl.textContent = 'Ø´Ù‡ÙŠÙ‚';
                    breathingTimeouts.push(setTimeout(() => { breathingTextEl.textContent = 'Ø­Ø¨Ø³ Ø§Ù„Ù†ÙØ³'; }, 4000));
                    breathingTimeouts.push(setTimeout(() => { breathingTextEl.textContent = 'Ø²ÙÙŠØ±'; }, 11000));
                    breathingTimeouts.push(setTimeout(cycle, 19000));
                }
                cycle();
            });

            document.getElementById('close-breathing-btn').addEventListener('click', () => {
                stopBreathingCycle();
                breathingPage.classList.remove('active');
                homePage.classList.add('active');
            });
            document.getElementById('close-quote-btn').addEventListener('click', () => {
                quotePage.classList.remove('active');
                homePage.classList.add('active');
            });
            document.getElementById('skip-to-quote-btn').addEventListener('click', () => {
                stopBreathingCycle();
                showQuotePage();
            });
            
            const cardElement = document.querySelector('.progress-timer-card');
            const imageElement = document.getElementById('counter-image-bg');
            const overlayElement = document.querySelector('.image-background-overlay');
            const setImageButton = document.getElementById('set-image-button');
            const removeBackgroundButton = document.getElementById('remove-background-button');
            const imageFilePicker = document.getElementById('image-file-picker');

            function setCounterBackgroundImage(imageUrl) {
                if (imageUrl) {
                    cardElement.style.background = 'none';
                    overlayElement.classList.add('visible');
                    imageElement.src = imageUrl;
                    imageElement.classList.add('visible');
                } else {
                    cardElement.style.background = '';
                    overlayElement.classList.remove('visible');
                    imageElement.classList.remove('visible');
                }
            }
            
            function listenForBackgroundImageChanges() {
                onSnapshot(doc(db, "app_config", "background_image"), (doc) => {
                    setCounterBackgroundImage(doc.exists() ? doc.data().url : null);
                });
            }

            async function uploadImageToCloudinary(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'back photo');
                formData.append('folder', 'back photo'); 
                showSpinner();
                try {
                    setImageButton.innerHTML = `<span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</span>`;
                    setImageButton.disabled = true;
                    const response = await fetch(`https://api.cloudinary.com/v1_1/dsf3gudnd/image/upload`, { method: 'POST', body: formData });
                    const data = await response.json();
                    return data.secure_url || null;
                } catch (error) { return null; }
                finally {
                     setImageButton.innerHTML = `<span>ØªØ¹ÙŠÙŠÙ† ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ©</span><div class="icon-container green"><i class="bi bi-image"></i></div>`;
                     setImageButton.disabled = false;
                     hideSpinner();
                }
            }
            
            async function updateBackgroundImageInFirestore(url) {
                showSpinner();
                try {
                    await setDoc(doc(db, "app_config", "background_image"), { url: url }, { merge: true });
                } finally {
                    hideSpinner();
                }
            }

            setImageButton.addEventListener('click', () => imageFilePicker.click());
            removeBackgroundButton.addEventListener('click', async () => {
                await updateBackgroundImageInFirestore(null);
                closeSettingsModal();
            });

            imageFilePicker.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    const imageUrl = await uploadImageToCloudinary(file);
                    if (imageUrl) await updateBackgroundImageInFirestore(imageUrl);
                    closeSettingsModal();
                }
            });

            setupGeminiFeatures();

            // --- START: Commitment Document logic ---
            const formPage = document.getElementById('form-page');
            const documentPage = document.getElementById('document-page');
            const editPage = document.getElementById('edit-page');
            const createForm = document.getElementById('commitment-form');
            const editForm = document.getElementById('commitment-form-edit');
            const editBtn = document.getElementById('edit-btn');
            const deleteBtn = document.getElementById('delete-btn');
            const commitmentPages = { formPage, documentPage, editPage };
            const userSignatureEl = document.getElementById('user-signature');

            const showCommitmentPage = (pageId) => {
                Object.values(commitmentPages).forEach(page => {
                    page.classList.remove('hidden'); 
                    if (page.id === pageId) {
                        page.classList.add('visible');
                    } else {
                        page.classList.remove('visible');
                    }
                });
                const visiblePage = document.querySelector('#commitment-document-page .visible');
                if (visiblePage) {
                    visiblePage.scrollTo(0, 0);
                }
            };

            const populateDocument = (data) => {
                document.getElementById('damages-output').textContent = data.damages || '';
                document.getElementById('fears-output').textContent = data.fears || '';
                document.getElementById('responses-output').textContent = data.responses || '';
                document.getElementById('benefits-output').textContent = data.benefits || '';
                document.getElementById('escape-plan-output').textContent = data.escapePlan || '';
                document.getElementById('message-output').textContent = data.message || '';
                document.getElementById('current-date-doc').textContent = new Date().toLocaleDateString('ar-EG');
            };

            const populateEditForm = (data) => {
                document.getElementById('edit-damages').value = data.damages || '';
                document.getElementById('edit-fears').value = data.fears || '';
                document.getElementById('edit-responses').value = data.responses || '';
                document.getElementById('edit-benefits').value = data.benefits || '';
                document.getElementById('edit-escape-plan').value = data.escapePlan || '';
                document.getElementById('edit-message').value = data.message || '';
            };

            const loadCommitmentData = async () => {
                const user = auth.currentUser;
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const docRef = doc(db, "users", user.uid, "commitment", "document");
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            populateDocument(data);
                            if(userSignatureEl) userSignatureEl.textContent = user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
                            showCommitmentPage('document-page');
                        } else {
                            showCommitmentPage('form-page');
                        }
                    } else {
                        const savedData = localStorage.getItem('commitmentDocument');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            populateDocument(data);
                            if(userSignatureEl) userSignatureEl.textContent = 'Ø²Ø§Ø¦Ø±';
                            showCommitmentPage('document-page');
                        } else {
                            showCommitmentPage('form-page');
                        }
                    }
                } finally {
                    hideSpinner();
                }
            };

            const saveCommitmentData = async (data) => {
                const user = auth.currentUser;
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const docRef = doc(db, "users", user.uid, "commitment", "document");
                        await setDoc(docRef, data);
                    } else {
                        localStorage.setItem('commitmentDocument', JSON.stringify(data));
                    }
                } finally {
                    hideSpinner();
                }
            };

            const deleteCommitmentData = async () => {
                const user = auth.currentUser;
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const docRef = doc(db, "users", user.uid, "commitment", "document");
                        await deleteDoc(docRef);
                    } else {
                        localStorage.removeItem('commitmentDocument');
                    }
                } finally {
                    hideSpinner();
                }
            };


            createForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const data = {
                    damages: document.getElementById('damages').value,
                    fears: document.getElementById('fears').value,
                    responses: document.getElementById('responses').value,
                    benefits: document.getElementById('benefits').value,
                    escapePlan: document.getElementById('escape-plan').value,
                    message: document.getElementById('message').value
                };
                await saveCommitmentData(data);
                populateDocument(data);
                if(userSignatureEl) userSignatureEl.textContent = (user && !user.isAnonymous) ? (user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…') : 'Ø²Ø§Ø¦Ø±';
                showCommitmentPage('document-page');
            });

            editBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                let data;
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const docRef = doc(db, "users", user.uid, "commitment", "document");
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            data = docSnap.data();
                        }
                    } else {
                        const savedData = localStorage.getItem('commitmentDocument');
                        if (savedData) data = JSON.parse(savedData);
                    }

                    if (data) {
                        populateEditForm(data);
                        showCommitmentPage('edit-page');
                    }
                } finally {
                    hideSpinner();
                }
            });


            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const updatedData = {
                    damages: document.getElementById('edit-damages').value,
                    fears: document.getElementById('edit-fears').value,
                    responses: document.getElementById('edit-responses').value,
                    benefits: document.getElementById('edit-benefits').value,
                    escapePlan: document.getElementById('edit-escape-plan').value,
                    message: document.getElementById('edit-message').value
                };
                await saveCommitmentData(updatedData);
                populateDocument(updatedData);
                if(userSignatureEl) userSignatureEl.textContent = (user && !user.isAnonymous) ? (user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…') : 'Ø²Ø§Ø¦Ø±';
                showCommitmentPage('document-page');
            });

            deleteBtn.addEventListener('click', () => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-auto text-center">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                        <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
                        <div class="flex justify-center space-x-4 space-x-reverse">
                            <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Ø­Ø°Ù</button>
                            <button id="cancel-delete-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                    await deleteCommitmentData();
                    createForm.reset();
                    document.body.removeChild(modal);
                    showCommitmentPage('form-page');
                });
                document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            // --- END: Commitment Document logic ---


            // --- START: New Navigation Logic ---
            const commitmentPageContainer = document.getElementById('commitment-document-page');
            const commitmentBtn = document.getElementById('commitment-btn');
            const backToHomeBtn = document.getElementById('back-to-home-btn');

            if(commitmentBtn) {
                commitmentBtn.addEventListener('click', async () => {
                    await loadCommitmentData(); // Load data before showing the page
                    if(homePage) homePage.classList.remove('active');
                    if(commitmentPageContainer) commitmentPageContainer.classList.add('active');
                });
            }

            if(backToHomeBtn) {
                backToHomeBtn.addEventListener('click', () => {
                    if(commitmentPageContainer) commitmentPageContainer.classList.remove('active');
                    if(homePage) homePage.classList.add('active');
                });
            }
            // --- END: New Navigation Logic ---

            // --- START: Sleep AI Logic ---
            const sleepPage = document.getElementById('sleep-improvement-page');
            const sleepAiBtn = document.getElementById('sleep-ai-btn');
            const backFromSleepBtn = document.getElementById('back-to-home-from-sleep-btn');
            
            const logSection = document.getElementById('sleep-log-section');
            const questionSection = document.getElementById('daily-question-section');
            const analysisSection = document.getElementById('sleep-analysis-section');

            const sleepTimeInput = document.getElementById('sleep-time-input');
            const wakeTimeInput = document.getElementById('wake-time-input');
            const durationDisplay = document.getElementById('sleep-duration-display');
            const submitSleepTimeBtn = document.getElementById('submit-sleep-time-btn');
            const cancelSleepTimeBtn = document.getElementById('cancel-sleep-time-btn');

            
            const questionTextEl = document.getElementById('daily-question-text');
            const questionOptionsContainer = document.getElementById('daily-question-options-container');

            const weeklyAnalysisContainer = document.getElementById('weekly-analysis-container');
            const analysisLastUpdatedEl = document.getElementById('analysis-last-updated');
            let sleepChartInstance = null;
            let tempTimeData = {};

            const dailyQuestions = [
                { key: 'mood', text: 'ÙƒÙŠÙ ÙƒØ§Ù† Ù…ÙˆØ¯Ùƒ Ø§Ù…Ø³ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…', options: ['Ø±Ø§ÙŠÙ‚ ÙˆÙ…Ù…ØªØ§Ø²', 'Ø¹Ø§Ø¯ÙŠ', 'Ù…ØªØ¶Ø§ÙŠÙ‚ Ø´ÙˆÙŠ', 'Ù…Ø±Ù‡ Ù…Ø¹ØµØ¨'] },
                { key: 'energy', text: 'ÙˆÙƒÙŠÙ ÙƒØ§Ù†Øª Ø·Ø§Ù‚ØªÙƒ ÙˆÙ†Ø´Ø§Ø·Ùƒ Ø§Ù…Ø³', options: ['Ø·Ø§Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©', 'Ù†Ø´ÙŠØ· Ù†ÙˆØ¹Ø§ Ù…Ø§', 'Ø®Ø§Ù…Ù„ ÙˆÙƒØ³Ù„Ø§Ù†', 'Ù…Ø±Ù‡ ØªØ¹Ø¨Ø§Ù†'] },
                { key: 'food', text: 'Ø§ÙƒÙ„Øª Ø§ÙƒÙ„ Ø¯Ø³Ù… Ø§Ùˆ Ø«Ù‚ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ… Ø§Ù…Ø³', options: ['Ø§ÙŠÙ‡ Ø§ÙƒÙ„Øª ÙˆØ¬Ø¨Ø© Ø¯Ø³Ù…Ø©', 'Ø§ÙƒÙ„Øª Ø´ÙŠ Ø®ÙÙŠÙ', 'Ù„Ø§ Ù…Ø§ Ø§ÙƒÙ„Øª Ø´ÙŠ', 'Ù…Ø§ Ø§Ø°ÙƒØ± ÙˆØ§Ù„Ù„Ù‡'] },
                { key: 'screen_time', text: 'ÙƒÙ… Ø³Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ¨Ø§ Ø§Ø³ØªØ®Ø¯Ù…Øª Ø¬ÙˆØ§Ù„Ùƒ Ø§Ù…Ø³ Ù‚Ø¨Ù„ ØªÙ†Ø§Ù…', options: ['Ø§Ù‚Ù„ Ù…Ù† Ø³Ø§Ø¹Ø©', 'Ø³Ø§Ø¹Ø© Ø§Ù„Ù‰ Ø³Ø§Ø¹ØªÙŠÙ†', 'Ø§ÙƒØ«Ø± Ù…Ù† Ø³Ø§Ø¹ØªÙŠÙ†', 'Ù…Ø§ Ø§Ø³ØªØ®Ø¯Ù…ØªÙ‡'] },
                { key: 'exercise', text: 'Ø³ÙˆÙŠØª Ø§ÙŠ Ø±ÙŠØ§Ø¶Ø© Ø§Ùˆ Ù…Ø¬Ù‡ÙˆØ¯ Ø¨Ø¯Ù†ÙŠ Ø§Ù…Ø³', options: ['Ø§ÙŠÙ‡ ØªÙ…Ø±Ù†Øª', 'Ù…Ø´ÙŠØª Ø´ÙˆÙŠ', 'Ù„Ø§ Ù…Ø§ ØªØ­Ø±ÙƒØª', 'Ø´ØºÙ„ Ø§Ù„Ø¨ÙŠØª Ø¨Ø³'] },
                { key: 'caffeine', text: 'Ø´Ø±Ø¨Øª Ù‚Ù‡ÙˆØ© Ø§Ùˆ Ø´Ø§Ù‡ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØºØ±Ø¨ Ø§Ù…Ø³', options: ['Ø§ÙŠÙ‡ Ø´Ø±Ø¨Øª ÙƒØ«ÙŠØ±', 'ÙƒÙˆØ¨ ÙˆØ§Ø­Ø¯ Ø¨Ø³', 'Ù„Ø§ Ù…Ø§ Ø´Ø±Ø¨Øª', 'Ù…Ø§ Ø§Ø°ÙƒØ±'] },
                { key: 'stress', text: 'Ù‡Ù„ Ø­Ø³ÙŠØª Ø¨Ø¶ØºØ· Ø§Ùˆ ØªÙˆØªØ± ÙƒØ¨ÙŠØ± Ø§Ù…Ø³', options: ['Ø§ÙŠÙ‡ Ù…Ø±Ù‡ ÙƒÙ†Øª Ù…Ø¶ØºÙˆØ·', 'Ø´ÙˆÙŠ Ø¨Ø³', 'Ù„Ø§ ÙŠÙˆÙ…ÙŠ ÙƒØ§Ù† Ù‡Ø§Ø¯ÙŠ', 'Ø¹Ø§Ø¯ÙŠ ÙŠØ¹Ù†ÙŠ'] },
            ];

            // --- START: Firestore Sleep Data Functions for REGISTERED users ---
            async function getSleepDataFromFirestore() {
                const user = auth.currentUser;
                if (!user || user.isAnonymous) return { log: [], analysis: null, askedQuestions: [] };
                const sleepDataRef = doc(db, "users", user.uid, "sleepData", "main");
                try {
                    const docSnap = await getDoc(sleepDataRef);
                    const defaultData = { log: [], analysis: null, askedQuestions: [] };
                    if (docSnap.exists()) {
                        return { ...defaultData, ...docSnap.data() };
                    }
                    return defaultData;
                } catch (error) {
                    console.error("Error getting sleep data from Firestore:", error);
                    return { log: [], analysis: null, askedQuestions: [] };
                }
            }

            async function saveSleepDataToFirestore(data) {
                const user = auth.currentUser;
                if (!user || user.isAnonymous) return;
                const sleepDataRef = doc(db, "users", user.uid, "sleepData", "main");
                try {
                    await setDoc(sleepDataRef, data);
                } catch (error) {
                    console.error("Error saving sleep data to Firestore:", error);
                }
            }
            // --- END: Firestore Sleep Data Functions ---

            // --- START: LocalStorage Sleep Data Functions for VISITORS ---
            function getSleepDataFromLocalStorage() {
                try {
                    const log = JSON.parse(localStorage.getItem('sleepLogData_v2')) || [];
                    const analysis = JSON.parse(localStorage.getItem('weeklySleepAnalysis_v2')) || null;
                    const askedQuestions = JSON.parse(localStorage.getItem('askedSleepQuestions_v2')) || [];
                    return { log, analysis, askedQuestions };
                } catch {
                    return { log: [], analysis: null, askedQuestions: [] };
                }
            }

            function saveSleepLogToLocalStorage(data) {
                localStorage.setItem('sleepLogData_v2', JSON.stringify(data));
            }

            function saveWeeklyAnalysisToLocalStorage(analysis) {
                 localStorage.setItem('weeklySleepAnalysis_v2', JSON.stringify(analysis));
            }

            function saveAskedQuestionsToLocalStorage(indices) {
                localStorage.setItem('askedSleepQuestions_v2', JSON.stringify(indices));
            }
            // --- END: LocalStorage Sleep Data Functions ---

            // --- START: Wrapper Functions ---
            async function getSleepLog() {
                const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    return data.log;
                } else {
                    return getSleepDataFromLocalStorage().log;
                }
            }

            async function saveSleepLog(newLog) {
                const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    data.log = newLog;
                    await saveSleepDataToFirestore(data);
                } else {
                    saveSleepLogToLocalStorage(newLog);
                }
            }
            
            async function getWeeklyAnalysis() {
                 const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    return data.analysis;
                } else {
                    return getSleepDataFromLocalStorage().analysis;
                }
            }

            async function saveWeeklyAnalysis(analysis) {
                 const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    data.analysis = analysis;
                    await saveSleepDataToFirestore(data);
                } else {
                    saveWeeklyAnalysisToLocalStorage(analysis);
                }
            }

            async function getAskedQuestions() {
                const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    return data.askedQuestions;
                } else {
                    return getSleepDataFromLocalStorage().askedQuestions;
                }
            }

            async function saveAskedQuestions(indices) {
                const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    data.askedQuestions = indices;
                    await saveSleepDataToFirestore(data);
                } else {
                   saveAskedQuestionsToLocalStorage(indices);
                }
            }
            // --- END: Wrapper Functions ---
            
            async function getSleepAIResponse(prompt) {
                 const fullPrompt = `Ø§Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…ØªØ®ØµØµ ÙÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†ÙˆÙ… Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø¹Ø§Ù…ÙŠØ© ÙˆÙ…Ù‡Ù…ØªÙƒ ØªØ¹Ø·ÙŠ Ù†ØµØ§ÙŠØ­ ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

                Ø´Ø±ÙˆØ·Ùƒ:
                1 ØªÙƒÙ„Ù… Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø¹Ø§Ù…ÙŠØ© ÙÙ‚Ø·
                2 Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ø¨Ø¯Ø§ Ø§ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ±Ù‚ÙŠÙ… Ù…Ø«Ù„ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ùˆ Ø§Ù„Ù†Ù‚Ø·Ø©
                3 Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ø¨Ø¯Ø§ Ø§ÙŠ Ø­Ø±ÙƒØ§Øª ØªØ´ÙƒÙŠÙ„ Ù…Ø«Ù„ Ø§Ù„ÙØªØ­Ø© Ø§Ùˆ Ø§Ù„Ø¶Ù…Ø©

                Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø·Ù„Ø¨:
                ${prompt}`;
                return await callGeminiAPI(fullPrompt);
            }

            function showSection(section) {
                logSection.classList.add('hidden-section');
                questionSection.classList.add('hidden-section');
                analysisSection.classList.add('hidden-section');
                section.classList.remove('hidden-section');
            }
            
            function formatTime12Hour(time24) {
                if (!time24) return '';
                let [hours, minutes] = time24.split(':');
                hours = parseInt(hours, 10);
                const period = hours >= 12 ? 'Ù…Ø³Ø§Ø¡' : 'ØµØ¨Ø§Ø­Ø§';
                hours = hours % 12 || 12; 
                return `${hours}:${minutes} ${period}`;
            }

            function calculateSleepDuration(sleepTime, wakeTime) {
                const sleep = new Date(`1970-01-01T${sleepTime}:00`);
                const wake = new Date(`1970-01-01T${wakeTime}:00`);

                if (wake <= sleep) {
                    wake.setDate(wake.getDate() + 1);
                }

                const diff = wake.getTime() - sleep.getTime();
                const totalHours = diff / (1000 * 60 * 60);
                const hours = Math.floor(totalHours);
                const minutes = Math.round((totalHours - hours) * 60);

                return {
                    decimal: parseFloat(totalHours.toFixed(1)),
                    formatted: `Ù†Ù…Øª Ù„Ù…Ø¯Ø© ${hours} Ø³Ø§Ø¹Ø§Øª Ùˆ ${minutes} Ø¯Ù‚Ø§ÙŠÙ‚`
                };
            }
            
            async function initSleepFeature() {
                const todayStr = new Date().toISOString().split('T')[0];
                const sleepLog = await getSleepLog();
                const todayEntry = sleepLog.find(entry => entry.date === todayStr);

                if (todayEntry) {
                    showSleepAnalysis();
                } else {
                    durationDisplay.classList.add('hidden-section');
                    showSection(logSection);
                }
            }
            
            cancelSleepTimeBtn.addEventListener('click', () => {
                sleepTimeInput.value = '';
                wakeTimeInput.value = '';
                durationDisplay.classList.add('hidden-section');
                showSection(logSection);
                 if(sleepPage) sleepPage.classList.remove('active');
                 if(homePage) homePage.classList.add('active');
            });


            submitSleepTimeBtn.addEventListener('click', () => {
                const sleepTime = sleepTimeInput.value;
                const wakeTime = wakeTimeInput.value;
                if (!sleepTime || !wakeTime) {
                    durationDisplay.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø¯Ø®Ø§Ù„ ÙˆÙ‚Øª Ø§Ù„Ù†ÙˆÙ… ÙˆØ§Ù„ØµØ­ÙŠØ§Ù†';
                    durationDisplay.classList.remove('hidden-section');
                    return;
                }
                const duration = calculateSleepDuration(sleepTime, wakeTime);
                durationDisplay.textContent = duration.formatted;
                durationDisplay.classList.remove('hidden-section');

                tempTimeData = { sleepTime, wakeTime, duration: duration.decimal };
                
                showDailyQuestion(tempTimeData);
            });
            
            async function showDailyQuestion(timeData) {
                let askedIndices = await getAskedQuestions();
                if (askedIndices.length >= dailyQuestions.length) {
                    askedIndices = []; // Reset if all questions asked
                }
                
                let nextQuestionIndex;
                do {
                    nextQuestionIndex = Math.floor(Math.random() * dailyQuestions.length);
                } while (askedIndices.includes(nextQuestionIndex));
                
                const question = dailyQuestions[nextQuestionIndex];
                questionTextEl.textContent = question.text;
                questionOptionsContainer.innerHTML = '';

                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'user-option-btn';
                    button.textContent = option;
                    button.onclick = () => {
                        handleDailyAnswer(timeData, question.key, option, nextQuestionIndex);
                    };
                    questionOptionsContainer.appendChild(button);
                });
                
                showSection(questionSection);
            }
            
            async function handleDailyAnswer(timeData, questionKey, answer, questionIndex) {
                let askedIndices = await getAskedQuestions();
                askedIndices.push(questionIndex);
                await saveAskedQuestions(askedIndices);
                
                const todayStr = new Date().toISOString().split('T')[0];
                const sleepLog = await getSleepLog();

                const newEntry = {
                    date: todayStr,
                    sleepTime: timeData.sleepTime,
                    wakeTime: timeData.wakeTime,
                    duration: timeData.duration,
                    dailyQuestion: {
                        key: questionKey,
                        answer: answer
                    }
                };

                const filteredLog = sleepLog.filter(entry => entry.date !== todayStr);
                const updatedLog = [...filteredLog, newEntry];
                await saveSleepLog(updatedLog);

                showSleepAnalysis(true); 
            }

            function showSleepAnalysis(forceRegenerate = false) {
                showSection(analysisSection);
                renderSleepChart();
                generateWeeklyAnalysis(forceRegenerate);
            }

            async function renderSleepChart() {
                const canvas = document.getElementById('sleepChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const sleepLog = (await getSleepLog()).slice(-7); 

                const labels = sleepLog.map(d => new Date(d.date).toLocaleDateString('ar-EG', { weekday: 'short' }));
                const durations = sleepLog.map(d => d.duration);

                if (sleepChartInstance) {
                    sleepChartInstance.destroy();
                }

                Chart.defaults.color = 'rgba(250, 250, 250, 0.7)';
                Chart.defaults.borderColor = 'rgba(250, 250, 250, 0.2)';
                
                sleepChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…',
                            data: durations,
                            backgroundColor: 'rgba(0, 168, 132, 0.6)',
                            borderColor: 'rgba(0, 168, 132, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                             tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        return sleepLog[index] ? new Date(sleepLog[index].date).toLocaleDateString('ar-EG', { weekday: 'long' }) : '';
                                    },
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const entry = sleepLog[index];
                                        if (!entry) return '';
                                        const sleep = formatTime12Hour(entry.sleepTime);
                                        const wake = formatTime12Hour(entry.wakeTime);
                                        return `Ù†Ù…Øª: ${sleep} - ØµØ­ÙŠØª: ${wake}`;
                                    },
                                     afterLabel: function(context) {
                                        return `Ø§Ù„Ù…Ø¯Ø©: ${context.raw} Ø³Ø§Ø¹Ø©`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            async function generateWeeklyAnalysis(forceRegenerate) {
                const sleepLog = (await getSleepLog()).slice(-7);
                
                if (sleepLog.length < 1) {
                    weeklyAnalysisContainer.textContent = 'Ù…Ø§ ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ø¹Ø·ÙŠÙƒ ØªØ­Ù„ÙŠÙ„ Ø§Ø¨Ø¯Ø£ Ø³Ø¬Ù„ Ù†ÙˆÙ…Ùƒ Ø§Ù„ÙŠÙˆÙ…';
                    return;
                }

                const lastEntryDate = sleepLog[sleepLog.length - 1].date;
                const cachedAnalysis = await getWeeklyAnalysis();

                if (!forceRegenerate && cachedAnalysis && cachedAnalysis.date === lastEntryDate) {
                    weeklyAnalysisContainer.textContent = cachedAnalysis.text;
                    analysisLastUpdatedEl.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„ØªØ­Ù„ÙŠÙ„: ${new Date(cachedAnalysis.timestamp).toLocaleString('ar-EG')}`;
                    return;
                }

                weeklyAnalysisContainer.innerHTML = `<div class="d-flex justify-content-center align-items-center p-4"><div class="spinner-border" role="status"></div></div>`;
                analysisLastUpdatedEl.textContent = '';
                
                const summary = sleepLog.map(d => `ÙÙŠ ÙŠÙˆÙ… ${new Date(d.date).toLocaleDateString('ar-EG', { weekday: 'long' })} Ù†Ù…Øª Ø§Ù„Ø³Ø§Ø¹Ø© ${d.sleepTime} ÙˆØµØ­ÙŠØª Ø§Ù„Ø³Ø§Ø¹Ø© ${d.wakeTime} ÙŠØ¹Ù†ÙŠ Ù†Ù…Øª ØªÙ‚Ø±ÙŠØ¨Ø§ ${d.duration} Ø³Ø§Ø¹Ø§Øª ÙˆØ¬Ø§ÙˆØ¨Øª Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù€ ${d.dailyQuestion.answer}`).join(' Ùˆ ');
                const prompt = `Ù‡Ø°Ø§ Ø³Ø¬Ù„ Ù†ÙˆÙ… ÙˆØ§Ø­Ø¯ Ù„Ù…Ø¯Ø© Ø§Ø³Ø¨ÙˆØ¹ ${summary} Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ù‡Ø°ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø·Ù†ÙŠ ØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø¹Ø§Ù…ÙŠØ© ÙˆØ¨Ø¯ÙˆÙ† Ø§ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ±Ù‚ÙŠÙ… Ø§Ùˆ ØªØ´ÙƒÙŠÙ„ ÙˆÙˆØ¶Ø­ Ù„Ù‡ Ù†Ù…Ø· Ù†ÙˆÙ…Ù‡ ÙˆØ§Ù„Ø§Ø´ÙŠØ§Ø¡ Ø§Ù„Ø§ÙŠØ¬Ø§Ø¨ÙŠØ© ÙˆØ§Ù„Ø³Ù„Ø¨ÙŠØ© ÙˆØ¹Ø·Ù‡ Ù†ØµØ§ÙŠØ­ Ø¹Ù…Ù„ÙŠØ© Ø¹Ø´Ø§Ù† ÙŠØ­Ø³Ù† Ù†ÙˆÙ…Ù‡ Ø§ÙƒØ«Ø±`;
                
                const analysisText = await getSleepAIResponse(prompt);

                const newAnalysis = {
                    date: lastEntryDate,
                    text: analysisText,
                    timestamp: new Date().toISOString()
                };
                
                await saveWeeklyAnalysis(newAnalysis);
                
                weeklyAnalysisContainer.textContent = analysisText;
                analysisLastUpdatedEl.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„ØªØ­Ù„ÙŠÙ„: Ø§Ù„Ø¢Ù†`;
            }

            sleepAiBtn.addEventListener('click', () => {
                initSleepFeature();
                sleepPage.classList.add('active');
            });

            backFromSleepBtn.addEventListener('click', () => {
                sleepPage.classList.remove('active');
            });
            // --- END: Sleep AI Logic ---
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(console.error);
            });
        }
    </script>
    
    <!-- Loading Spinner -->
    <div id="loading-spinner-overlay" class="loading-spinner-overlay">
        <div class="loading-spinner"></div>
    </div>
    <!-- End Loading Spinner -->
    
</body>
</html>
