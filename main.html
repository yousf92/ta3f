<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>الرئيسية | لا أبرح حتى أبلغ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- START: Added meta tags to prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- END: Added meta tags to prevent caching -->
    <!-- START: Added for Commitment Document -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- END: Added for Commitment Document -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #00a884;
            --danger-color: #ff5c5c;
            --background-color: #121212;
            --card-background: #1e1e1e;
            --text-color: #FAFAFA;
            --secondary-text-color: #CCCCCC;
            --border-color: #383838;
            --day-color: #86efac;
            --hour-color: #3b82f6;
            --minute-color: #ec4899;
            --second-color: #facc15;
            --progress-bg: rgba(0, 0, 0, 0.2);
        }
        body, html {
            margin: 0; padding: 0; font-family: 'Tajawal', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            position: fixed; width: 100%; height: 100%; overflow: hidden;
        }
        .page { display: none; flex-direction: column; height: 100%; width: 100%; }
        .page.active { display: flex; }
        .home-container { display: flex; flex-direction: column; height: 100vh; }
        .content-area { flex-grow: 1; overflow-y: auto; padding: 1rem; padding-bottom: 80px; }
        .top-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            background-color: rgba(18, 18, 18, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .header-icons { display: flex; gap: 1.5rem; font-size: 1.5rem; color: var(--secondary-text-color); align-items: center;}
        .header-icons i { cursor: pointer; }
        .header-icons a { color: var(--secondary-text-color); text-decoration: none; }
        .notification-icon-wrapper { position: relative; cursor: pointer; }
        .notification-badge { position: absolute; top: -2px; right: -5px; width: 10px; height: 10px; background-color: var(--danger-color); border-radius: 50%; border: 2px solid var(--background-color); display: none; }
        .welcome-message { text-align: right; }
        .welcome-message h5 { margin: 0; font-weight: 700; color: var(--text-color);}
        .welcome-message p { margin: 0; font-size: 0.9rem; color: var(--secondary-text-color); }
        .progress-timer-card { 
            background: linear-gradient(135deg, #054238, #008069); 
            color: white; 
            border-radius: 20px; 
            padding: 1.5rem; 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 10px 25px rgba(0, 128, 105, 0.3); 
            margin-bottom: 1.5rem;
            background-size: cover;
            background-position: center;
        }
        .timer-settings-icon { position: absolute; top: 1rem; left: 1rem; background-color: rgba(255, 255, 255, 0.15); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 10; }
        .progress-rows-container { position: relative; z-index: 5; margin-top: 2rem; }
        .progress-row { display: flex; align-items: center; background-color: var(--progress-bg); border-radius: 12px; padding: 0.7rem 1rem; margin-bottom: 0.8rem; position: relative; overflow: hidden; }
        .progress-row:last-child { margin-bottom: 0; }
        .progress-bar-fill { position: absolute; left: 0; top: 0; height: 100%; border-radius: 12px; transition: width 0.5s ease-in-out; }
        .progress-row .row-content { position: relative; z-index: 2; display: flex; width: 100%; align-items: center; justify-content: space-between; }
        .progress-row .time-label { font-weight: 700; font-size: 1rem; }
        .progress-row .time-icon { font-size: 1.2rem; }
        #days-fill { background-color: var(--day-color); }
        #hours-fill { background-color: var(--hour-color); }
        #minutes-fill { background-color: var(--minute-color); }
        #seconds-fill { background-color: var(--second-color); }
        .action-button { background-color: var(--card-background); border-radius: 15px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; text-decoration: none; color: var(--text-color); box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 1rem; font-weight: 500; border: 1px solid var(--border-color); width: 100%; }
        .action-button.najda-style { background-color: rgba(255, 92, 92, 0.1); color: var(--danger-color); border: 1px solid rgba(255, 92, 92, 0.5); justify-content: center; gap: 10px; font-size: 1.2rem; font-weight: 700; }
        .action-button.najda-style i { font-size: 1.5rem; }
        .bottom-nav { 
            display: flex; 
            justify-content: space-around; 
            padding: 0.5rem 0; 
            background-color: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2); 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            z-index: 100; 
            border-top: 1px solid rgba(56, 56, 56, 0.5); 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text-color); text-decoration: none; font-size: 0.75rem; cursor: pointer; width: 14%; height: 50px; justify-content: center; }
        .nav-item i { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.special-item { transform: translateY(-20px); position: relative; } 
        .special-item .icon-background { background: linear-gradient(135deg, #00a884, #00c896); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0, 168, 132, 0.4); }
        .special-item i { color: white; font-size: 2rem; margin: 0; }
        .chat-notification-badge {
            position: absolute;
            top: -8px; 
            right: 25px; 
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 13px;
            font-weight: bold;
            display: none; 
            justify-content: center;
            align-items: center;
            border: 2px solid var(--card-background);
            z-index: 1;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1050; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content-custom { background-color: var(--card-background); border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transform: scale(0.9); transition: transform 0.3s ease; width: 90%; max-width: 400px; }
        .modal-overlay.show .modal-content-custom { transform: scale(1); }
        #settings-modal-overlay { align-items: flex-end; }
        #settings-modal-content { background-color: var(--background-color); width: 100%; max-width: 800px; border-top-left-radius: 20px; border-top-right-radius: 20px; border-bottom-left-radius: 0; border-bottom-right-radius: 0; transform: translateY(100%); }
        #settings-modal-overlay.show #settings-modal-content { transform: translateY(0); }
        .modal-header-custom { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .modal-header-custom h5 { margin: 0; font-weight: 700; color: #FFFFFF; }
        .modal-header-custom i { font-size: 1.2rem; cursor: pointer; color: var(--secondary-text-color); }
        .modal-body-custom { padding: 1.5rem; }
        .icon-container.yellow { background-color: #fffbe6; color: #f9c74f; }
        .icon-container.blue { background-color: #e6f7ff; color: #34b7f1; }
        .icon-container.green { background-color: #e6f9f0; color: #00a884; }
        .icon-container.red { background-color: #ffebee; color: #ff5c5c; }
        .confirm-modal-body { text-align: center; padding: 2rem 1.5rem; }
        .confirm-modal-body .confirm-icon { font-size: 4rem; color: var(--text-color); margin-bottom: 1rem; }
        .confirm-modal-body p { font-size: 1.1rem; font-weight: 500; margin-bottom: 2rem; }
        .confirm-modal-footer { display: flex; gap: 1rem; padding: 0 1.5rem 1.5rem; }
        .confirm-btn { flex: 1; padding: 0.8rem; border-radius: 12px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; }
        .confirm-btn-accept { background-color: var(--primary-color); color: white; }
        .confirm-btn-cancel { background-color: var(--danger-color); color: white; }
        #breathing-circle-container { width: 200px; height: 200px; border: 5px solid rgba(255, 255, 255, 0.7); border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        #breathing-circle { width: 100%; height: 100%; background-color: white; border-radius: 50%; transform: scale(0.2); animation-duration: 19s; animation-iteration-count: infinite; animation-name: breathe; animation-timing-function: ease-in-out; }
        @keyframes breathe { 0% { transform: scale(0.2); } 21% { transform: scale(1); } 58% { transform: scale(1); } 100% { transform: scale(0.2); } }
        .notification-item { position: relative; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; padding-left: 30px; }
        .notification-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .notification-title { font-weight: 700; color: #FFFFFF; }
        .notification-body { color: var(--secondary-text-color); font-size: 0.9rem; }
        .notification-date { font-size: 0.8rem; color: #aaa; }
        .delete-notification-btn { position: absolute; left: 5px; top: 50%; transform: translateY(-50%); color: var(--danger-color); cursor: pointer; font-size: 1.2rem; display: none; }
        #quote-page { 
            justify-content: center; 
            align-items: center; 
            padding: 2rem; 
            text-align: center; 
            color: white; 
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out;
        }
        .quote-box { position: relative; background-color: rgba(0, 0, 0, 0.4); border: 2px solid rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 25px; padding: 4rem 2rem; width: 100%; max-width: 500px; }
        .quote-box::before, .quote-box::after { font-family: serif; font-size: 6rem; font-weight: bold; color: white; position: absolute; opacity: 0.8; }
        .quote-box::before { content: '”'; top: -1.5rem; right: 1rem; }
        .quote-box::after { content: '“'; bottom: -4.5rem; left: 1rem; }
        .top-indicator-bar { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 35%; max-width: 150px; height: 5px; background-color: white; border-radius: 5px; opacity: 0.7; }
        #quote-text { font-size: 1.5rem; font-weight: 700; line-height: 1.7; text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); }
        #close-quote-btn { position: absolute; top: 20px; left: 20px; font-size: 1.8rem; cursor: pointer; z-index: 10; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .card-title { font-weight: 700; color: #FFFFFF; }
        .modal-title { color: #FFFFFF; }
        #notifications-modal .modal-content, #achievementsModal .modal-content, #congratsAchievementModal .modal-content, #userAchievementsModal .modal-content { background-color: var(--background-color); color: var(--text-color); }
        #notifications-modal .modal-header, #achievementsModal .modal-header, #congratsAchievementModal .modal-header, #userAchievementsModal .modal-header { border-bottom: 1px solid var(--border-color); }
        #notifications-modal .btn-close, #achievementsModal .btn-close, #congratsAchievementModal .btn-close, #userAchievementsModal .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .action-button.najda-style .bi-fire { animation: fire-flicker 1.5s ease-in-out infinite alternate; position: relative; top: 3px; }
        @keyframes fire-flicker { 0% { transform: scale(1.0) translateY(0) rotate(0); color: #ffad00; text-shadow: 0 0 4px #ff5c5c, 0 0 8px #ff5c5c, 0 0 12px #ffad00; } 25% { transform: scale(1.1) translateY(-2px) rotate(3deg); color: #facc15; text-shadow: 0 0 6px #ff5c5c, 0 0 10px #ff5c5c, 0 0 16px #facc15; } 50% { transform: scale(0.95) translateY(1px) rotate(-2deg); color: var(--danger-color); text-shadow: 0 0 4px #ff5c5c, 0 0 8px #ff5c5c, 0 0 12px #ffad00; } 75% { transform: scale(1.05) translateY(-1px) rotate(2deg); color: #facc15; text-shadow: 0 0 6px #ff5c5c, 0 0 12px #ff5c5c, 0 0 18px #facc15; } 100% { transform: scale(1.0) translateY(0) rotate(0); color: #ffad00; text-shadow: 0 0 4px #ff5c5c, 0 0 8px #ff5c5c, 0 0 12px #ffad00; } }
        .fire-alarm { width: 28px; height: 24px; position: relative; }
        .fire-alarm-dome { width: 100%; height: 20px; position: absolute; top: 0; left: 0; background: radial-gradient(circle at 50% 0%, #ff8a8a, #d10000 90%); border-radius: 14px 14px 3px 3px; overflow: hidden; z-index: 2; border: 1px solid #ff5c5c; }
        .fire-alarm-dome::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: repeating-linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 0px, rgba(255, 255, 255, 0.15) 1px, transparent 1px, transparent 3px); z-index: 3; }
        .fire-alarm-dome::after { content: ''; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,220,150,0.9) 0%, rgba(255,100,100,0) 35%); border-radius: 50%; transform: translate(-50%, -50%); animation: beacon-flash 1.2s infinite ease-in-out; z-index: 4; }
        .fire-alarm-base { width: 28px; height: 5px; background: linear-gradient(to top, #c00000, #e02020); position: absolute; bottom: 0; left: 0; border-radius: 0 0 4px 4px; z-index: 1; box-shadow: 0 2px 3px rgba(0,0,0,0.5); }
        @keyframes beacon-flash { 0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        .image-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            border-radius: 20px; 
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        .image-background.visible {
            opacity: 1;
        }
        .image-background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.45); 
            z-index: 2;
            border-radius: 20px; 
            display: none; 
            transition: opacity 0.5s ease-in-out;
        }
         .image-background-overlay.visible {
            display: block;
        }
        #app-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(18, 18, 18, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .lock-container {
            text-align: center;
            padding: 2rem;
            background-color: var(--card-background);
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }
        .lock-container .icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        #passcode-input {
            max-width: 200px;
            margin: 1.5rem auto;
            letter-spacing: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
            direction: ltr;
        }
        #passcode-input::placeholder {
            letter-spacing: normal;
        }
        #unlock-btn {
            width: 100%;
            max-width: 200px;
        }
        #passcode-error {
            display: none;
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        #ai-advice-card {
            position: relative;
            background-size: cover;
            background-position: center;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            overflow: hidden;
            transition: background-image 0.5s ease-in-out;
            margin-top: 1rem;
        }
        #ai-advice-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 1;
        }
        #ai-advice-content {
            position: relative;
            z-index: 2;
        }
        #ai-advice-text {
            font-size: 1.1rem;
            font-weight: 500;
            line-height: 1.8;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
        #ai-advice-refresh-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 3;
            font-size: 1.4rem;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        #ai-advice-refresh-btn:hover {
            transform: rotate(90deg);
            background-color: rgba(255, 255, 255, 0.2);
        }
        .spinner-grow-sm {
            width: 1rem;
            height: 1rem;
        }
        #inspiration-display, #salaf-story-display {
            position: relative;
            background-size: cover;
            background-position: center;
            color: white;
            overflow: hidden;
            transition: background-image 0.5s ease-in-out;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }
        #inspiration-display::before, #salaf-story-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 1;
            border-radius: 15px;
        }
        #inspiration-text, #salaf-story-text {
            position: relative;
            z-index: 2;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
        body.solid-black-bg {
            background-image: none !important;
            background-color: #000000 !important;
        }
        body.gradient-blue-bg {
            background-image: linear-gradient(135deg, #0f2027, #203a43, #2c5364) !important;
        }
        /* START: Achievement Styles */
        #achievements-grid, #user-achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        .achievement-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            transition: all 0.4s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .achievement-card-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #facc15; /* Gold */
            text-shadow: 0 0 15px rgba(250, 204, 21, 0.5);
        }
        .achievement-card-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }
        .achievement-card-date {
            font-size: 0.75rem;
            color: var(--secondary-text-color);
        }
        .achievement-card.locked {
            background-color: rgba(30, 30, 30, 0.7);
            border-color: #383838;
            color: #888;
            box-shadow: none;
            filter: grayscale(80%);
        }
        .achievement-card.locked .achievement-card-icon {
            color: #555;
            text-shadow: none;
        }
        #congrats-modal-body {
            text-align: center;
            padding: 2rem 1.5rem;
        }
        #congrats-icon {
            font-size: 5rem;
            color: #facc15; /* Gold color */
            margin-bottom: 1rem;
            animation: tada 1.5s ease-in-out;
        }
        @keyframes tada {
            from { transform: scale3d(1, 1, 1); }
            10%, 20% { transform: scale3d(0.9, 0.9, 0.9) rotate3d(0, 0, 1, -3deg); }
            30%, 50%, 70%, 90% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg); }
            40%, 60%, 80% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg); }
            to { transform: scale3d(1, 1, 1); }
        }
        #congrats-text {
            font-size: 1.2rem;
            font-weight: 700;
        }
        #congrats-user-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        /* END: Achievement Styles */

        /* START: Leaderboard Styles */
        #leaderboardModal .modal-content {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        #leaderboardModal .modal-header {
            border-bottom: 1px solid var(--border-color);
        }
        #leaderboardModal .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .leaderboard-item:hover {
            transform: translateY(-2px);
        }
        .leaderboard-rank {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--secondary-text-color);
            width: 35px;
            text-align: center;
        }
        .leaderboard-user-pic {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 1rem;
            border: 2px solid var(--border-color);
        }
        .leaderboard-user-info {
            flex-grow: 1;
            overflow: hidden;
        }
        .leaderboard-user-name {
            font-weight: 700;
            margin: 0;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .leaderboard-user-days {
            margin: 0;
            color: var(--primary-color);
            font-size: 0.9rem;
            font-weight: 500;
        }
        .leaderboard-delete-btn {
            color: var(--danger-color);
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        .leaderboard-delete-btn:hover {
            opacity: 1;
        }
        .leaderboard-restore-btn {
            color: var(--day-color); /* Greenish color */
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        .leaderboard-restore-btn:hover {
            opacity: 1;
        }
        .leaderboard-item.rank-1, .leaderboard-item.rank-2, .leaderboard-item.rank-3 {
            border-width: 2px;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .leaderboard-item.rank-1 { border-color: #FFD700; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), var(--card-background)); }
        .leaderboard-item.rank-2 { border-color: #C0C0C0; background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), var(--card-background)); }
        .leaderboard-item.rank-3 { border-color: #CD7F32; background: linear-gradient(135deg, rgba(205, 127, 50, 0.1), var(--card-background)); }
        .leaderboard-rank-medal {
            font-size: 2rem;
            width: 35px;
            text-align: center;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
        }
        .loading-spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        #leaderboard-footer-user-rank {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 700;
            border-top: 1px solid var(--border-color);
            border-bottom-left-radius: var(--bs-modal-inner-border-radius);
            border-bottom-right-radius: var(--bs-modal-inner-border-radius);
            margin: 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        #leaderboardModal .nav-tabs {
            border-bottom: none;
        }
        #leaderboardModal .nav-link {
            border: none;
            background: none;
            color: var(--secondary-text-color);
            width: 50%;
            text-align: center;
            font-size: 0.9rem;
            padding: 0.75rem 0.5rem;
        }
        #leaderboardModal .nav-link.active {
            background-color: var(--card-background);
            color: var(--primary-color);
            font-weight: 700;
            border-radius: 8px;
        }
        /* END: Leaderboard Styles */

        /* START: Added for Commitment Document */
        .action-button.commitment-style {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: 1px solid rgba(124, 58, 237, 0.7);
            justify-content: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .action-button.commitment-style i {
            font-size: 1.5rem;
        }

        #commitment-document-page {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f7f6;
            overflow-y: auto;
            position: relative;
        }
        #commitment-document-page .form-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            color: #374151;
        }
        #commitment-document-page textarea {
            resize: vertical;
            min-height: 120px;
        }
        #commitment-document-page .main-title { color: #108a71; }
        #commitment-document-page .edit-title { color: #0d9488; }
        #commitment-document-page .btn-save { background-color: #10b981; transition: background-color 0.3s; }
        #commitment-document-page .btn-save:hover { background-color: #059669; }
        #commitment-document-page .btn-edit { background-color: #0d9488; transition: background-color 0.3s; }
        #commitment-document-page .btn-edit:hover { background-color: #0f766e; }
        #commitment-document-page .btn-delete { background-color: #dc2626; transition: background-color 0.3s; }
        #commitment-document-page .btn-delete:hover { background-color: #b91c1c; }
        #commitment-document-page .btn-update { background-color: #0d9488; transition: background-color 0.3s; }
        #commitment-document-page .btn-update:hover { background-color: #0f766e; }

        #commitment-document-page #document-page {
            background-color: #f8fafc;
        }
        #commitment-document-page .document-container {
            background-color: white;
            border-radius: 1rem;
            padding: 2.5rem 3rem;
            margin: 2rem auto;
            max-width: 800px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.08), 0 8px 10px -6px rgb(0 0 0 / 0.08);
            border-top: 6px solid #10b981;
        }
        #commitment-document-page #document-content {
            color: #374151;
            font-size: 1.1rem;
            line-height: 2.2;
        }
        #commitment-document-page .icon {
            width: 24px;
            height: 24px;
            margin-left: 8px;
        }
        @media (max-width: 768px) {
            #commitment-document-page .document-container { padding: 2rem; }
            #commitment-document-page #document-content { font-size: 1rem; line-height: 2; }
        }
        @media (max-width: 480px) {
            #commitment-document-page #document-page { padding: 1rem 0.5rem; }
            #commitment-document-page .document-container { padding: 1.5rem; margin: 1rem auto; }
            #commitment-document-page #document-content { font-size: 0.95rem; line-height: 1.9; }
        }
        /* END: Added for Commitment Document */

        /* -- START: Animations for Commitment Document -- */
        #commitment-document-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            transform: translateY(100%);
            visibility: hidden;
            transition: transform 0.4s ease-in-out, visibility 0s 0.4s;
        }
        #commitment-document-page.page.active {
            transform: translateY(0);
            visibility: visible;
            transition: transform 0.4s ease-in-out;
            display: block !important;
        }
        #form-page, #document-page, #edit-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out, visibility 0s 0.3s;
            overflow-y: auto;
        }
        #form-page.visible, #document-page.visible, #edit-page.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transition: opacity 0.3s ease-in-out;
        }
        /* -- END: Animations for Commitment Document -- */

        /* -- START: Custom Modal Animation -- */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
        /* -- END: Custom Modal Animation -- */

        /* START: Loading Spinner Styles */
        .loading-spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .loading-spinner-overlay.show {
            display: flex;
            opacity: 1;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 7px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* END: Loading Spinner Styles */

        /* START: Sleep Improvement Styles */
        .action-button.sleep-style {
            background: linear-gradient(135deg, #2c3e50, #4b79a1);
            color: white;
            border: 1px solid rgba(75, 121, 161, 0.7);
            justify-content: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .action-button.sleep-style i {
            font-size: 1.5rem;
        }
        #sleep-improvement-page {
            background-color: var(--background-color);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1100;
            transform: translateX(100%);
            transition: transform 0.4s ease-in-out;
            display: flex !important;
            flex-direction: column;
        }
        #sleep-improvement-page.active {
            transform: translateX(0);
        }
        .sleep-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            flex-shrink: 0;
        }
        .sleep-header h5 {
            margin: 0;
            font-weight: 700;
        }
        #back-to-home-from-sleep-btn {
            font-size: 1.5rem;
            cursor: pointer;
        }
        .sleep-content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        .sleep-card {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .sleep-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .time-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .time-input-container {
            flex: 1;
        }
        .time-input-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--secondary-text-color);
        }
        .time-input-container input[type="time"] {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-color);
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
        }
        .user-option-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.8rem 1rem;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
            width: 100%;
        }
        .user-option-btn:hover {
            background-color: #008a70;
        }
        .daily-question-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .daily-question-options .user-option-btn {
            flex-grow: 1;
            width: auto;
        }
        #sleep-duration-display {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--secondary-text-color);
            margin-bottom: 1.5rem;
        }
        #sleep-chart-container {
            padding: 1rem;
            background-color: var(--card-background);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            height: 300px;
        }
        #weekly-analysis-container {
            min-height: 150px;
            line-height: 1.8;
            font-size: 1.05rem;
        }
        .last-updated-text {
            font-size: 0.8rem;
            color: #888;
            margin-top: 1rem;
            text-align: left;
        }
        .hidden-section {
            display: none;
        }
        /* END: Sleep Improvement Styles */
    </style>
</head>
<body style="visibility: hidden;">
    <div id="app-lock-overlay">
        <div class="lock-container">
            <i class="bi bi-shield-lock-fill icon"></i>
            <h5>التطبيق مقفل</h5>
            <p class="text-secondary small">أدخل رمز المرور للمتابعة</p>
            <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="form-control" id="passcode-input" placeholder="----">
            <div id="passcode-error">رمز المرور غير صحيح</div>
            <button id="unlock-btn" class="btn btn-primary mt-2">فتح القفل</button>
        </div>
    </div>

    <div id="home-page" class="page active">
        <div class="home-container">
            <header class="top-header">
                <div class="header-icons">
                    <i class="bi bi-trophy-fill" data-bs-toggle="modal" data-bs-target="#achievementsModal"></i>
                    <i class="bi bi-bar-chart-steps" data-bs-toggle="modal" data-bs-target="#leaderboardModal"></i>
                    <div class="notification-icon-wrapper" data-bs-toggle="modal" data-bs-target="#notifications-modal">
                        <i class="bi bi-bell-fill"></i>
                        <span class="notification-badge"></span>
                    </div>
                    <a href="settings.html"><i class="bi bi-person-circle"></i></a>
                </div>
                <div class="welcome-message">
                    <h5 id="welcome-user"></h5>
                    <p id="current-date"></p>
                </div>
            </header>
            <main class="content-area">
                <div class="progress-timer-card">
                    <div class="image-background-overlay"></div>
                    <img class="image-background" id="counter-image-bg" src="" alt="Background">
                    <div class="timer-settings-icon d-none"><i class="bi bi-gear-fill"></i></div>
                    <div class="progress-rows-container">
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="days-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="days-value">0</span> أيام</span>
                                <i class="bi bi-calendar-check-fill time-icon"></i>
                            </div>
                        </div>
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="hours-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="hours-value">0</span> ساعات</span>
                                <i class="bi bi-clock-fill time-icon"></i>
                            </div>
                        </div>
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="minutes-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="minutes-value">0</span> دقائق</span>
                                <i class="bi bi-clock-history time-icon"></i>
                            </div>
                        </div>
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="seconds-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="seconds-value">0</span> ثواني</span>
                                <i class="bi bi-hourglass-split time-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                 <div id="inspiration-container" class="mb-3">
                    <button id="inspiration-btn" class="action-button" style="justify-content: center; text-align: center; gap: 10px; font-weight: 700; width: 100%;">
                        <span>🔥عندي رغبة شديدة،أعطني حلا جذريا🔥</span>
                    </button>
                    <div id="inspiration-display" class="p-3 mt-2 d-none" style="background-color: var(--card-background); border-radius: 15px; border: 1px solid var(--border-color);">
                        <p id="inspiration-text" class="mb-0"></p>
                    </div>
                </div>

                <!-- START: New Salaf Story Button -->
                <div id="salaf-story-container" class="mb-3">
                    <button id="salaf-story-btn" class="action-button" style="justify-content: center; text-align: center; gap: 10px; font-weight: 700; width: 100%; background: linear-gradient(135deg, #4a90e2, #50e3c2); border: 1px solid #4a90e2;">
                        <span>📖 عطني جرعة إيمانية من قصص السلف</span>
                    </button>
                    <div id="salaf-story-display" class="p-3 mt-2 d-none" style="background-color: var(--card-background); border-radius: 15px; border: 1px solid var(--border-color);">
                        <p id="salaf-story-text" class="mb-0"></p>
                    </div>
                </div>
                <!-- END: New Salaf Story Button -->

                <button id="start-timer-btn" class="btn btn-success btn-lg w-100 mb-3 d-none">بدء العداد</button>
                <button id="najda-button" class="action-button najda-style">
                    <i class="bi bi-fire"></i>
                    <span>النجدة!</span>
                    <div class="fire-alarm">
                        <div class="fire-alarm-dome"></div>
                        <div class="fire-alarm-base"></div>
                    </div>
                </button>
                <!-- START: Added Button -->
                <button id="commitment-btn" class="action-button commitment-style">
                    <i class="bi bi-file-text-fill"></i>
                    <span>وثيقة الإلتزام</span>
                </button>
                <!-- END: Added Button -->

                <!-- START: New Sleep AI Button -->
                <button id="sleep-ai-btn" class="action-button sleep-style">
                    <i class="bi bi-moon-stars-fill"></i>
                    <span>نومك مخربط؟ تعال أساعدك</span>
                </button>
                <!-- END: New Sleep AI Button -->
<!-- START: Mohammed Abdullah Way Button -->
<button class="action-button" data-bs-toggle="modal" data-bs-target="#mohammedAbdullahWayModal" style="background: linear-gradient(135deg, #8E44AD, #3498DB); border-color: #8E44AD; justify-content: center; gap: 10px; font-weight: 700;">
    <i class="bi bi-compass-fill"></i>
    <span>طريق محمد عبدالله لترك الإدمان</span>
</button>
<!-- END: Mohammed Abdullah Way Button -->
<!-- START: Mohammed Abdullah Way Modal -->
<div class="modal fade" id="mohammedAbdullahWayModal" tabindex="-1" aria-labelledby="mohammedAbdullahWayModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="background-color: var(--background-color); color: var(--text-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" id="mohammedAbdullahWayModalLabel">خطوات محمد عبدالله لترك الإباحية</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1) grayscale(100%) brightness(200%);"></button>
            </div>
            <div class="modal-body">
                <p>دايم يسألوني محمد عبدالله كيف تركت الاباحية. أولاً بفضل الله علي ثم بخطوات برسلها الان بتفيدك لتجعل الاقلاع بطريقه سهله.</p>
                <ol style="line-height: 2.2; padding-right: 1.5rem;">
                    <li class="mb-3">اعلم يقيناً بداخلك انك تستطيع تركها، أنت لست مختلفاً عن الاخرين.</li>
                    <li class="mb-3">ليس هناك اي شي تخسره بل العكس هناك الكثير من المكاسب.</li>
                    <li class="mb-3">مافيه شي اسمه "زله واحده" لان الزله بتجر الانتكاسه.</li>
                    <li class="mb-3">لا تنظر للاباحيه انها عاده عاديه، انظر لها انها ماده ادمانيه تجلب الدمار.</li>
                    <li class="mb-3">لا تجعل محاولتك مشكوكه، خلك عندك يقين انها محاولتك الاخيره وانك ستنجح فيها 🤍.</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<!-- END: Mohammed Abdullah Way Modal -->

            </main>
            <nav class="bottom-nav">
                <a href="main.html" class="nav-item active"><i class="bi bi-house-door-fill"></i><span>الرئيسية</span></a>
                <a href="diaries.html" class="nav-item"><i class="bi bi-book-fill"></i><span>اليوميات</span></a>
                <a href="articles.html" class="nav-item"><i class="bi bi-check2-square"></i><span>العادات</span></a>
                <a href="chat.html" class="nav-item special-item">
                    <div class="icon-background"><i class="bi bi-chat-dots-fill"></i></div>
                    <span>دردشة</span>
                    <span class="chat-notification-badge"></span>
                </a>
                <a href="follow-up.html" class="nav-item"><i class="bi bi-signpost-split-fill"></i><span>المتابعة</span></a>
                <a href="library.html" class="nav-item"><i class="bi bi-collection-fill"></i><span>المكتبة</span></a>
                <a href="settings.html" class="nav-item"><i class="bi bi-gear-fill"></i><span>الاعدادات</span></a>
            </nav>
        </div>
    </div>
    
    <div id="breathing-page" class="page" style="background: linear-gradient(to top, #28b485, #7ed56f); justify-content: center; align-items: center; text-align: center; color: white; padding: 1rem;">
        <i class="bi bi-x-lg" id="close-breathing-btn" style="position: absolute; top: 20px; right: 20px; font-size: 1.8rem; cursor: pointer; z-index: 10;"></i>
        <div id="breathing-circle-container"><div id="breathing-circle"></div></div>
        <h1 id="breathing-text" style="font-size: 4rem; margin-top: 2rem; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">شهيق</h1>
        <div id="breathing-timer" style="font-size: 1.5rem; color: white; margin-top: 1rem; font-weight: bold;"></div>
        <button id="skip-to-quote-btn" class="btn btn-outline-light mt-4">الانتقال إلى الاقتباس <i class="bi bi-arrow-left-short"></i></button>
        <p style="font-size: 1.1rem; max-width: 300px; margin-top: 1.5rem;">خذ دقيقة من وقتك للتنفس حيث يساعدك على تهدئة عقلك</p>
    </div>

    <div id="quote-page" class="page">
        <div class="top-indicator-bar"></div>
        <i class="bi bi-x-lg" id="close-quote-btn"></i>
        <div class="quote-box">
            <p id="quote-text"></p>
        </div>
    </div>

    <!-- START: Commitment Document Page -->
    <div id="commitment-document-page" class="page">
        <button id="back-to-home-btn" style="position: fixed; top: 20px; left: 20px; z-index: 1000; background: rgba(0,0,0,0.2); border: none; color: #333; border-radius: 50%; width: 44px; height: 44px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;">
            <i class="bi bi-arrow-right-circle-fill"></i>
        </button>
        
        <!-- Page 1: Create Form -->
        <div id="form-page">
            <div class="min-h-screen py-8">
                <div class="container mx-auto p-4 md:p-8 max-w-4xl">
                    <header class="text-center mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold main-title mb-2">وثيقة الإلتزام</h1>
                        <p class="text-lg text-gray-600">راجع الوثيقة يومياً، ستساعدك كثيراً على تذكير وتحفيز نفسك باستمرار!</p>
                    </header>
                    
                    <form id="commitment-form">
                        <div class="form-card"><label for="damages" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>ما هي أضرار الإدمان التي أصابتك؟</label><p class="text-gray-500 mb-4">اكتب أضرار حقيقية أثرت بك وجعلتك تفكر جديا بالتعافي، أضرار على صحتك الدينية والنفسية والبدنية والاجتماعية والعقلية.</p><textarea id="damages" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="fears" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"></path></svg>ماهي مخاوفك الشخصية من ترك هذه العادة؟</label><p class="text-gray-500 mb-4">اكتب مخاوفك التي توهمك بأنك تحتاج لتلك العادة مثل أنه لا حل إلا بالزواج أو أن تركها يسبب خلل جنسي أو أن التعافي مستحيل.</p><textarea id="fears" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="responses" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.311a7.5 7.5 0 0 1-7.5 0c-1.421-.492-2.682-.998-3.624-1.516a6.002 6.002 0 0 1-1.49-1.84c-.31-1.024-.23-2.111.22-3.084.45-.972 1.165-1.823 2.06-2.502a12.022 12.022 0 0 1 1.732-1.041"></path></svg>بماذا ترد على مخاوفك بشكل منطقي؟</label><p class="text-gray-500 mb-4">اكتب ما تعرفه من ردود منطقية لتذكر بها نفسك عندما تنسى أو تضعف.</p><textarea id="responses" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="benefits" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-6.75c-.621 0-1.125.504-1.125 1.125v3.375m9 0h-9"></path></svg>ماهي فوائد التعافي التي تطمح لاكتسابها؟</label><p class="text-gray-500 mb-4">اكتب فوائد حقيقية وواقعية يمكن اكتسابها تدريجيا بالتعافي.</p><textarea id="benefits" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="escape-plan" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"></path></svg>ماهي خطة هروبك عند هجوم الرغبة الملحة؟</label><p class="text-gray-500 mb-4">ضع عادات سريعة وقصيرة، مثل تجنب الهاتف، ومغادرة الغرفة، تمارين رياضية، استحمام، وغيرها من عادات تشغلك عن التفكير بالزلل.</p><textarea id="escape-plan" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <div class="form-card"><label for="message" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75"></path></svg>اكتب رسالة منك لنفسك.</label><p class="text-gray-500 mb-4">تمهل قليلا وتفكر.. اجعلها مؤثرة تلامس عقلك وقلبك وروحك..</p><textarea id="message" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea></div>
                        <button type="submit" class="w-full btn-save text-white font-bold py-4 px-4 rounded-lg text-xl">حفظ</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Page 2: View Document -->
        <div id="document-page" class="hidden">
            <div class="min-h-screen flex flex-col justify-center items-center py-8 px-4">
                 <div class="document-container">
                    <div id="document-content" class="text-justify">
                        <p class="text-center text-2xl font-bold mb-6">بسم الله الرحمن الرحيم</p>
                        <p class="mb-5">بإدراكي العميق لمعاناة حياتي تحت وطأة الإدمان وآثاره السلبية على صحتي وعلاقاتي ومستقبلي، أقر وألتزم أمام الله ثم نفسي بهذه الوثيقة لتحقيق التعافي والعودة إلى حياة مليئة بالأمل والإنجاز.</p>
                        <p class="mb-5">أقر بأن الإدمان قد ترك أثراً بالغاً في حياتي بكثير من الأضرار أبرزها: <strong id="damages-output" class="font-semibold"></strong></p>
                        <p class="mb-5">أعلم أن قرار التغيير ليس سهلا لكن سأتحمل الصعاب بإذن الله لأني أريد أن أصبح إنسانا جديدا مما يستلزم أن أطرح بكل شفافية مخاوفي الشخصية من ترك هذه العادة المدمرة وهذه المخاوف تتمثل بـ: <strong id="fears-output" class="font-semibold"></strong></p>
                        <p class="mb-5">ولكن جميع هذه المخاوف أوهام كاذبة وحبال يتوجب علي قطعها لأزيح صخرة الإدمان من حياتي و سأرد عليها منطقيا بالتالي: <strong id="responses-output" class="font-semibold"></strong></p>
                        <p class="mb-5">إن التعافي بالنسبة لي هو رحلة نحو استعادة الذات والعيش بكرامة ومسؤولية، وأطمح من خلاله إلى تحقيق الفوائد التالية: <strong id="benefits-output" class="font-semibold"></strong></p>
                        <p class="mb-5">وفي سبيل كل ما سبق ولأني علمت يقينا بأن الدماغ يكون بحالة سكر وضعف اتخاذ القرارات الصحيحة عند هجوم الرغبة الملحة وأعراض الانسحاب ولأن التعافي يستحق فإنني سألتزم بخطة الهروب التالية مباشرة عند ظهور أية بوادر إدمانية حيث سأقوم بالتالي: <strong id="escape-plan-output" class="font-semibold"></strong></p>
                        <p class="mb-5">وختاماً فهذه رسالة إلى نفسي التواقة للصلاح والإصلاح إلى تلك النفس الطيبة التائبة لمولاها جل وعلا: <strong id="message-output" class="font-semibold"></strong></p>
                        <div class="mt-12 text-left"><p class="font-bold">التوقيع: <span id="user-signature"></span></p><p class="font-bold">التاريخ: <span id="current-date-doc"></span></p></div>
                    </div>
                </div>
                <div class="flex justify-center items-center space-x-4 space-x-reverse py-8">
                    <button id="edit-btn" class="flex items-center justify-center btn-edit text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg><span>تعديل</span></button>
                    <button id="delete-btn" class="flex items-center justify-center btn-delete text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span>حذف</span></button>
                </div>
            </div>
        </div>

        <!-- Page 3: Edit Form -->
        <div id="edit-page" class="hidden">
            <div class="min-h-screen py-8">
                <div class="container mx-auto p-4 md:p-8 max-w-4xl">
                     <header class="text-center mb-8">
                        <h1 class="text-4xl md:text-5xl font-bold edit-title mb-2">تعديل وثيقة الإلتزام</h1>
                        <p class="text-lg text-gray-600">قم بمراجعة وتحديث التزاماتك وأهدافك.</p>
                    </header>
                    <form id="commitment-form-edit">
                        <div class="form-card"><label for="edit-damages" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>ما هي أضرار الإدمان التي أصابتك؟</label><p class="text-gray-500 mb-4">اكتب أضرار حقيقية أثرت بك وجعلتك تفكر جديا بالتعافي، أضرار على صحتك الدينية والنفسية والبدنية والاجتماعية والعقلية.</p><textarea id="edit-damages" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-fears" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"></path></svg>ماهي مخاوفك الشخصية من ترك هذه العادة؟</label><p class="text-gray-500 mb-4">اكتب مخاوفك التي توهمك بأنك تحتاج لتلك العادة مثل أنه لا حل إلا بالزواج أو أن تركها يسبب خلل جنسي أو أن التعافي مستحيل.</p><textarea id="edit-fears" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-responses" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.311a7.5 7.5 0 0 1-7.5 0c-1.421-.492-2.682-.998-3.624-1.516a6.002 6.002 0 0 1-1.49-1.84c-.31-1.024-.23-2.111.22-3.084.45-.972 1.165-1.823 2.06-2.502a12.022 12.022 0 0 1 1.732-1.041"></path></svg>بماذا ترد على مخاوفك بشكل منطقي؟</label><p class="text-gray-500 mb-4">اكتب ما تعرفه من ردود منطقية لتذكر بها نفسك عندما تنسى أو تضعف.</p><textarea id="edit-responses" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-benefits" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-6.75c-.621 0-1.125.504-1.125 1.125v3.375m9 0h-9"></path></svg>ماهي فوائد التعافي التي تطمح لاكتسابها؟</label><p class="text-gray-500 mb-4">اكتب فوائد حقيقية وواقعية يمكن اكتسابها تدريجيا بالتعافي.</p><textarea id="edit-benefits" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-escape-plan" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"></path></svg>ماهي خطة هروبك عند هجوم الرغبة الملحة؟</label><p class="text-gray-500 mb-4">ضع عادات سريعة وقصيرة، مثل تجنب الهاتف، ومغادرة الغرفة، تمارين رياضية، استحمام، وغيرها من عادات تشغلك عن التفكير بالزلل.</p><textarea id="edit-escape-plan" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        <div class="form-card"><label for="edit-message" class="flex items-center text-xl font-bold text-gray-700 mb-2"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75"></path></svg>اكتب رسالة منك لنفسك.</label><p class="text-gray-500 mb-4">تمهل قليلا وتفكر.. اجعلها مؤثرة تلامس عقلك وقلبك وروحك..</p><textarea id="edit-message" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea></div>
                        
                        <button type="submit" class="w-full btn-update text-white font-bold py-4 px-4 rounded-lg text-xl">حفظ التعديلات</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Commitment Document Page -->

    <!-- START: Sleep Improvement Page -->
    <div id="sleep-improvement-page" class="page">
        <header class="sleep-header">
            <i class="bi bi-arrow-right" id="back-to-home-from-sleep-btn"></i>
            <h5>مساعد النوم الذكي</h5>
            <div style="width: 24px;"></div> <!-- Spacer -->
        </header>
        <main class="sleep-content-area">
            <!-- Section for daily sleep logging -->
            <div id="sleep-log-section" class="sleep-card">
                <h2 class="sleep-card-title">تسجيل نوم الليلة</h2>
                <div class="time-input-group">
                    <div class="time-input-container">
                        <label for="sleep-time-input">متى نمت تقريبا</label>
                        <input type="time" id="sleep-time-input">
                    </div>
                    <div class="time-input-container">
                        <label for="wake-time-input">ومتى صحيت</label>
                        <input type="time" id="wake-time-input">
                    </div>
                </div>
                <p class="text-secondary small text-center mb-3">ملاحظة: AM يعني صباحا (من 12:00 منتصف الليل إلى 11:59 صباحا)، و PM يعني مساء (من 12:00 ظهراً إلى 11:59 مساء).</p>
                <div id="sleep-duration-display" class="hidden-section"></div>
                <div class="d-flex gap-2">
                    <button id="cancel-sleep-time-btn" class="user-option-btn" style="background-color: var(--danger-color); flex-basis: 30%;">إلغاء</button>
                    <button id="submit-sleep-time-btn" class="user-option-btn" style="flex-grow: 1;">تسجيل وحساب المدة</button>
                </div>
            </div>

            <!-- Section for the dynamic daily question -->
            <div id="daily-question-section" class="sleep-card hidden-section">
                <h2 class="sleep-card-title" id="daily-question-text"></h2>
                <div class="daily-question-options" id="daily-question-options-container">
                    <!-- Options will be injected here -->
                </div>
            </div>

            <!-- Section for analysis and chart -->
            <div id="sleep-analysis-section" class="hidden-section">
                <div class="sleep-card">
                    <h2 class="sleep-card-title">ملخص نومك آخر اسبوع</h2>
                    <div id="sleep-chart-container">
                        <canvas id="sleepChart"></canvas>
                    </div>
                </div>
                <div class="sleep-card">
                    <h2 class="sleep-card-title">تحليل نومك الاسبوعي</h2>
                    <div id="weekly-analysis-container">
                        <!-- AI weekly analysis will be injected here -->
                    </div>
                     <p class="last-updated-text" id="analysis-last-updated"></p>
                </div>
            </div>
        </main>
    </div>
    <!-- END: Sleep Improvement Page -->

    <div class="modal-overlay" id="settings-modal-overlay">
        <div class="modal-content-custom" id="settings-modal-content">
            <header class="modal-header-custom"><h5>اعدادات العداد</h5><i class="bi bi-x-lg" id="close-settings-button"></i></header>
            <div class="modal-body-custom">
                <button class="action-button" id="reset-timer-button"><span>تصفير العداد</span><div class="icon-container yellow"><i class="bi bi-arrow-counterclockwise"></i></div></button>
                <button class="action-button" id="set-date-button"><span>تعيين تاريخ بداية جديد</span><div class="icon-container blue"><i class="bi bi-calendar-plus-fill"></i></div></button>
                <div id="developer-background-options" class="d-none">
                    <button class="action-button" id="set-image-button">
                        <span>تعيين صورة خلفية</span>
                        <div class="icon-container green"><i class="bi bi-image"></i></div>
                    </button>
                    <button class="action-button" id="remove-background-button">
                        <span>إزالة الخلفية</span>
                        <div class="icon-container red"><i class="bi bi-trash-fill"></i></div>
                    </button>
                </div>
                <input type="datetime-local" id="date-time-picker" style="opacity: 0; position: absolute; left: -9999px; width: 1px; height: 1px;">
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="confirm-reset-modal">
        <div class="modal-content-custom">
            <div class="confirm-modal-body"><div class="confirm-icon"><i class="bi bi-arrow-counterclockwise"></i></div><p>هل أنت متأكد من تصفير العداد؟ سيتم حذف جميع الأوسمة التي حصلت عليها.</p></div>
            <div class="confirm-modal-footer"><button class="confirm-btn confirm-btn-cancel" id="cancel-reset-button">رجوع</button><button class="confirm-btn confirm-btn-accept" id="confirm-reset-action-button">تصفير</button></div>
        </div>
    </div>

    <div class="modal fade" id="notifications-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">الإشعارات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notifications-list"></div>
                <div class="modal-footer">
                    <button id="open-send-modal-btn" type="button" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#send-notification-modal">إرسال إشعار جديد</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="send-notification-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إرسال إشعار جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="notification-title" class="form-label">العنوان</label>
                        <input type="text" class="form-control" id="notification-title" placeholder="عنوان الإشعار">
                    </div>
                    <div class="mb-3">
                        <label for="notification-message" class="form-label">الرسالة</label>
                        <textarea class="form-control" id="notification-message" rows="4" placeholder="محتوى الإشعار"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-close" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="send-notification-btn">إرسال</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- START: Achievements Modals -->
    <div class="modal fade" id="achievementsModal" tabindex="-1" aria-labelledby="achievementsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="achievementsModalLabel">سجل الأوسمة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="achievements-grid">
                        <!-- Achievement cards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="congratsAchievementModal" tabindex="-1" aria-labelledby="congratsAchievementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body" id="congrats-modal-body">
                    <div id="congrats-icon"><i class="bi bi-trophy-fill"></i></div>
                    <h5 id="congrats-user-text" class="mb-1"></h5>
                    <p id="congrats-text" class="text-secondary"></p>
                    <button type="button" class="btn btn-primary mt-3" data-bs-dismiss="modal">رائع!</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Achievements Modals -->

    <!-- START: Leaderboard Modal -->
    <div class="modal fade" id="leaderboardModal" tabindex="-1" aria-labelledby="leaderboardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header flex-column align-items-stretch p-2">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <h5 class="modal-title" id="leaderboardModalLabel">🏆 لوحة الصدارة</h5>
                        <button type="button" class="btn-close m-0" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div id="leaderboard-tabs-container" class="d-none w-100 mt-2">
                        <ul class="nav nav-tabs" id="leaderboardTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="leaderboard-list-tab" data-bs-toggle="tab" data-bs-target="#leaderboard-list-pane" type="button" role="tab" aria-controls="leaderboard-list-pane" aria-selected="true">لوحة الصدارة</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="banned-list-tab" data-bs-toggle="tab" data-bs-target="#banned-list-pane" type="button" role="tab" aria-controls="banned-list-pane" aria-selected="false">المحظورون</button>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-body p-0" id="leaderboard-body-container">
                     <div class="tab-content" id="leaderboardTabContent">
                        <div class="tab-pane fade show active p-3" id="leaderboard-list-pane" role="tabpanel" tabindex="0">
                            <!-- Leaderboard content will be injected here -->
                        </div>
                        <div class="tab-pane fade p-3" id="banned-list-pane" role="tabpanel" tabindex="0">
                            <!-- Banned users list will be injected here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center p-0" id="leaderboard-footer-user-rank">
                    <!-- User's rank will be injected here -->
                </div>
            </div>
        </div>
    </div>
    <!-- END: Leaderboard Modal -->

    <!-- START: User Achievements Modal -->
    <div class="modal fade" id="userAchievementsModal" tabindex="-1" aria-labelledby="userAchievementsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userAchievementsModalLabel">أوسمة المستخدم</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="user-achievements-grid">
                        <!-- User achievements will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END: User Achievements Modal -->


    <input type="file" accept="image/*" id="image-file-picker" style="display: none;">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // --- START: Added Spinner Functions ---
        function showSpinner() {
            const spinner = document.getElementById('loading-spinner-overlay');
            if (spinner) {
                spinner.classList.add('show');
            }
        }

        function hideSpinner() {
            const spinner = document.getElementById('loading-spinner-overlay');
            if (spinner) {
                spinner.classList.remove('show');
            }
        }
        // --- END: Added Spinner Functions ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, getDocs, arrayUnion, updateDoc, deleteDoc, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGgZmhJ_mMezlf7xElisvzJ8l9D758d4g",
            authDomain: "my-chat-app-daaf8.firebaseapp.com",
            projectId: "my-chat-app-daaf8",
            storageBucket: "my-chat-app-daaf8.firebasestorage.app",
            messagingSenderId: "789086064752",
            appId: "1:789086064752:web:d081f1b6832dabca1d64b5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // START: Achievements Logic
        const milestones = [
            { days: 1, name: "وسام شرارة التغيير", icon: "bi-lightbulb-fill" },
            { days: 3, name: "وسام بذرة الصمود", icon: "bi-tree-fill" },
            { days: 7, name: "وسام عبور الأسبوع", icon: "bi-calendar-check-fill" },
            { days: 14, name: "وسام حصن الأسبوعين", icon: "bi-shield-shaded" },
            { days: 21, name: "وسام ترسيخ العادة", icon: "bi-pin-map-fill" },
            { days: 30, name: "وسام نجمة الشهر", icon: "bi-star-fill" },
            { days: 40, name: "وسام الأربعين الحاسمة", icon: "bi-clipboard2-check-fill" },
            { days: 45, name: "وسام محارب الـ 45", icon: "bi-shield-plus" },
            { days: 60, name: "وسام قمر الشهرين", icon: "bi-moon-stars-fill" },
            { days: 90, name: "وسام جوهرة الفصل", icon: "bi-gem" },
            { days: 100, name: "وسام بطل المئة", icon: "bi-1-circle-fill" },
            { days: 120, name: "وسام ربان الأربعة أشهر", icon: "bi-compass-fill" },
            { days: 150, name: "وسام فارس الخمسة أشهر", icon: "bi-flag-fill" },
            { days: 180, name: "وسام شمس منتصف العام", icon: "bi-sun-fill" },
            { days: 250, name: "وسام صخرة الصبر", icon: "bi-bricks" },
            { days: 300, name: "وسام كوكب الثلاثمائة", icon: "bi-stars" },
            { days: 365, name: "وسام دورة فلكية كاملة", icon: "bi-globe-americas" },
            { days: 500, name: "وسام برق القوة", icon: "bi-lightning-charge-fill" },
            { days: 650, name: "وسام جبل الإرادة", icon: "bi-filter-circle-fill" }, // Represents a mountain icon
            { days: 750, name: "وسام أسطورة حية", icon: "bi-person-vcard-fill" },
            { days: 850, name: "وسام حكيم المثابرة", icon: "bi-mortarboard-fill" },
            { days: 1000, name: "وسام تاج الألفية", icon: "bi-trophy-fill" }
        ];
        let lastCheckedDay = -1; 
        const congratsModalEl = document.getElementById('congratsAchievementModal');
        const congratsModal = new bootstrap.Modal(congratsModalEl);

        async function resetAchievements() {
            const user = auth.currentUser;
            if (!user || user.isAnonymous) return;
            showSpinner();
            try {
                const achievementsColRef = collection(db, "users", user.uid, "achievements");
                const querySnapshot = await getDocs(achievementsColRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
            } catch (error) {
                console.error("Error resetting achievements:", error);
            } finally {
                hideSpinner();
            }
        }

        async function checkAndAwardAchievements(days) {
            const user = auth.currentUser;
            if (!user || user.isAnonymous || days < 1) return;
            showSpinner();
            try {
                for (const milestone of milestones) {
                    if (days >= milestone.days) {
                        const achievementRef = doc(db, "users", user.uid, "achievements", String(milestone.days));
                        try {
                            const achievementSnap = await getDoc(achievementRef);
                            if (!achievementSnap.exists()) {
                                await setDoc(achievementRef, {
                                    name: milestone.name,
                                    icon: milestone.icon,
                                    dateAwarded: serverTimestamp()
                                });
                                const userName = user.displayName || 'يا بطل';
                                document.getElementById('congrats-user-text').textContent = `مبارك يا ${userName}!`;
                                document.getElementById('congrats-text').textContent = `لقد حصلت على "${milestone.name}"`;
                                document.getElementById('congrats-icon').innerHTML = `<i class="${milestone.icon}"></i>`;
                                congratsModal.show();
                            }
                        } catch (error) {
                            console.error(`Error checking achievement for ${milestone.days} days:`, error);
                        }
                    } else {
                        break; 
                    }
                }
            } finally {
                hideSpinner();
            }
        }

        async function displayAchievements() {
            const grid = document.getElementById('achievements-grid');
            const currentDays = window.currentStreakDays || 0;
            grid.innerHTML = ''; 

            milestones.forEach(milestone => {
                const requiredDays = milestone.days;
                const card = document.createElement('div');
                card.classList.add('achievement-card');
                let iconClass, cardTitle = milestone.name, cardSubText;

                if (currentDays >= requiredDays) {
                    card.classList.remove('locked');
                    iconClass = milestone.icon;
                    cardSubText = `أكملت ${requiredDays} أيام بنجاح!`;
                } else {
                    card.classList.add('locked');
                    iconClass = 'bi bi-lock-fill';
                    cardSubText = `أكمل ${requiredDays} يوماً لفتحه`;
                }
                
                card.innerHTML = `
                    <div class="achievement-card-icon"><i class="${iconClass}"></i></div>
                    <div class="achievement-card-title">${cardTitle}</div>
                    <div class="achievement-card-date">${cardSubText}</div>
                `;
                grid.appendChild(card);
            });
        }
        // END: Achievements Logic

        // START: Leaderboard Logic
        /**
         * Normalizes a Date object to the start of its day in UTC (00:00:00).
         * This function is crucial for timezone-independent day calculations.
         * @param {Date} date The input date.
         * @returns {Date} A new Date object set to the beginning of the day in UTC.
         */
        function getUTCDayStart(date) {
            const d = new Date(date);
            d.setUTCHours(0, 0, 0, 0);
            return d;
        }

        async function displayBannedList() {
            const bannedListBody = document.getElementById('banned-list-pane');
            bannedListBody.innerHTML = `<div class="loading-spinner-container"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            showSpinner();
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("isBannedFromLeaderboard", "==", true));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    bannedListBody.innerHTML = '<p class="text-center text-secondary mt-3">قائمة المحظورين فارغة.</p>';
                    return;
                }

                let bannedListHTML = '<ul class="leaderboard-list">';
                querySnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const profilePic = userData.photoURL || 'https://placehold.co/100x100/1e1e1e/fafafa?text=?';
                    const restoreButtonHTML = `<i class="bi bi-arrow-counterclockwise leaderboard-restore-btn" data-userid="${userDoc.id}" title="إلغاء الحظر"></i>`;

                    bannedListHTML += `
                        <li class="leaderboard-item" id="banned-user-${userDoc.id}">
                            <img src="${profilePic}" alt="User Picture" class="leaderboard-user-pic" style="margin-left: 1rem; margin-right: 0;">
                            <div class="leaderboard-user-info">
                                <h6 class="leaderboard-user-name">${userData.displayName || 'مستخدم'}</h6>
                            </div>
                            ${restoreButtonHTML}
                        </li>`;
                });
                bannedListHTML += '</ul>';
                bannedListBody.innerHTML = bannedListHTML;

                document.querySelectorAll('#leaderboardModal .leaderboard-restore-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const userIdToRestore = event.target.dataset.userid;
                        if (confirm('هل أنت متأكد من إلغاء حظر هذا المستخدم؟')) {
                            showSpinner();
                            try {
                                const userToUpdateRef = doc(db, "users", userIdToRestore);
                                await updateDoc(userToUpdateRef, { isBannedFromLeaderboard: false });
                                event.target.closest('.leaderboard-item').remove();
                            } catch (error) { console.error("Error unbanning user: ", error); }
                            finally { hideSpinner(); }
                        }
                    });
                });

            } catch (error) {
                console.error("Error fetching banned list: ", error);
                bannedListBody.innerHTML = '<p class="text-center text-danger mt-3">حدث خطأ أثناء تحميل القائمة.</p>';
            } finally {
                hideSpinner();
            }
        }

        async function displayLeaderboard() {
            const leaderboardListPane = document.getElementById('leaderboard-list-pane');
            const leaderboardFooter = document.getElementById('leaderboard-footer-user-rank');
            const tabsContainer = document.getElementById('leaderboard-tabs-container');
            const modalTitle = document.getElementById('leaderboardModalLabel');
            const user = auth.currentUser;
            if (!user) return;

            leaderboardListPane.innerHTML = `<div class="loading-spinner-container"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            leaderboardFooter.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border spinner-border-sm text-light" role="status"></div></div>`;
            document.getElementById('banned-list-pane').innerHTML = '';
            
            let allRankedUsers = [];

            showSpinner();
            try {
                let currentUserRole = 'user';
                if (!user.isAnonymous) {
                    const currentUserDoc = await getDoc(doc(db, "users", user.uid));
                    if (currentUserDoc.exists()) {
                        currentUserRole = currentUserDoc.data().role || 'user';
                    }
                }

                if (currentUserRole === 'developer') {
                    tabsContainer.classList.remove('d-none');
                    modalTitle.classList.add('d-none');
                    const bannedTab = document.getElementById('banned-list-tab');
                    if (!bannedTab.hasAttribute('data-listener-added')) {
                        bannedTab.addEventListener('click', displayBannedList);
                        bannedTab.setAttribute('data-listener-added', 'true');
                    }
                } else {
                    tabsContainer.classList.add('d-none');
                    modalTitle.classList.remove('d-none');
                }

                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("timerStartDate", "asc"));
                
                const querySnapshot = await getDocs(q);
                
                allRankedUsers = querySnapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.timerStartDate && data.role !== 'developer' && data.isBannedFromLeaderboard !== true;
                });
                
                if (allRankedUsers.length === 0) {
                    leaderboardListPane.innerHTML = '<p class="text-center text-secondary mt-3">لا يوجد مستخدمون في لوحة الصدارة بعد.</p>';
                } else {
                    let leaderboardHTML = '<ul class="leaderboard-list">';
                    allRankedUsers.forEach((userDoc, index) => {
                        const userData = userDoc.data();
                        const startDate = userData.timerStartDate.toDate();
                        
                        // -- BEGIN ROBUST TIMEZONE FIX --
                        const startDayUTC = getUTCDayStart(startDate);
                        const todayUTC = getUTCDayStart(new Date());

                        let recoveryDays = 0;
                        if (!isNaN(startDayUTC.getTime())) {
                            const diffTime = todayUTC.getTime() - startDayUTC.getTime();
                            recoveryDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                        }
                        // -- END ROBUST TIMEZONE FIX --

                        const rank = index + 1;
                        const rankClass = rank <= 3 ? `rank-${rank}` : '';
                        let rankDisplay = rank <= 3 ? `<div class="leaderboard-rank-medal">${['🥇', '🥈', '🥉'][rank - 1]}</div>` : `<div class="leaderboard-rank">${rank}</div>`;
                        const profilePic = userData.photoURL || 'https://placehold.co/100x100/1e1e1e/fafafa?text=?';
                        const deleteButtonHTML = currentUserRole === 'developer' ? `<i class="bi bi-x-circle-fill leaderboard-delete-btn" data-userid="${userDoc.id}" title="حظر من لوحة الصدارة"></i>` : '';
                        
                        leaderboardHTML += `
                            <li class="leaderboard-item ${rankClass}" id="user-rank-${userDoc.id}" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#userAchievementsModal" data-userid="${userDoc.id}">
                                ${rankDisplay}
                                <img src="${profilePic}" alt="User Picture" class="leaderboard-user-pic">
                                <div class="leaderboard-user-info">
                                    <h6 class="leaderboard-user-name">${userData.displayName || 'مستخدم'}</h6>
                                    <p class="leaderboard-user-days">${recoveryDays} يوم</p>
                                </div>
                                ${deleteButtonHTML}
                            </li>`;
                    });
                    leaderboardHTML += '</ul>';
                    leaderboardListPane.innerHTML = leaderboardHTML;
                }
                
                if (currentUserRole === 'developer') {
                    document.querySelectorAll('#leaderboardModal .leaderboard-delete-btn').forEach(button => {
                        button.addEventListener('click', async (event) => {
                            event.stopPropagation(); // Prevent modal from opening
                            const userIdToBan = event.target.dataset.userid;
                            if (confirm("هل أنت متأكد من حظر هذا المستخدم من لوحة الصدارة؟")) {
                                showSpinner();
                                try {
                                    const userToUpdateRef = doc(db, "users", userIdToBan);
                                    await updateDoc(userToUpdateRef, { isBannedFromLeaderboard: true });
                                    event.target.closest('.leaderboard-item').remove();
                                } catch (error) { console.error("Error banning user: ", error); }
                                finally { hideSpinner(); }
                            }
                        });
                    });
                }

                // Inner function to calculate and display user's rank
                const findUserRank = async () => {
                    if (user.isAnonymous) {
                         leaderboardFooter.innerHTML = 'سجل دخولك لتظهر في الترتيب';
                         return;
                    }
                    const currentUserDoc = await getDoc(doc(db, "users", user.uid));
                    if (!currentUserDoc.exists() || !currentUserDoc.data().timerStartDate) {
                        leaderboardFooter.innerHTML = 'ابدأ العداد لتظهر في الترتيب';
                        return;
                    }

                    const userRankIndex = allRankedUsers.findIndex(doc => doc.id === user.uid);

                    if (userRankIndex !== -1) {
                        leaderboardFooter.innerHTML = `🌟 ترتيبك الحالي: ${userRankIndex + 1} 🌟`;
                    } else {
                        leaderboardFooter.innerHTML = 'أنت غير مُصنّف حاليًا';
                    }
                };

                findUserRank();

            } catch (error) {
                console.error("Error fetching leaderboard: ", error);
                leaderboardListPane.innerHTML = '<p class="text-center text-danger mt-3">حدث خطأ أثناء تحميل البيانات. الرجاء المحاولة مرة أخرى.</p>';
                leaderboardFooter.innerHTML = 'خطأ في تحميل الترتيب';
            } finally {
                hideSpinner();
            }
        }
        // END: Leaderboard Logic

        // START: User Achievements Modal Logic
        async function displayUserAchievements(userId) {
            const grid = document.getElementById('user-achievements-grid');
            grid.innerHTML = `<div class="loading-spinner-container w-100 d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            showSpinner();
            try {
                const achievementsRef = collection(db, "users", userId, "achievements");
                const q = query(achievementsRef, orderBy("dateAwarded", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    grid.innerHTML = '<p class="text-center text-secondary mt-3 w-100" style="grid-column: 1 / -1;">هذا المستخدم لم يحصل على أي وسام بعد.</p>';
                    return;
                }

                let achievementsHTML = '';
                querySnapshot.forEach(doc => {
                    const achievement = doc.data();
                    const date = achievement.dateAwarded?.toDate().toLocaleDateString('ar-EG', { day: 'numeric', month: 'short', year: 'numeric' }) || 'غير محدد';
                    
                    achievementsHTML += `
                        <div class="achievement-card">
                            <div class="achievement-card-icon"><i class="${achievement.icon || 'bi-trophy-fill'}"></i></div>
                            <div class="achievement-card-title">${achievement.name}</div>
                            <div class="achievement-card-date">حصل عليه في: ${date}</div>
                        </div>
                    `;
                });
                grid.innerHTML = achievementsHTML;

            } catch (error) {
                console.error("Error fetching user achievements:", error);
                grid.innerHTML = '<p class="text-center text-danger mt-3 w-100" style="grid-column: 1 / -1;">حدث خطأ أثناء تحميل الأوسمة.</p>';
            } finally {
                hideSpinner();
            }
        }
        // END: User Achievements Modal Logic


        function initializeGlobalChatNotifications(userId) {
            const chatBadge = document.querySelector('.chat-notification-badge');
            if (!chatBadge) return;

            let publicUnreadCount = 0;
            let privateUnreadCount = 0;

            function updateBadge() {
                const totalUnread = publicUnreadCount + privateUnreadCount;
                if (totalUnread > 0) {
                    chatBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                    chatBadge.style.display = 'flex';
                } else {
                    chatBadge.style.display = 'none';
                }
            }

            if (window.publicListenerUnsubscribe) window.publicListenerUnsubscribe();
            if (window.privateListenerUnsubscribe) window.privateListenerUnsubscribe();

            const lastReadTimestamp = parseInt(localStorage.getItem('lastReadTimestamp') || '0');
            const messagesRef = collection(db, "messages");
            const publicQuery = query(messagesRef, where("createdAt", ">", Timestamp.fromMillis(lastReadTimestamp)));
            window.publicListenerUnsubscribe = onSnapshot(publicQuery, (snapshot) => {
                let count = 0;
                snapshot.forEach(doc => { if (doc.data().senderId !== userId) count++; });
                publicUnreadCount = count;
                updateBadge();
            });

            const userIsAnonymous = auth.currentUser ? auth.currentUser.isAnonymous : true;
            if (!userIsAnonymous) {
                const privateChatsQuery = query(collection(db, "private_chats"), where("participants", "array-contains", userId));
                window.privateListenerUnsubscribe = onSnapshot(privateChatsQuery, (snapshot) => {
                    let count = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!data[`hidden_for_${userId}`]) count += (data[`unread_count_${userId}`] || 0);
                    });
                    privateUnreadCount = count;
                    updateBadge();
                });
            } else {
                 privateUnreadCount = 0;
                 updateBadge();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            function applyBackgroundPreference() {
                const savedTheme = localStorage.getItem('appBackgroundTheme') || 'default';
                const body = document.body;
                body.classList.remove('solid-black-bg', 'gradient-blue-bg');
                if (savedTheme === 'solid-black') {
                    body.classList.add('solid-black-bg');
                } else if (savedTheme === 'gradient-blue') {
                    body.classList.add('gradient-blue-bg');
                }
            }
            applyBackgroundPreference();

            let startTime = null;
            let timerInterval = null;
            window.currentStreakDays = 0;
            let currentUserRole = 'user';
            let breathingTimeouts = [];
            let countdownInterval = null;
            let lastSolution = null;
            const welcomeUserEl = document.getElementById('welcome-user');
            const openSendModalBtn = document.getElementById('open-send-modal-btn');
            const startTimerBtn = document.getElementById('start-timer-btn');
            const timerSettingsIcon = document.querySelector('.timer-settings-icon');
            const notificationBadge = document.querySelector('.notification-badge');
            const notificationsModalEl = document.getElementById('notifications-modal');
            let latestNotificationTimestamp = null;
            const natureImages = [
                'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80',
                'https://images.unsplash.com/photo-1488866022504-f2584929ca5f?w=800&q=80',
                'https://images.unsplash.com/photo-1542314831-068cd1dbb563?w=800&q=80',
                'https://images.unsplash.com/photo-1507525428034-b723a996f6ea?w=800&q=80'
            ];
            let lastImageIndex = -1;
            let modalsInitialized = false;

            const appLockOverlay = document.getElementById('app-lock-overlay');
            const passcodeError = document.getElementById('passcode-error');
            const unlockBtn = document.getElementById('unlock-btn');
            const passcodeInput = document.getElementById('passcode-input');
            const RELOCK_TIME = 3 * 60 * 1000;

            function getLockData() {
                try {
                    return JSON.parse(localStorage.getItem('app_lock_config')) || { enabled: false, passcode: null };
                } catch (e) {
                    return { enabled: false, passcode: null };
                }
            }

            function initializeModalListeners() {
                if (modalsInitialized) return;

                const achievementsModalEl = document.getElementById('achievementsModal');
                achievementsModalEl.addEventListener('show.bs.modal', displayAchievements);

                const leaderboardModalEl = document.getElementById('leaderboardModal');
                leaderboardModalEl.addEventListener('show.bs.modal', displayLeaderboard);
                
                const userAchievementsModalEl = document.getElementById('userAchievementsModal');
                userAchievementsModalEl.addEventListener('show.bs.modal', (event) => {
                    const triggerElement = event.relatedTarget; 
                    if (triggerElement) {
                        const userId = triggerElement.getAttribute('data-userid');
                        if (userId) {
                            const userName = triggerElement.querySelector('.leaderboard-user-name').textContent;
                            const modalTitleEl = userAchievementsModalEl.querySelector('.modal-title');
                            if(modalTitleEl) {
                                modalTitleEl.textContent = `أوسمة ${userName}`;
                            }
                            displayUserAchievements(userId);
                        }
                    }
                });
                
                modalsInitialized = true;
            }
            
            function initializeAppLock() {
                const lockData = getLockData();
                if (!lockData.enabled) return;
                const lastUnlock = localStorage.getItem('app_last_unlock') || 0;
                const timeSinceUnlock = Date.now() - lastUnlock;
                if (timeSinceUnlock >= RELOCK_TIME) {
                    appLockOverlay.style.display = 'flex';
                }
            }

            function handleUnlock() {
                const enteredPasscode = passcodeInput.value;
                const lockData = getLockData();
                passcodeError.style.display = 'none';
                if (enteredPasscode === lockData.passcode) {
                    localStorage.setItem('app_last_unlock', Date.now());
                    appLockOverlay.style.display = 'none';
                    passcodeInput.value = '';
                } else {
                    passcodeError.style.display = 'block';
                    passcodeInput.classList.add('is-invalid');
                    setTimeout(() => passcodeInput.classList.remove('is-invalid'), 1000);
                }
            }

            unlockBtn.addEventListener('click', handleUnlock);
            passcodeInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleUnlock();
            });

            function callGeminiAPI(prompt) {
                showSpinner();
                return new Promise((resolve, reject) => {
                    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyYn_lPlFg25E8QTJQGie4ams49eYQekl-qZ9mm9oB4BkLyBtuTS2ZX9pw6D5mfj1Io/exec";
                    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                    window[callbackName] = function(data) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        if (data.error) {
                            resolve("عفوًا، حدثت مشكلة مؤقتة. يرجى المحاولة مرة أخرى لاحقًا.");
                        } else {
                            resolve(data.text);
                        }
                        hideSpinner();
                    };
                    const script = document.createElement('script');
                    script.src = WEB_APP_URL + '?callback=' + callbackName + '&prompt=' + encodeURIComponent(prompt);
                    script.onerror = function() {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve("إذا أردت إرسال طلب آخر اضغط على أيقونة الرئيسية في الشريط السفلي");
                        hideSpinner();
                    };
                    document.body.appendChild(script);
                });
            }

            function setupGeminiFeatures() {
                const inspirationBtn = document.getElementById('inspiration-btn');
                
                inspirationBtn.addEventListener('click', async () => {
                    const inspirationDisplay = document.getElementById('inspiration-display');
                    const inspirationText = document.getElementById('inspiration-text');
                    inspirationBtn.disabled = true;
                    inspirationBtn.innerHTML = `<span>لحظة أفكر لك بحل... <i class="bi bi-hourglass-split"></i></span>`;
                    
                    let basePrompt = `أنا عندي رغبةاسمع يا صاحبي أنا فيني بلا وأحس إني على وشك أطيح في مشاهدة المقاطع الإباحية والرغبة قوية مرة أبغاك بصفتك ناصح أمين وفاهم على منهج السلف الصالح تعطيني حل عملي وفوري أقدر أسويه الحين عشان أطفي هذي النار

        لكن عندي شروط صارمة لازم تلتزم فيها بالحرف:

        1.  **اللهجة والأسلوب:** تكلم باللهجة السعودية العامية وكأنك تسولف مع خويك في أزمة لا تكلمني كأنك آلة أو خطيب.

        2.  **التنسيق:** لا تستخدم أي تشكيل أو علامات ترقيم نهائيا لا فاصلة ولا نقطة ولا شي.

        3.  **الطول:** عطني كلام طويل ومفصل وخش في صلب الموضوع على طول.

        4.  **الأهم من هذا كله (شرط أساسي): التنوع الكامل وعدم التكرار.** كل مرة أقول لك 'أبغى حل ثاني' لازم تعطيني حل جديد ومختلف تماما عن كل الحلول اللي عطيتني إياها قبل. لا تعيد صياغة نفس الفكرة ولا تكرر أي نصيحة. إذا حسيت إنك بتكرر وقف وقول لي ما عندي شي جديد. لازم كل حل يكون فكرة مستقلة وجديدة.

        يلا الحين عطني أول حل جذري وفوري.
        `;
                    if (lastSolution) basePrompt += `\nالحل اللي عطيتني إياه قبل هو: ${lastSolution}. لا تكرره وعطني شي جديد.`;

                    const generatedText = await callGeminiAPI(basePrompt);
                    if (generatedText && !generatedText.includes('خطأ')) lastSolution = generatedText;
                    
                    let newImageIndex;
                    do { newImageIndex = Math.floor(Math.random() * natureImages.length); } while (newImageIndex === lastImageIndex && natureImages.length > 1);
                    lastImageIndex = newImageIndex; 
                    inspirationDisplay.style.backgroundImage = `url('${natureImages[newImageIndex]}')`;
                    inspirationText.innerHTML = generatedText.replace(/\n/g, '<br>');
                    inspirationDisplay.classList.remove('d-none');
                    inspirationBtn.disabled = false;
                    inspirationBtn.innerHTML = `<span>🔥 أبغى حل ثاني</span>`;
                });

                // START: ADDED for Salaf Story Button
                const salafStoryBtn = document.getElementById('salaf-story-btn');
                const salafStoryDisplay = document.getElementById('salaf-story-display');
                const salafStoryText = document.getElementById('salaf-story-text');
                let lastSalafStory = null; // Separate tracking variable

                salafStoryBtn.addEventListener('click', async () => {
                    salafStoryDisplay.classList.remove('d-none');
                    salafStoryText.innerHTML = `<div class="d-flex justify-content-center align-items:center p-4"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
                    salafStoryBtn.disabled = true;
                    salafStoryBtn.innerHTML = `<span>لحظة نجيب لك قصة تروقك... <i class="bi bi-hourglass-split"></i></span>`;

                    // The new prompt requested by the user
                    let salafPrompt = `بصفتك ناصح  امين وفاهم على منهج السلف الصالح اسمع يا صاحبي أبغاك تسولف لي سالفة عن واحد من الصالحين وكيف كان خوفه من الله وتقواه وكيف كان يجاهد نفسه عشان يترك المعاصي وكيف لقى لذة الإيمان الحقيقية واربط لي هالكلام بموضوع التعافي من الإدمان وكيف إن لذة الطاعة أحلى وأبقى من لذة المعصية الزايلة

        بس عندي كم شرط مهم مرة لازم تمشي عليها:

        1.  **الشخصيات:** لا تجيب لي سيرة الخلفاء الراشدين الأربعة (أبو بكر وعمر وعثمان وعلي) لأني أعرف قصصهم. أبغاك تجيب لي قصص عشوائية وجديدة كل مرة من حياة التابعين وتابعي التابعين والعلماء والصالحين والعباد والزهاد من كل العصور. يعني كل مرة أطلب منك عطني قصة لشخصية مختلفة تماما ولا تكرر لي نفس الشخصية أبدا.

        2.  **المنهج:** لا تطلع عن منهج السلف الصالح في طريقة سردك للقصص والمعلومات.

        3.  **اللهجة:** تكلم باللهجة السعودية العامية وخلك طبيعي كأنك تسولف مع خويك في استراحة.

        4.  **التنسيق:** لا تستخدم أي علامات ترقيم (لا فاصلة ولا نقطة) ولا أي تشكيل (فتحة ضمة كسرة) نهائيا.

        5.  **الطول:** عطني كلام طويل ومفصل وسولف من قلبك لا تختصر السالفة.

        يلا الحين عطني أول قصة.
        `;
                    if (lastSalafStory) {
                        salafPrompt += `\nالقصة اللي عطيتني إياها قبل كانت عن: ${lastSalafStory.substring(0, 50)}. لا تكررها وعطني قصة جديدة.`;
                    }

                    const generatedText = await callGeminiAPI(salafPrompt);

                    if (generatedText && !generatedText.includes('خطأ') && !generatedText.includes('مشكلة')) {
                        lastSalafStory = generatedText;
                    }
                    
                    let newImageIndex;
                    do {
                        newImageIndex = Math.floor(Math.random() * natureImages.length);
                    } while (newImageIndex === lastImageIndex && natureImages.length > 1);
                    lastImageIndex = newImageIndex;
                    salafStoryDisplay.style.backgroundImage = `url('${natureImages[newImageIndex]}')`;

                    salafStoryText.innerHTML = generatedText.replace(/\n/g, '<br>');
                    
                    salafStoryBtn.disabled = false;
                    salafStoryBtn.innerHTML = `<span>📖 أبغى قصة ثانية</span>`;
                });
                // END: ADDED for Salaf Story Button
            }

            onAuthStateChanged(auth, async (user) => {
                showSpinner();
                try {
                    if (user && (user.emailVerified || user.isAnonymous)) {
                        document.body.style.visibility = 'visible';
                        initializeAppLock();

                        setInterval(() => { if (document.visibilityState === 'visible') localStorage.setItem('app_last_unlock', Date.now()); }, 60 * 1000); 
                        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') initializeAppLock(); });
                        
                        initializeGlobalChatNotifications(user.uid);
                        listenForBackgroundImageChanges();

                        if (user.isAnonymous) {
                            welcomeUserEl.textContent = `مرحبا ٲيها الزائر`;
                            openSendModalBtn.classList.add('d-none');
                            const visitorTimerStart = localStorage.getItem('visitorTimerStart');
                            if (visitorTimerStart) {
                                startTime = new Date(parseInt(visitorTimerStart));
                                startTimerBtn.classList.add('d-none');
                                timerSettingsIcon.classList.remove('d-none');
                                updateTimer();
                                if(timerInterval) clearInterval(timerInterval);
                                timerInterval = setInterval(updateTimer, 1000);
                            } else {
                                startTimerBtn.classList.remove('d-none');
                                timerSettingsIcon.classList.add('d-none');
                                updateTimerDisplay(0, 0, 0, 0);
                            }
                            loadNotifications(null);
                        } else {
                            welcomeUserEl.textContent = `مرحبا ${user.displayName || 'المستخدم'}`;
                            const userDocRef = doc(db, "users", user.uid);
                            const userDoc = await getDoc(userDocRef);
                            if (userDoc.exists()) {
                                currentUserRole = userDoc.data().role || 'user';
                                if (currentUserRole === 'developer') { 
                                    openSendModalBtn.classList.remove('d-none'); 
                                    document.getElementById('developer-background-options').classList.remove('d-none');
                                }
                                if (userDoc.data().timerStartDate) {
                                    startTime = userDoc.data().timerStartDate.toDate();
                                    startTimerBtn.classList.add('d-none'); 
                                    timerSettingsIcon.classList.remove('d-none'); 
                                    updateTimer();
                                    if (timerInterval) clearInterval(timerInterval);
                                    timerInterval = setInterval(updateTimer, 1000);
                                } else {
                                    startTimerBtn.classList.remove('d-none'); 
                                    timerSettingsIcon.classList.add('d-none'); 
                                    updateTimerDisplay(0,0,0,0); 
                                }
                            } else {
                                await setDoc(userDocRef, { role: 'user', lastSeenNotificationTimestamp: new Date(0), displayName: user.displayName, photoURL: user.photoURL }, { merge: true });
                                startTimerBtn.classList.remove('d-none');
                                timerSettingsIcon.classList.add('d-none');
                                updateTimerDisplay(0,0,0,0);
                            }
                            loadNotifications(user.uid);
                        }
                         initializeModalListeners();
                    } else {
                        window.location.href = 'index.html';
                    }
                } finally {
                    hideSpinner();
                }
            });

            startTimerBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                startTime = new Date();
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const userDocRef = doc(db, "users", user.uid);
                        await setDoc(userDocRef, { timerStartDate: startTime }, { merge: true });
                    } else {
                        localStorage.setItem('visitorTimerStart', startTime.getTime());
                    }
                    startTimerBtn.classList.add('d-none');
                    timerSettingsIcon.classList.remove('d-none');
                    updateTimer();
                    if (timerInterval) clearInterval(timerInterval);
                    timerInterval = setInterval(updateTimer, 1000);
                } finally {
                    hideSpinner();
                }
            });

            async function loadNotifications(userId) {
                const notificationsList = document.getElementById('notifications-list');
                let lastSeenTimestamp = new Date(0);
                const isUserRegistered = userId && auth.currentUser && !auth.currentUser.isAnonymous;


                showSpinner();
                try {
                    if (isUserRegistered) {
                        const userDoc = await getDoc(doc(db, "users", userId));
                        lastSeenTimestamp = userDoc.data()?.lastSeenNotificationTimestamp?.toDate() || new Date(0);
                    }

                    const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"));
                    onSnapshot(q, (snapshot) => {
                        notificationsList.innerHTML = "";
                        if (snapshot.empty) {
                            notificationsList.innerHTML = '<p class="text-center text-muted">لا توجد إشعارات حالياً.</p>';
                            notificationBadge.style.display = 'none';
                            return;
                        }

                        if (isUserRegistered) {
                            latestNotificationTimestamp = snapshot.docs[0].data().createdAt?.toDate();
                            notificationBadge.style.display = latestNotificationTimestamp > lastSeenTimestamp ? 'block' : 'none';
                        } else {
                            notificationBadge.style.display = 'none';
                        }

                        snapshot.forEach(docSnapshot => {
                            const notification = docSnapshot.data();
                            const date = notification.createdAt?.toDate().toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' }) || '';
                            const item = document.createElement('div');
                            item.className = 'notification-item';
                            const deleteIconHTML = (currentUserRole === 'developer' && isUserRegistered) ? `<i class="bi bi-trash delete-notification-btn" data-id="${docSnapshot.id}" style="display: inline-block;"></i>` : '';
                            item.innerHTML = `${deleteIconHTML}<div class="d-flex justify-content-between align-items-center"><h6 class="notification-title mb-1">${notification.title}</h6><span class="notification-date">${date}</span></div><p class="notification-body mb-0">${notification.message}</p>`;
                            notificationsList.appendChild(item);
                        });

                        if (currentUserRole === 'developer' && isUserRegistered) {
                            document.querySelectorAll('.delete-notification-btn').forEach(button => {
                                button.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    if (confirm('هل أنت متأكد من حذف هذا الإشعار؟')) {
                                        showSpinner();
                                        try {
                                            await deleteDoc(doc(db, "notifications", e.target.getAttribute('data-id')));
                                        } finally {
                                            hideSpinner();
                                        }
                                    }
                                });
                            });
                        }
                    });
                } finally {
                    hideSpinner();
                }
            }

            notificationsModalEl.addEventListener('show.bs.modal', async () => {
                const user = auth.currentUser;
                if (user && !user.isAnonymous && latestNotificationTimestamp) {
                    notificationBadge.style.display = 'none';
                    await updateDoc(doc(db, "users", user.uid), { lastSeenNotificationTimestamp: latestNotificationTimestamp });
                }
            });
            
            const sendNotificationModal = new bootstrap.Modal(document.getElementById('send-notification-modal'));
            document.getElementById('send-notification-btn').addEventListener('click', async () => {
                const title = document.getElementById('notification-title').value.trim();
                const message = document.getElementById('notification-message').value.trim();
                if (!title || !message) return;
                showSpinner();
                try {
                    await addDoc(collection(db, "notifications"), { title, message, createdAt: serverTimestamp() });
                    document.getElementById('notification-title').value = '';
                    document.getElementById('notification-message').value = '';
                    sendNotificationModal.hide();
                } finally {
                    hideSpinner();
                }
            });

            const dateElement = document.getElementById('current-date');
            const [daysValueEl, hoursValueEl, minutesValueEl, secondsValueEl] = ['days-value', 'hours-value', 'minutes-value', 'seconds-value'].map(id => document.getElementById(id));
            const [daysFillEl, hoursFillEl, minutesFillEl, secondsFillEl] = ['days-fill', 'hours-fill', 'minutes-fill', 'seconds-fill'].map(id => document.getElementById(id));
            
            dateElement.textContent = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            function updateTimerDisplay(d, h, m, s) {
                daysValueEl.textContent = d; hoursValueEl.textContent = h; minutesValueEl.textContent = m; secondsValueEl.textContent = s;
                daysFillEl.style.width = `${Math.min(d > 0 ? ((d % 30) / 29) * 100 : 0, 100)}%`;
                hoursFillEl.style.width = `${Math.min(h > 0 ? (h / 23) * 100 : 0, 100)}%`;
                minutesFillEl.style.width = `${Math.min(m > 0 ? (m / 59) * 100 : 0, 100)}%`;
                secondsFillEl.style.width = `${Math.min(s > 0 ? (s / 59) * 100 : 0, 100)}%`;
            }

            function updateTimer() {
                if (!startTime) { updateTimerDisplay(0,0,0,0); return; };
                const difference = new Date() - startTime;
                if (difference < 0) { updateTimerDisplay(0,0,0,0); return; }
                const days = Math.floor(difference / 86400000);
                const hours = Math.floor((difference % 86400000) / 3600000);
                const minutes = Math.floor((difference % 3600000) / 60000);
                const seconds = Math.floor((difference % 60000) / 1000);
                updateTimerDisplay(days, hours, minutes, seconds);

                window.currentStreakDays = days;
                if (days > lastCheckedDay) {
                    checkAndAwardAchievements(days);
                    lastCheckedDay = days;
                }
            }

            const settingsModalOverlay = document.getElementById('settings-modal-overlay');
            const confirmResetModal = document.getElementById('confirm-reset-modal');
            const closeSettingsModal = () => settingsModalOverlay.classList.remove('show');
            document.querySelector('.timer-settings-icon').addEventListener('click', () => settingsModalOverlay.classList.add('show'));
            document.getElementById('close-settings-button').addEventListener('click', closeSettingsModal);
            document.getElementById('set-date-button').addEventListener('click', () => document.getElementById('date-time-picker').showPicker());
            
            document.getElementById('date-time-picker').addEventListener('change', async (e) => {
                if (!e.target.value) return;
                const newStartTime = new Date(e.target.value);
                if (isNaN(newStartTime.getTime())) return;
                
                showSpinner();
                try {
                    const user = auth.currentUser;
                    if (user && !user.isAnonymous) {
                        await resetAchievements();
                        await setDoc(doc(db, "users", user.uid), { timerStartDate: newStartTime }, { merge: true });
                    } else {
                        localStorage.setItem('visitorTimerStart', newStartTime.getTime());
                    }
                    location.reload();
                } finally {
                    hideSpinner();
                }
            });

            document.getElementById('reset-timer-button').addEventListener('click', () => { closeSettingsModal(); setTimeout(() => confirmResetModal.classList.add('show'), 300); });
            const closeConfirmModal = () => confirmResetModal.classList.remove('show');
            document.getElementById('cancel-reset-button').addEventListener('click', closeConfirmModal);
            
            document.getElementById('confirm-reset-action-button').addEventListener('click', async () => {
                showSpinner();
                try {
                    const user = auth.currentUser;
                    if (user && !user.isAnonymous) await resetAchievements(); 
                    const newStartTime = new Date();
                    if (user && !user.isAnonymous) {
                        await setDoc(doc(db, "users", user.uid), { timerStartDate: newStartTime }, { merge: true });
                    } else {
                        localStorage.setItem('visitorTimerStart', newStartTime.getTime());
                    }
                    location.reload();
                } finally {
                    hideSpinner();
                }
            });


            const breathingPage = document.getElementById('breathing-page');
            const homePage = document.getElementById('home-page');
            const quotePage = document.getElementById('quote-page');
            
            function stopBreathingCycle() {
                breathingTimeouts.forEach(clearTimeout); breathingTimeouts = [];
                if (countdownInterval) clearInterval(countdownInterval);
            }

            async function showQuotePage() {
                let newImageIndex;
                do { newImageIndex = Math.floor(Math.random() * natureImages.length); } while (newImageIndex === lastImageIndex);
                lastImageIndex = newImageIndex;
                quotePage.style.backgroundImage = `url('${natureImages[newImageIndex]}')`;
                
                breathingPage.classList.remove('active');
                quotePage.classList.add('active');
                
                document.getElementById('quote-text').innerHTML = '<div class="spinner-border text-light"></div>';
                const prompt = "بصفتك ناصح أمين على منهج السلف الصالح خاطب شخص على وشك يطيح في معصية العادة السرية أو مشاهدة الإباحية عطه كلام قوي ومباشر يجمع بين العقل والترهيب والتذكير بعواقب الفعل عشان يتراجع فورا تكلم باللهجة السعودية العامية وردك لازم يكون بدون تشكيل وبدون أي علامات ترقيم نهائيا وخليه قصير ومختصر وطبيعي كأنك تكلم خويك";
                document.getElementById('quote-text').innerHTML = await callGeminiAPI(prompt);
            }

            document.getElementById('najda-button').addEventListener('click', () => {
                stopBreathingCycle();
                homePage.classList.remove('active');
                breathingPage.classList.add('active');
                let remainingTime = 57;
                const breathingTimerEl = document.getElementById('breathing-timer');
                countdownInterval = setInterval(() => {
                    remainingTime--;
                    breathingTimerEl.textContent = `الوقت المتبقي: ${remainingTime} ثانية`;
                    if (remainingTime < 0) { stopBreathingCycle(); showQuotePage(); }
                }, 1000);
                
                const breathingTextEl = document.getElementById('breathing-text');
                function cycle() {
                    breathingTextEl.textContent = 'شهيق';
                    breathingTimeouts.push(setTimeout(() => { breathingTextEl.textContent = 'حبس النفس'; }, 4000));
                    breathingTimeouts.push(setTimeout(() => { breathingTextEl.textContent = 'زفير'; }, 11000));
                    breathingTimeouts.push(setTimeout(cycle, 19000));
                }
                cycle();
            });

            document.getElementById('close-breathing-btn').addEventListener('click', () => {
                stopBreathingCycle();
                breathingPage.classList.remove('active');
                homePage.classList.add('active');
            });
            document.getElementById('close-quote-btn').addEventListener('click', () => {
                quotePage.classList.remove('active');
                homePage.classList.add('active');
            });
            document.getElementById('skip-to-quote-btn').addEventListener('click', () => {
                stopBreathingCycle();
                showQuotePage();
            });
            
            const cardElement = document.querySelector('.progress-timer-card');
            const imageElement = document.getElementById('counter-image-bg');
            const overlayElement = document.querySelector('.image-background-overlay');
            const setImageButton = document.getElementById('set-image-button');
            const removeBackgroundButton = document.getElementById('remove-background-button');
            const imageFilePicker = document.getElementById('image-file-picker');

            function setCounterBackgroundImage(imageUrl) {
                if (imageUrl) {
                    cardElement.style.background = 'none';
                    overlayElement.classList.add('visible');
                    imageElement.src = imageUrl;
                    imageElement.classList.add('visible');
                } else {
                    cardElement.style.background = '';
                    overlayElement.classList.remove('visible');
                    imageElement.classList.remove('visible');
                }
            }
            
            function listenForBackgroundImageChanges() {
                onSnapshot(doc(db, "app_config", "background_image"), (doc) => {
                    setCounterBackgroundImage(doc.exists() ? doc.data().url : null);
                });
            }

            async function uploadImageToCloudinary(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'back photo');
                formData.append('folder', 'back photo'); 
                showSpinner();
                try {
                    setImageButton.innerHTML = `<span>جاري الرفع...</span>`;
                    setImageButton.disabled = true;
                    const response = await fetch(`https://api.cloudinary.com/v1_1/dsf3gudnd/image/upload`, { method: 'POST', body: formData });
                    const data = await response.json();
                    return data.secure_url || null;
                } catch (error) { return null; }
                finally {
                     setImageButton.innerHTML = `<span>تعيين صورة خلفية</span><div class="icon-container green"><i class="bi bi-image"></i></div>`;
                     setImageButton.disabled = false;
                     hideSpinner();
                }
            }
            
            async function updateBackgroundImageInFirestore(url) {
                showSpinner();
                try {
                    await setDoc(doc(db, "app_config", "background_image"), { url: url }, { merge: true });
                } finally {
                    hideSpinner();
                }
            }

            setImageButton.addEventListener('click', () => imageFilePicker.click());
            removeBackgroundButton.addEventListener('click', async () => {
                await updateBackgroundImageInFirestore(null);
                closeSettingsModal();
            });

            imageFilePicker.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    const imageUrl = await uploadImageToCloudinary(file);
                    if (imageUrl) await updateBackgroundImageInFirestore(imageUrl);
                    closeSettingsModal();
                }
            });

            setupGeminiFeatures();

            // --- START: Commitment Document logic ---
            const formPage = document.getElementById('form-page');
            const documentPage = document.getElementById('document-page');
            const editPage = document.getElementById('edit-page');
            const createForm = document.getElementById('commitment-form');
            const editForm = document.getElementById('commitment-form-edit');
            const editBtn = document.getElementById('edit-btn');
            const deleteBtn = document.getElementById('delete-btn');
            const commitmentPages = { formPage, documentPage, editPage };
            const userSignatureEl = document.getElementById('user-signature');

            const showCommitmentPage = (pageId) => {
                Object.values(commitmentPages).forEach(page => {
                    page.classList.remove('hidden'); 
                    if (page.id === pageId) {
                        page.classList.add('visible');
                    } else {
                        page.classList.remove('visible');
                    }
                });
                const visiblePage = document.querySelector('#commitment-document-page .visible');
                if (visiblePage) {
                    visiblePage.scrollTo(0, 0);
                }
            };

            const populateDocument = (data) => {
                document.getElementById('damages-output').textContent = data.damages || '';
                document.getElementById('fears-output').textContent = data.fears || '';
                document.getElementById('responses-output').textContent = data.responses || '';
                document.getElementById('benefits-output').textContent = data.benefits || '';
                document.getElementById('escape-plan-output').textContent = data.escapePlan || '';
                document.getElementById('message-output').textContent = data.message || '';
                document.getElementById('current-date-doc').textContent = new Date().toLocaleDateString('ar-EG');
            };

            const populateEditForm = (data) => {
                document.getElementById('edit-damages').value = data.damages || '';
                document.getElementById('edit-fears').value = data.fears || '';
                document.getElementById('edit-responses').value = data.responses || '';
                document.getElementById('edit-benefits').value = data.benefits || '';
                document.getElementById('edit-escape-plan').value = data.escapePlan || '';
                document.getElementById('edit-message').value = data.message || '';
            };

            const loadCommitmentData = async () => {
                const user = auth.currentUser;
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const docRef = doc(db, "users", user.uid, "commitment", "document");
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            populateDocument(data);
                            if(userSignatureEl) userSignatureEl.textContent = user.displayName || 'مستخدم';
                            showCommitmentPage('document-page');
                        } else {
                            showCommitmentPage('form-page');
                        }
                    } else {
                        const savedData = localStorage.getItem('commitmentDocument');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            populateDocument(data);
                            if(userSignatureEl) userSignatureEl.textContent = 'زائر';
                            showCommitmentPage('document-page');
                        } else {
                            showCommitmentPage('form-page');
                        }
                    }
                } finally {
                    hideSpinner();
                }
            };

            const saveCommitmentData = async (data) => {
                const user = auth.currentUser;
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const docRef = doc(db, "users", user.uid, "commitment", "document");
                        await setDoc(docRef, data);
                    } else {
                        localStorage.setItem('commitmentDocument', JSON.stringify(data));
                    }
                } finally {
                    hideSpinner();
                }
            };

            const deleteCommitmentData = async () => {
                const user = auth.currentUser;
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const docRef = doc(db, "users", user.uid, "commitment", "document");
                        await deleteDoc(docRef);
                    } else {
                        localStorage.removeItem('commitmentDocument');
                    }
                } finally {
                    hideSpinner();
                }
            };


            createForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const data = {
                    damages: document.getElementById('damages').value,
                    fears: document.getElementById('fears').value,
                    responses: document.getElementById('responses').value,
                    benefits: document.getElementById('benefits').value,
                    escapePlan: document.getElementById('escape-plan').value,
                    message: document.getElementById('message').value
                };
                await saveCommitmentData(data);
                populateDocument(data);
                if(userSignatureEl) userSignatureEl.textContent = (user && !user.isAnonymous) ? (user.displayName || 'مستخدم') : 'زائر';
                showCommitmentPage('document-page');
            });

            editBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                let data;
                showSpinner();
                try {
                    if (user && !user.isAnonymous) {
                        const docRef = doc(db, "users", user.uid, "commitment", "document");
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            data = docSnap.data();
                        }
                    } else {
                        const savedData = localStorage.getItem('commitmentDocument');
                        if (savedData) data = JSON.parse(savedData);
                    }

                    if (data) {
                        populateEditForm(data);
                        showCommitmentPage('edit-page');
                    }
                } finally {
                    hideSpinner();
                }
            });


            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const updatedData = {
                    damages: document.getElementById('edit-damages').value,
                    fears: document.getElementById('edit-fears').value,
                    responses: document.getElementById('edit-responses').value,
                    benefits: document.getElementById('edit-benefits').value,
                    escapePlan: document.getElementById('edit-escape-plan').value,
                    message: document.getElementById('edit-message').value
                };
                await saveCommitmentData(updatedData);
                populateDocument(updatedData);
                if(userSignatureEl) userSignatureEl.textContent = (user && !user.isAnonymous) ? (user.displayName || 'مستخدم') : 'زائر';
                showCommitmentPage('document-page');
            });

            deleteBtn.addEventListener('click', () => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-auto text-center">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">تأكيد الحذف</h3>
                        <p class="text-gray-600 mb-6">هل أنت متأكد من أنك تريد حذف الوثيقة؟ لا يمكن التراجع عن هذا الإجراء.</p>
                        <div class="flex justify-center space-x-4 space-x-reverse">
                            <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">حذف</button>
                            <button id="cancel-delete-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                    await deleteCommitmentData();
                    createForm.reset();
                    document.body.removeChild(modal);
                    showCommitmentPage('form-page');
                });
                document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            // --- END: Commitment Document logic ---


            // --- START: New Navigation Logic ---
            const commitmentPageContainer = document.getElementById('commitment-document-page');
            const commitmentBtn = document.getElementById('commitment-btn');
            const backToHomeBtn = document.getElementById('back-to-home-btn');

            if(commitmentBtn) {
                commitmentBtn.addEventListener('click', async () => {
                    await loadCommitmentData(); // Load data before showing the page
                    if(homePage) homePage.classList.remove('active');
                    if(commitmentPageContainer) commitmentPageContainer.classList.add('active');
                });
            }

            if(backToHomeBtn) {
                backToHomeBtn.addEventListener('click', () => {
                    if(commitmentPageContainer) commitmentPageContainer.classList.remove('active');
                    if(homePage) homePage.classList.add('active');
                });
            }
            // --- END: New Navigation Logic ---

            // --- START: Sleep AI Logic ---
            const sleepPage = document.getElementById('sleep-improvement-page');
            const sleepAiBtn = document.getElementById('sleep-ai-btn');
            const backFromSleepBtn = document.getElementById('back-to-home-from-sleep-btn');
            
            const logSection = document.getElementById('sleep-log-section');
            const questionSection = document.getElementById('daily-question-section');
            const analysisSection = document.getElementById('sleep-analysis-section');

            const sleepTimeInput = document.getElementById('sleep-time-input');
            const wakeTimeInput = document.getElementById('wake-time-input');
            const durationDisplay = document.getElementById('sleep-duration-display');
            const submitSleepTimeBtn = document.getElementById('submit-sleep-time-btn');
            const cancelSleepTimeBtn = document.getElementById('cancel-sleep-time-btn');

            
            const questionTextEl = document.getElementById('daily-question-text');
            const questionOptionsContainer = document.getElementById('daily-question-options-container');

            const weeklyAnalysisContainer = document.getElementById('weekly-analysis-container');
            const analysisLastUpdatedEl = document.getElementById('analysis-last-updated');
            let sleepChartInstance = null;
            let tempTimeData = {};

            const dailyQuestions = [
                { key: 'mood', text: 'كيف كان مودك امس بشكل عام', options: ['رايق وممتاز', 'عادي', 'متضايق شوي', 'مره معصب'] },
                { key: 'energy', text: 'وكيف كانت طاقتك ونشاطك امس', options: ['طاقة عالية', 'نشيط نوعا ما', 'خامل وكسلان', 'مره تعبان'] },
                { key: 'food', text: 'اكلت اكل دسم او ثقيل قبل النوم امس', options: ['ايه اكلت وجبة دسمة', 'اكلت شي خفيف', 'لا ما اكلت شي', 'ما اذكر والله'] },
                { key: 'screen_time', text: 'كم ساعة تقريبا استخدمت جوالك امس قبل تنام', options: ['اقل من ساعة', 'ساعة الى ساعتين', 'اكثر من ساعتين', 'ما استخدمته'] },
                { key: 'exercise', text: 'سويت اي رياضة او مجهود بدني امس', options: ['ايه تمرنت', 'مشيت شوي', 'لا ما تحركت', 'شغل البيت بس'] },
                { key: 'caffeine', text: 'شربت قهوة او شاهي بعد المغرب امس', options: ['ايه شربت كثير', 'كوب واحد بس', 'لا ما شربت', 'ما اذكر'] },
                { key: 'stress', text: 'هل حسيت بضغط او توتر كبير امس', options: ['ايه مره كنت مضغوط', 'شوي بس', 'لا يومي كان هادي', 'عادي يعني'] },
            ];

            // --- START: Firestore Sleep Data Functions for REGISTERED users ---
            async function getSleepDataFromFirestore() {
                const user = auth.currentUser;
                if (!user || user.isAnonymous) return { log: [], analysis: null, askedQuestions: [] };
                const sleepDataRef = doc(db, "users", user.uid, "sleepData", "main");
                try {
                    const docSnap = await getDoc(sleepDataRef);
                    const defaultData = { log: [], analysis: null, askedQuestions: [] };
                    if (docSnap.exists()) {
                        return { ...defaultData, ...docSnap.data() };
                    }
                    return defaultData;
                } catch (error) {
                    console.error("Error getting sleep data from Firestore:", error);
                    return { log: [], analysis: null, askedQuestions: [] };
                }
            }

            async function saveSleepDataToFirestore(data) {
                const user = auth.currentUser;
                if (!user || user.isAnonymous) return;
                const sleepDataRef = doc(db, "users", user.uid, "sleepData", "main");
                try {
                    await setDoc(sleepDataRef, data);
                } catch (error) {
                    console.error("Error saving sleep data to Firestore:", error);
                }
            }
            // --- END: Firestore Sleep Data Functions ---

            // --- START: LocalStorage Sleep Data Functions for VISITORS ---
            function getSleepDataFromLocalStorage() {
                try {
                    const log = JSON.parse(localStorage.getItem('sleepLogData_v2')) || [];
                    const analysis = JSON.parse(localStorage.getItem('weeklySleepAnalysis_v2')) || null;
                    const askedQuestions = JSON.parse(localStorage.getItem('askedSleepQuestions_v2')) || [];
                    return { log, analysis, askedQuestions };
                } catch {
                    return { log: [], analysis: null, askedQuestions: [] };
                }
            }

            function saveSleepLogToLocalStorage(data) {
                localStorage.setItem('sleepLogData_v2', JSON.stringify(data));
            }

            function saveWeeklyAnalysisToLocalStorage(analysis) {
                 localStorage.setItem('weeklySleepAnalysis_v2', JSON.stringify(analysis));
            }

            function saveAskedQuestionsToLocalStorage(indices) {
                localStorage.setItem('askedSleepQuestions_v2', JSON.stringify(indices));
            }
            // --- END: LocalStorage Sleep Data Functions ---

            // --- START: Wrapper Functions ---
            async function getSleepLog() {
                const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    return data.log;
                } else {
                    return getSleepDataFromLocalStorage().log;
                }
            }

            async function saveSleepLog(newLog) {
                const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    data.log = newLog;
                    await saveSleepDataToFirestore(data);
                } else {
                    saveSleepLogToLocalStorage(newLog);
                }
            }
            
            async function getWeeklyAnalysis() {
                 const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    return data.analysis;
                } else {
                    return getSleepDataFromLocalStorage().analysis;
                }
            }

            async function saveWeeklyAnalysis(analysis) {
                 const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    data.analysis = analysis;
                    await saveSleepDataToFirestore(data);
                } else {
                    saveWeeklyAnalysisToLocalStorage(analysis);
                }
            }

            async function getAskedQuestions() {
                const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    return data.askedQuestions;
                } else {
                    return getSleepDataFromLocalStorage().askedQuestions;
                }
            }

            async function saveAskedQuestions(indices) {
                const user = auth.currentUser;
                if (user && !user.isAnonymous) {
                    const data = await getSleepDataFromFirestore();
                    data.askedQuestions = indices;
                    await saveSleepDataToFirestore(data);
                } else {
                   saveAskedQuestionsToLocalStorage(indices);
                }
            }
            // --- END: Wrapper Functions ---
            
            async function getSleepAIResponse(prompt) {
                 const fullPrompt = `انت مساعد متخصص في تحسين النوم باللهجة السعودية العامية ومهمتك تعطي نصايح وتحليلات بناء على معلومات المستخدم

                شروطك:
                1 تكلم باللهجة السعودية العامية فقط
                2 لا تستخدم ابدا اي علامات ترقيم مثل الفاصلة او النقطة
                3 لا تستخدم ابدا اي حركات تشكيل مثل الفتحة او الضمة

                هذا هو الطلب:
                ${prompt}`;
                return await callGeminiAPI(fullPrompt);
            }

            function showSection(section) {
                logSection.classList.add('hidden-section');
                questionSection.classList.add('hidden-section');
                analysisSection.classList.add('hidden-section');
                section.classList.remove('hidden-section');
            }
            
            function formatTime12Hour(time24) {
                if (!time24) return '';
                let [hours, minutes] = time24.split(':');
                hours = parseInt(hours, 10);
                const period = hours >= 12 ? 'مساء' : 'صباحا';
                hours = hours % 12 || 12; 
                return `${hours}:${minutes} ${period}`;
            }

            function calculateSleepDuration(sleepTime, wakeTime) {
                const sleep = new Date(`1970-01-01T${sleepTime}:00`);
                const wake = new Date(`1970-01-01T${wakeTime}:00`);

                if (wake <= sleep) {
                    wake.setDate(wake.getDate() + 1);
                }

                const diff = wake.getTime() - sleep.getTime();
                const totalHours = diff / (1000 * 60 * 60);
                const hours = Math.floor(totalHours);
                const minutes = Math.round((totalHours - hours) * 60);

                return {
                    decimal: parseFloat(totalHours.toFixed(1)),
                    formatted: `نمت لمدة ${hours} ساعات و ${minutes} دقايق`
                };
            }
            
            async function initSleepFeature() {
                const todayStr = new Date().toISOString().split('T')[0];
                const sleepLog = await getSleepLog();
                const todayEntry = sleepLog.find(entry => entry.date === todayStr);

                if (todayEntry) {
                    showSleepAnalysis();
                } else {
                    durationDisplay.classList.add('hidden-section');
                    showSection(logSection);
                }
            }
            
            cancelSleepTimeBtn.addEventListener('click', () => {
                sleepTimeInput.value = '';
                wakeTimeInput.value = '';
                durationDisplay.classList.add('hidden-section');
                showSection(logSection);
                 if(sleepPage) sleepPage.classList.remove('active');
                 if(homePage) homePage.classList.add('active');
            });


            submitSleepTimeBtn.addEventListener('click', () => {
                const sleepTime = sleepTimeInput.value;
                const wakeTime = wakeTimeInput.value;
                if (!sleepTime || !wakeTime) {
                    durationDisplay.textContent = 'الرجاء ادخال وقت النوم والصحيان';
                    durationDisplay.classList.remove('hidden-section');
                    return;
                }
                const duration = calculateSleepDuration(sleepTime, wakeTime);
                durationDisplay.textContent = duration.formatted;
                durationDisplay.classList.remove('hidden-section');

                tempTimeData = { sleepTime, wakeTime, duration: duration.decimal };
                
                showDailyQuestion(tempTimeData);
            });
            
            async function showDailyQuestion(timeData) {
                let askedIndices = await getAskedQuestions();
                if (askedIndices.length >= dailyQuestions.length) {
                    askedIndices = []; // Reset if all questions asked
                }
                
                let nextQuestionIndex;
                do {
                    nextQuestionIndex = Math.floor(Math.random() * dailyQuestions.length);
                } while (askedIndices.includes(nextQuestionIndex));
                
                const question = dailyQuestions[nextQuestionIndex];
                questionTextEl.textContent = question.text;
                questionOptionsContainer.innerHTML = '';

                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'user-option-btn';
                    button.textContent = option;
                    button.onclick = () => {
                        handleDailyAnswer(timeData, question.key, option, nextQuestionIndex);
                    };
                    questionOptionsContainer.appendChild(button);
                });
                
                showSection(questionSection);
            }
            
            async function handleDailyAnswer(timeData, questionKey, answer, questionIndex) {
                let askedIndices = await getAskedQuestions();
                askedIndices.push(questionIndex);
                await saveAskedQuestions(askedIndices);
                
                const todayStr = new Date().toISOString().split('T')[0];
                const sleepLog = await getSleepLog();

                const newEntry = {
                    date: todayStr,
                    sleepTime: timeData.sleepTime,
                    wakeTime: timeData.wakeTime,
                    duration: timeData.duration,
                    dailyQuestion: {
                        key: questionKey,
                        answer: answer
                    }
                };

                const filteredLog = sleepLog.filter(entry => entry.date !== todayStr);
                const updatedLog = [...filteredLog, newEntry];
                await saveSleepLog(updatedLog);

                showSleepAnalysis(true); 
            }

            function showSleepAnalysis(forceRegenerate = false) {
                showSection(analysisSection);
                renderSleepChart();
                generateWeeklyAnalysis(forceRegenerate);
            }

            async function renderSleepChart() {
                const canvas = document.getElementById('sleepChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const sleepLog = (await getSleepLog()).slice(-7); 

                const labels = sleepLog.map(d => new Date(d.date).toLocaleDateString('ar-EG', { weekday: 'short' }));
                const durations = sleepLog.map(d => d.duration);

                if (sleepChartInstance) {
                    sleepChartInstance.destroy();
                }

                Chart.defaults.color = 'rgba(250, 250, 250, 0.7)';
                Chart.defaults.borderColor = 'rgba(250, 250, 250, 0.2)';
                
                sleepChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ساعات النوم',
                            data: durations,
                            backgroundColor: 'rgba(0, 168, 132, 0.6)',
                            borderColor: 'rgba(0, 168, 132, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                             tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        return sleepLog[index] ? new Date(sleepLog[index].date).toLocaleDateString('ar-EG', { weekday: 'long' }) : '';
                                    },
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const entry = sleepLog[index];
                                        if (!entry) return '';
                                        const sleep = formatTime12Hour(entry.sleepTime);
                                        const wake = formatTime12Hour(entry.wakeTime);
                                        return `نمت: ${sleep} - صحيت: ${wake}`;
                                    },
                                     afterLabel: function(context) {
                                        return `المدة: ${context.raw} ساعة`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'عدد الساعات'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            async function generateWeeklyAnalysis(forceRegenerate) {
                const sleepLog = (await getSleepLog()).slice(-7);
                
                if (sleepLog.length < 1) {
                    weeklyAnalysisContainer.textContent = 'ما فيه بيانات كافية عشان اعطيك تحليل ابدأ سجل نومك اليوم';
                    return;
                }

                const lastEntryDate = sleepLog[sleepLog.length - 1].date;
                const cachedAnalysis = await getWeeklyAnalysis();

                if (!forceRegenerate && cachedAnalysis && cachedAnalysis.date === lastEntryDate) {
                    weeklyAnalysisContainer.textContent = cachedAnalysis.text;
                    analysisLastUpdatedEl.textContent = `آخر تحديث للتحليل: ${new Date(cachedAnalysis.timestamp).toLocaleString('ar-EG')}`;
                    return;
                }

                weeklyAnalysisContainer.innerHTML = `<div class="d-flex justify-content-center align-items-center p-4"><div class="spinner-border" role="status"></div></div>`;
                analysisLastUpdatedEl.textContent = '';
                
                const summary = sleepLog.map(d => `في يوم ${new Date(d.date).toLocaleDateString('ar-EG', { weekday: 'long' })} نمت الساعة ${d.sleepTime} وصحيت الساعة ${d.wakeTime} يعني نمت تقريبا ${d.duration} ساعات وجاوبت على سؤال اليوم بـ ${d.dailyQuestion.answer}`).join(' و ');
                const prompt = `هذا سجل نوم واحد لمدة اسبوع ${summary} بناء على هذي البيانات عطني تحليل مفصل باللهجة السعودية العامية وبدون اي علامات ترقيم او تشكيل ووضح له نمط نومه والاشياء الايجابية والسلبية وعطه نصايح عملية عشان يحسن نومه اكثر`;
                
                const analysisText = await getSleepAIResponse(prompt);

                const newAnalysis = {
                    date: lastEntryDate,
                    text: analysisText,
                    timestamp: new Date().toISOString()
                };
                
                await saveWeeklyAnalysis(newAnalysis);
                
                weeklyAnalysisContainer.textContent = analysisText;
                analysisLastUpdatedEl.textContent = `آخر تحديث للتحليل: الآن`;
            }

            sleepAiBtn.addEventListener('click', () => {
                initSleepFeature();
                sleepPage.classList.add('active');
            });

            backFromSleepBtn.addEventListener('click', () => {
                sleepPage.classList.remove('active');
            });
            // --- END: Sleep AI Logic ---
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(console.error);
            });
        }
    </script>
    
    <!-- Loading Spinner -->
    <div id="loading-spinner-overlay" class="loading-spinner-overlay">
        <div class="loading-spinner"></div>
    </div>
    <!-- End Loading Spinner -->
    
</body>
</html>
