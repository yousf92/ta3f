<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>المتابعة | لا أبرح حتى أبلغ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00a884;
            --danger-color: #ff5c5c;
            --background-color: #121212;
            --card-background: #1e1e1e;
            --text-color: #FAFAFA;
            --secondary-text-color: #CCCCCC;
            --border-color: #383838;
            --orange-color: #fd9843;
            --red-color: #e55454;
            --green-color: #27ae60;
            --grey-color: #6c757d;
            --primary-glow: rgba(0, 168, 132, 0.5);
        }
        body, html {
            margin: 0; padding: 0; font-family: 'Tajawal', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1920&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            position: fixed; width: 100%; height: 100%; overflow: hidden;
        }
        .page { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .content-area { flex-grow: 1; overflow-y: auto; padding: 1.5rem; padding-bottom: 100px; }
        .top-header { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 1rem; 
            background-color: rgba(18, 18, 18, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0; 
        }
        .top-header h5 { text-shadow: 0 0 10px var(--primary-glow); font-weight: 700; margin: 0; }
        .bottom-nav { 
            display: flex; 
            justify-content: space-around; 
            padding: 0.5rem 0; 
            background-color: rgba(30, 30, 30, 0.5); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            box-shadow: 0 -2px 15px rgba(0,0,0,0.3); 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            z-index: 100; 
            border-top: 1px solid rgba(56, 56, 56, 0.5);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text-color); text-decoration: none; font-size: 0.75rem; cursor: pointer; width: 14%; height: 50px; justify-content: center; transition: color 0.3s ease; }
        .nav-item:hover { color: var(--text-color); }
        .nav-item i { font-size: 1.5rem; margin-bottom: 4px; transition: transform 0.3s ease; }
        .nav-item:hover i { transform: translateY(-3px); }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.special-item { transform: translateY(-20px); position: relative; } 
        .special-item .icon-background { background: linear-gradient(135deg, #00a884, #00c896); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px var(--primary-glow); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .special-item:hover .icon-background { transform: scale(1.1); box-shadow: 0 6px 20px var(--primary-glow); }
        .special-item i { color: white; font-size: 2rem; margin: 0; }

        .chat-notification-badge {
            position: absolute;
            top: -8px; 
            right: 25px; 
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 13px;
            font-weight: bold;
            display: none; 
            justify-content: center;
            align-items: center;
            border: 2px solid var(--card-background);
            z-index: 1;
        }

        /* START: Modified Stat Grid Styling */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 equal columns */
            gap: 0.75rem;
        }
        .stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 12px;
            text-align: center;
            color: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(0,0,0,0.2);
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            opacity: 0.8;
        }
        .stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .stat-label { 
            font-family: 'Amiri', serif;
            font-size: 0.9rem;
            font-weight: 700;
            opacity: 0.95; 
            margin-top: 4px;
        }
        .stat-card.orange, .stat-card.red, .stat-card.green, .stat-card.grey {
            background-blend-mode: overlay;
        }
        .stat-card.orange { background-color: rgba(253, 152, 67, 0.5); }
        .stat-card.red { background-color: rgba(229, 84, 84, 0.5); }
        .stat-card.green { background-color: rgba(39, 174, 96, 0.5); }
        .stat-card.grey { background-color: rgba(108, 117, 125, 0.5); }
        /* END: Modified Stat Grid Styling */

        .calendar-container {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            background-image: url('https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=1920');
            background-size: cover;
            background-position: center;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        .calendar-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(18, 18, 18, 0.6);
            backdrop-filter: blur(1px);
            z-index: 1;
        }
        .calendar-container > * {
            position: relative;
            z-index: 2;
        }
        .calendar-card {
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            margin-top: 1.5rem;
        }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .calendar-header button { background-color: rgba(255,255,255,0.1); border-radius: 50%; border: none; color: var(--text-color); width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; transition: background-color 0.3s ease; }
        .calendar-header button:hover { background-color: rgba(255,255,255,0.2); }
        #month-year { font-size: 1.3rem; font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
        .calendar-day, .weekday { text-align: center; font-size: 0.9rem; height: 40px; display: flex; align-items: center; justify-content: center; }
        .weekday { color: var(--secondary-text-color); font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .calendar-day { border-radius: 50%; cursor: pointer; transition: all 0.3s ease; background-color: rgba(255,255,255,0.05); }
        .calendar-day.other-month { opacity: 0.3; pointer-events: none; }
        .calendar-day.today { border: 2px solid var(--primary-color); box-shadow: 0 0 10px var(--primary-glow); }
        .calendar-day.orange { background-color: var(--orange-color); color: white; }
        .calendar-day.red { background-color: var(--red-color); color: white; }
        .calendar-day.green { background-color: var(--green-color); color: white; }
        .calendar-day.grey { background-color: var(--grey-color); color: white; }
        .calendar-day:not(.other-month):hover { transform: scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.2); }

        .add-status-button {
            position: fixed;
            bottom: 95px;
            left: 20px;
            width: 55px;
            height: 55px;
            background: linear-gradient(45deg, var(--primary-color), #00c896);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.7rem;
            box-shadow: 0 5px 20px rgba(0, 168, 132, 0.4);
            z-index: 105;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .add-status-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 168, 132, 0.5);
        }
        #addStatusModal .modal-content { border-radius: 20px; }
        #addStatusModal .btn-lg { border-radius: 12px; font-weight: 700; padding: 1rem; }

        #app-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(18, 18, 18, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .lock-container {
            text-align: center;
            padding: 2rem;
            background-color: var(--card-background);
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }
        .lock-container .icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        #passcode-input {
            max-width: 200px;
            margin: 1.5rem auto;
            letter-spacing: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
            direction: ltr;
        }
        #passcode-input::placeholder { letter-spacing: normal; }
        #unlock-btn { width: 100%; max-width: 200px; }
        #passcode-error { display: none; color: var(--danger-color); font-size: 0.9rem; margin-top: 1rem; }

        .gemini-frame {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            padding: 1.5rem;
            background-size: cover;
            background-position: center;
            transition: background-image 0.7s ease-in-out;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .gemini-frame::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(18, 18, 18, 0.75); 
            backdrop-filter: blur(2px);
            z-index: 1;
        }
        .gemini-frame > * {
            position: relative;
            z-index: 2;
        }

        /* START: New Celebration Style */
        .celebration-result {
            position: relative;
            background-size: cover;
            background-position: center;
            transition: background-image 0.7s ease-in-out;
            color: var(--text-color);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .celebration-result::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        .celebration-result > * {
            position: relative;
            z-index: 2;
        }
        /* END: New Celebration Style */

        .gemini-frame .form-label, 
        .gemini-frame .result-text {
            color: var(--text-color);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .gemini-frame .result-container {
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* START: New Analysis Style Toggle */
        .analysis-toggle-group {
            display: flex;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .analysis-toggle-btn {
            flex: 1;
            background-color: transparent;
            border: none;
            color: var(--secondary-text-color);
            padding: 0.75rem 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Amiri', serif;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .analysis-toggle-btn:not(:last-child) {
            border-left: 1px solid var(--border-color);
        }
        .analysis-toggle-btn.active {
            background-color: var(--primary-color);
            color: white;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        .analysis-toggle-btn:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
        }
        /* END: New Analysis Style Toggle */

        /* START: Background Theme Styles */
        body.solid-black-bg {
            background-image: none !important;
            background-color: #000000 !important;
        }
        body.gradient-blue-bg {
            background-image: linear-gradient(135deg, #0f2027, #203a43, #2c5364) !important;
        }
        /* END: Background Theme Styles */

        /* START: Fix for result text color */
        #contextual-gemini-result-text {
            color: var(--text-color); /* Ensures the text is always white/light */
        }
        /* END: Fix for result text color */
    </style>
</head>
<body>
    <div id="app-lock-overlay">
        <div class="lock-container">
            <i class="bi bi-shield-lock-fill icon"></i>
            <h5>التطبيق مقفل</h5>
            <p class="text-secondary small">أدخل رمز المرور للمتابعة</p>
            <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="form-control" id="passcode-input" placeholder="----">
            <div id="passcode-error">رمز المرور غير صحيح</div>
            <button id="unlock-btn" class="btn btn-primary mt-2">فتح القفل</button>
        </div>
    </div>

    <div class="page" style="display: flex;">
        <header class="top-header">
            <h5 class="m-0">المتابعة</h5>
        </header>
        <main class="content-area">
            
            <div class="calendar-container">
                <div class="stats-grid">
                    <div class="stat-card orange">
                        <i class="bi bi-calendar-x stat-icon"></i>
                        <div id="absence-count" class="stat-number">0</div>
                        <div class="stat-label">غياب</div>
                    </div>
                    <div class="stat-card grey">
                        <i class="bi bi-arrow-down-circle stat-icon"></i>
                        <div id="relapse-count" class="stat-number">0</div>
                        <div class="stat-label">انتكاسة</div>
                    </div>
                    <div class="stat-card red">
                        <i class="bi bi-exclamation-triangle stat-icon"></i>
                        <div id="slip-count" class="stat-number">0</div>
                        <div class="stat-label">زلة</div>
                    </div>
                    <div class="stat-card green">
                        <i class="bi bi-check-circle-fill stat-icon"></i>
                        <div id="victory-count" class="stat-number">0</div>
                        <div class="stat-label">انتصار</div>
                    </div>
                </div>

                <div class="calendar-card">
                    <div class="calendar-header">
                        <button id="prev-month"><i class="bi bi-chevron-right"></i></button>
                        <div id="month-year"></div>
                        <button id="next-month"><i class="bi bi-chevron-left"></i></button>
                    </div>
                    <div class="calendar-grid" id="weekdays"></div>
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
            </div>
            
            <div id="contextual-gemini-card" class="card mt-4 d-none" style="background-color: var(--card-background); border-radius: 15px; border: 1px solid var(--primary-color); box-shadow: 0 0 15px var(--primary-glow);">
                <div class="card-body text-center">
                    <h6 id="contextual-gemini-title" class="mb-3 fw-bold"></h6>
                    <button id="contextual-gemini-btn" class="btn btn-warning w-100 fw-bold"></button>
                    <div id="contextual-gemini-result-container" class="mt-3 p-3 rounded d-none" style="background-color: var(--background-color);">
                        <p id="contextual-gemini-result-text" class="mb-0" style="white-space: pre-wrap;"></p>
                    </div>
                </div>
            </div>

            <div id="analysis-frame" class="gemini-frame mt-4">
                 <div class="analysis-options mb-3">
                     <label class="form-label small fw-bold">اختر أسلوب التحليل</label>
                     <div id="analysis-style-group" class="analysis-toggle-group">
                        <button class="analysis-toggle-btn active" data-style="advisor">
                            <i class="bi bi-shield-heart me-2"></i><span>ناصح أمين</span>
                        </button>
                        <button class="analysis-toggle-btn" data-style="leader">
                            <i class="bi bi-award me-2"></i><span>قائد ملهم</span>
                        </button>
                    </div>
                 </div>
                 <button id="analyze-performance-btn" class="btn btn-info w-100 fw-bold">
                      <i class="bi bi-magic me-2"></i>حلل أدائي
                 </button>
                 <div id="analysis-result-container" class="result-container mt-3 p-3 rounded d-none">
                      <p id="analysis-result-text" class="result-text mb-0" style="white-space: pre-wrap;"></p>
                 </div>
            </div>

        </main>

        <button class="add-status-button" data-bs-toggle="modal" data-bs-target="#addStatusModal" title="إضافة حالة اليوم">
            <i class="bi bi-plus-lg"></i>
        </button>

        <nav class="bottom-nav">
            <a href="main.html" class="nav-item"><i class="bi bi-house-door-fill"></i><span>الرئيسية</span></a>
            <a href="diaries.html" class="nav-item"><i class="bi bi-book-fill"></i><span>اليوميات</span></a>
            <a href="articles.html" class="nav-item"><i class="bi bi-check2-square"></i><span>العادات</span></a>
            <a href="chat.html" class="nav-item special-item">
                <div class="icon-background"><i class="bi bi-chat-dots-fill"></i></div>
                <span>دردشة</span>
                <span class="chat-notification-badge"></span>
            </a>
            <a href="follow-up.html" class="nav-item active"><i class="bi bi-signpost-split-fill"></i><span>المتابعة</span></a>
            <a href="library.html" class="nav-item"><i class="bi bi-collection-fill"></i><span>المكتبة</span></a>
            <a href="settings.html" class="nav-item"><i class="bi bi-gear-fill"></i><span>الاعدادات</span></a>
        </nav>
    </div>

    <div class="modal fade" id="addStatusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: var(--card-background);">
                <div class="modal-header" style="border-bottom-color: var(--border-color);">
                    <h5 class="modal-title">كيف كان يومك؟</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1)"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">اختر الحالة التي تريد تسجيلها لتاريخ اليوم.</p>
                    <div class="d-grid gap-3">
                        <button class="btn btn-lg" style="background-color: var(--grey-color); color: white;" data-status="relapse">انتكاسة</button>
                        <button class="btn btn-lg" style="background-color: var(--red-color); color: white;" data-status="slip">زلة</button>
                        <button class="btn btn-lg" style="background-color: var(--green-color); color: white;" data-status="victory">انتصار</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // --- START: Added Spinner Functions ---
        function showSpinner() {
            const spinner = document.getElementById('loading-spinner-overlay');
            if (spinner) {
                spinner.classList.add('show');
            }
        }

        function hideSpinner() {
            const spinner = document.getElementById('loading-spinner-overlay');
            if (spinner) {
                spinner.classList.remove('show');
            }
        }
        // --- END: Added Spinner Functions ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGgZmhJ_mMezlf7xElisvzJ8l9D758d4g",
            authDomain: "my-chat-app-daaf8.firebaseapp.com",
            projectId: "my-chat-app-daaf8",
            storageBucket: "my-chat-app-daaf8.firebasestorage.app",
            messagingSenderId: "789086064752",
            appId: "1:789086064752:web:d081f1b6832dabca1d64b5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- START: Background Theme Logic ---
        function applyBackgroundPreference() {
            const savedTheme = localStorage.getItem('appBackgroundTheme') || 'default';
            const body = document.body;
            
            body.classList.remove('solid-black-bg', 'gradient-blue-bg');
            
            if (savedTheme === 'solid-black') {
                body.classList.add('solid-black-bg');
            } else if (savedTheme === 'gradient-blue') {
                body.classList.add('gradient-blue-bg');
            }
            // If 'default', no class is added, and the original CSS background is used.
        }

        // Apply the theme as soon as the script runs
        applyBackgroundPreference();
        // --- END: Background Theme Logic ---

        function initializeGlobalChatNotifications(userId) {
            const chatBadge = document.querySelector('.chat-notification-badge');
            if (!chatBadge) return;
            let publicUnreadCount = 0;
            let privateUnreadCount = 0;
            function updateBadge() {
                const totalUnread = publicUnreadCount + privateUnreadCount;
                if (totalUnread > 0) {
                    chatBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                    chatBadge.style.display = 'flex';
                } else {
                    chatBadge.style.display = 'none';
                }
            }
            if (window.publicListenerUnsubscribe) window.publicListenerUnsubscribe();
            if (window.privateListenerUnsubscribe) window.privateListenerUnsubscribe();
            const lastReadTimestamp = parseInt(localStorage.getItem('lastReadTimestamp') || '0');
            const messagesRef = collection(db, "messages");
            const publicQuery = query(messagesRef, where("createdAt", ">", Timestamp.fromMillis(lastReadTimestamp)));
            window.publicListenerUnsubscribe = onSnapshot(publicQuery, (snapshot) => {
                let count = 0;
                snapshot.forEach(doc => {
                    if (doc.data().senderId !== userId) count++;
                });
                publicUnreadCount = count;
                updateBadge();
            });
            const userIsAnonymous = auth.currentUser ? auth.currentUser.isAnonymous : true;
            if (!userIsAnonymous) {
                const privateChatsQuery = query(collection(db, "private_chats"), where("participants", "array-contains", userId));
                window.privateListenerUnsubscribe = onSnapshot(privateChatsQuery, (snapshot) => {
                    let count = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!data[`hidden_for_${userId}`]) count += (data[`unread_count_${userId}`] || 0);
                    });
                    privateUnreadCount = count;
                    updateBadge();
                });
            } else {
                privateUnreadCount = 0;
                updateBadge();
            }
        }

        let currentUserId = null;
        let isVisitor = true;
        let userHabitData = {};
        let previousAnalyses = [];

        const appLockOverlay = document.getElementById('app-lock-overlay');
        const passcodeError = document.getElementById('passcode-error');
        const unlockBtn = document.getElementById('unlock-btn');
        const passcodeInput = document.getElementById('passcode-input');
        const RELOCK_TIME = 3 * 60 * 1000;

        function getLockData() {
            try {
                return JSON.parse(localStorage.getItem('app_lock_config')) || { enabled: false, passcode: null };
            } catch (e) { return { enabled: false, passcode: null }; }
        }

        function initializeAppLock() {
            const lockData = getLockData();
            if (!lockData.enabled) return;
            const lastUnlock = localStorage.getItem('app_last_unlock') || 0;
            const timeSinceUnlock = Date.now() - lastUnlock;
            if (timeSinceUnlock >= RELOCK_TIME) appLockOverlay.style.display = 'flex';
        }

        function handleUnlock() {
            const enteredPasscode = passcodeInput.value;
            const lockData = getLockData();
            passcodeError.style.display = 'none';
            if (enteredPasscode === lockData.passcode) {
                localStorage.setItem('app_last_unlock', Date.now());
                appLockOverlay.style.display = 'none';
                passcodeInput.value = '';
            } else {
                passcodeError.style.display = 'block';
                passcodeInput.classList.add('is-invalid');
                setTimeout(() => passcodeInput.classList.remove('is-invalid'), 1000);
            }
        }

        unlockBtn.addEventListener('click', handleUnlock);
        passcodeInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') handleUnlock();
        });

        function callGeminiAPI(prompt) {
            showSpinner();
            return new Promise((resolve, reject) => {
                const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw5WTzuAoDYaqGGrgVFUheHZmTtpo9n5fYw1fI-nkNuUV6VYjHt1n6cloK74oE2c1aaVQ/exec";
                
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());

                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    if (data.error) {
                        console.error("Error from Apps Script:", data.error);
                        resolve("عفوًا، حدثت مشكلة مؤقتة. يرجى المحاولة مرة أخرى لاحقًا.");
                    } else {
                        resolve(data.text);
                    }
                    hideSpinner();
                };

                const script = document.createElement('script');
                script.src = WEB_APP_URL + '?callback=' + callbackName + '&prompt=' + encodeURIComponent(prompt);
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve("  إذا أردت إرسال طلب آخر اضغط على أيقونة المتابعة في الشريط السفلي  .");
                    hideSpinner();
                };

                document.body.appendChild(script);
            });
        }

        onAuthStateChanged(auth, (user) => {
            initializeAppLock();
            setInterval(() => {
                if (document.visibilityState === 'visible') localStorage.setItem('app_last_unlock', Date.now());
            }, 60 * 1000);
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') initializeAppLock();
            });
            if (user) {
                initializeGlobalChatNotifications(user.uid);
                if (user.emailVerified || user.isAnonymous) {
                    isVisitor = user.isAnonymous;
                    currentUserId = user.uid;
                    initializeCalendar();
                }
            } else {
                isVisitor = true;
                currentUserId = null;
                initializeCalendar();
            }
        });

        const monthYearEl = document.getElementById('month-year');
        const weekdaysEl = document.getElementById('weekdays');
        const daysEl = document.getElementById('calendar-days');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const addStatusModal = new bootstrap.Modal(document.getElementById('addStatusModal'));

        const analyzeFrame = document.getElementById('analysis-frame');
        const analyzeBtn = document.getElementById('analyze-performance-btn');
        const analysisResultContainer = document.getElementById('analysis-result-container');
        const analysisResultText = document.getElementById('analysis-result-text');

        const contextualCard = document.getElementById('contextual-gemini-card');
        const contextualTitle = document.getElementById('contextual-gemini-title');
        const contextualBtn = document.getElementById('contextual-gemini-btn');
        const contextualResultContainer = document.getElementById('contextual-gemini-result-container');
        const contextualResultText = document.getElementById('contextual-gemini-result-text');

        let currentDate = new Date();

        async function getHabitData() {
            showSpinner();
            try {
                if (isVisitor) {
                    try {
                        const localData = localStorage.getItem('visitorHabitData');
                        userHabitData = localData ? JSON.parse(localData) : {};
                    } catch (e) { userHabitData = {}; }
                } else {
                    if (!currentUserId) return {};
                    const userDocRef = doc(db, "users", currentUserId);
                    const docSnap = await getDoc(userDocRef);
                    userHabitData = (docSnap.exists() && docSnap.data().habitData) ? docSnap.data().habitData : {};
                }
            } finally {
                hideSpinner();
            }
            return userHabitData;
        }

        async function saveHabitData(data) {
            userHabitData = data;
            showSpinner();
            try {
                if (isVisitor) {
                    localStorage.setItem('visitorHabitData', JSON.stringify(data));
                } else {
                    if (!currentUserId) return;
                    const userDocRef = doc(db, "users", currentUserId);
                    try {
                        await setDoc(userDocRef, { habitData: data }, { merge: true });
                    } catch (error) { console.error("Error saving habit data: ", error); }
                }
            } finally {
                hideSpinner();
            }
        }

        function toDateString(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        async function autoFillAbsence() {
            const habitData = await getHabitData();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const firstEntryDateStr = Object.keys(habitData).sort()[0];
            if (!firstEntryDateStr) return;
            let loopDate = new Date(firstEntryDateStr);
            let hasChanged = false;
            while (loopDate < today) {
                const dateStr = toDateString(loopDate);
                if (!habitData[dateStr]) {
                    habitData[dateStr] = 'absence';
                    hasChanged = true;
                }
                loopDate.setDate(loopDate.getDate() + 1);
            }
            if (hasChanged) await saveHabitData(habitData);
        }

        const natureBackgrounds = [
            'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=1920',
            'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=1920',
            'https://images.unsplash.com/photo-1433086966358-54859d0ed716?q=80&w=1920',
            'https://images.unsplash.com/photo-1501854140801-50d01698950b?q=80&w=1920',
            'https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?q=80&w=1920',
            'https://images.unsplash.com/photo-1418065460487-3e41a6c84dc5?q=80&w=1920',
            'https://images.unsplash.com/photo-1505852679233-d9fd70aff56d?q=80&w=1920'
        ];
        let lastAnalysisBgIndex = -1;
        let lastCelebrationBgIndex = -1;

        function setRandomBackground(element, type) {
          let randomIndex;
          let lastIndex;
          if (type === 'analysis') {
              lastIndex = lastAnalysisBgIndex;
          } else if (type === 'celebration') {
              lastIndex = lastCelebrationBgIndex;
          }
          
          do {
            randomIndex = Math.floor(Math.random() * natureBackgrounds.length);
          } while (natureBackgrounds.length > 1 && randomIndex === lastIndex);

          if (type === 'analysis') {
              lastAnalysisBgIndex = randomIndex;
          } else if (type === 'celebration') {
              lastCelebrationBgIndex = randomIndex;
          }

          element.style.backgroundImage = `url('${natureBackgrounds[randomIndex]}')`;
        }

        async function updateContextualGeminiFeature() {
            contextualCard.classList.add('d-none');
            contextualResultContainer.classList.add('d-none');
            const sortedDates = Object.keys(userHabitData).sort((a, b) => new Date(b) - new Date(a));
            if (sortedDates.length === 0) return;
            const latestDate = sortedDates[0];
            const latestStatus = userHabitData[latestDate];
            if (latestStatus === 'slip' || latestStatus === 'relapse') {
                contextualTitle.textContent = 'لحظة للتعلّم';
                contextualBtn.innerHTML = '<i class="bi bi-lightbulb-fill me-2"></i>✨ تعلم من هذه التجربة';
                contextualCard.classList.remove('d-none');
                const newBtn = contextualBtn.cloneNode(true);
                contextualBtn.parentNode.replaceChild(newBtn, contextualBtn);
                document.getElementById('contextual-gemini-btn').addEventListener('click', async (e) => {
                    const btn = e.currentTarget;
                    btn.disabled = true;
                    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> جاري استخلاص العبرة...`;
                    const prompt = `بصفتك مرشد حكيم ومتعاطف، مستخدمي مر بتجربة صعبة اليوم في رحلة التعافي (زلة أو انتكاسة). مهمتك هي أن تقدم له رسالة طويلة مرة تساعده على تحويل هذه التجربة إلى فرصة للتعلم والنمو، وليس سببًا لليأس. لا توبخه أبداً. قدم له سؤالاً واحداً فقط يساعده على التفكير في المسبب المحتمل. اختتم الرسالة بتذكير بسيط بأن كل يوم هو فرصة جديدة. التزم باللهجة السعودية العامية، وبدون تشكيل أو علامات ترقيم.`;
                    const result = await callGeminiAPI(prompt);
                    contextualResultText.textContent = result;
                    contextualResultContainer.classList.remove('d-none');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-lightbulb-fill me-2"></i>✨ اطلب نصيحة أخرى';
                });
            } else if (latestStatus === 'victory') {
                let streak = 0;
                for (const date of sortedDates) {
                    if (userHabitData[date] === 'victory') streak++;
                    else break;
                }
                if (streak >= 3) {
                    contextualTitle.innerHTML = `أحسنت! <span class="text-success">${streak} أيام</span> من الانتصار المتواصل`;
                    contextualBtn.innerHTML = `<i class="bi bi-trophy-fill me-2"></i>✨ احتفل بإنجازك`;
                    contextualCard.classList.remove('d-none');
                    const newBtn = contextualBtn.cloneNode(true);
                    contextualBtn.parentNode.replaceChild(newBtn, contextualBtn);
                    document.getElementById('contextual-gemini-btn').addEventListener('click', async (e) => {
                        const btn = e.currentTarget;
                        btn.disabled = true;
                        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> جاري كتابة رسالة احتفال...`;
                        
                        // START: Modified Prompt
                        const prompt = `
        بصفتك ناصحا على المنهج السلفي، اكتب رسالة احتفال مؤثرة ومحفزة لمستخدم حقق ${streak} يوما من الانتصار في مجاهدة نفسه. اربط جهاده وصبره في الدنيا بالنعيم العظيم في الآخرة. يجب أن تكون الرسالة فريدة ومناسبة لهذا العدد من الأيام.

        الضوابط الحاسمة:
        1. المنهج: يجب أن تكون الرسالة متوافقة تماما مع المنهج السلفي الصالح وحدوده الشرعية.
        2. التنويع في البشارة: لا تكرر ذكر نعيم معين في كل مرة، خاصة "الحور العين". استخدم في كل مرة بشارة مختلفة من نعيم الجنة مثل:
           - قصور الجنة وأنهارها (من لبن وعسل وخمر).
           - رؤية وجه الله الكريم وهو أعظم النعيم.
           - صحبة النبيين والصديقين والشهداء.
           - غرس أشجار في الجنة بكل يوم صبر.
           - بناء بيت في الجنة.
           - تبديل السيئات حسنات.
           - أجر الصابرين الذي يوفى بغير حساب.
        3. الأسلوب: اجعل الرسالة قصيرة، مركزة، ومباشرة. استخدم لغة عربية فصيحة ومبسطة، وتجنب العامية واللهجات.
        4. الهدف: رفع معنويات المستخدم وتقوية عزيمته للاستمرار في طريق المجاهدة.
        5. التنسيق: لا تستخدم أي حركات تشكيل على الحروف إطلاقا (فتحة، ضمة، كسرة، تنوين، شدة، سكون).`;
                        // END: Modified Prompt

                        const result = await callGeminiAPI(prompt);
                        
                        // Apply new styling for celebration result
                        contextualResultContainer.style.backgroundColor = ''; // Remove default background
                        contextualResultContainer.classList.add('celebration-result');
                        setRandomBackground(contextualResultContainer, 'celebration');

                        contextualResultText.textContent = result;
                        contextualResultContainer.classList.remove('d-none');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-trophy-fill me-2"></i>✨ اطلب رسالة جديدة';
                    });
                }
            }
        }

        async function renderCalendar() {
            await autoFillAbsence();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            monthYearEl.textContent = `${monthNames[month]} ${year}`;
            weekdaysEl.innerHTML = ['ح', 'ن', 'ث', 'ر', 'خ', 'ج', 'س'].map(day => `<div class="weekday">${day}</div>`).join('');
            daysEl.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) daysEl.innerHTML += `<div></div>`;
            const habitData = userHabitData;
            let counts = { absence: 0, relapse: 0, slip: 0, victory: 0 };
            for (const dateStr in habitData) {
                const status = habitData[dateStr];
                if (counts[status] !== undefined) counts[status]++;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (habitData[dateString]) {
                    const status = habitData[dateString];
                    const colorMap = { absence: 'orange', relapse: 'grey', slip: 'red', victory: 'green' };
                    dayEl.classList.add(colorMap[status]);
                }
                if (day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                    dayEl.classList.add('today');
                }
                daysEl.appendChild(dayEl);
            }
            document.getElementById('absence-count').textContent = counts.absence;
            document.getElementById('relapse-count').textContent = counts.relapse;
            document.getElementById('slip-count').textContent = counts.slip;
            document.getElementById('victory-count').textContent = counts.victory;
            await updateContextualGeminiFeature();
        }

        const styleButtons = document.querySelectorAll('.analysis-toggle-btn');
        styleButtons.forEach(button => {
            button.addEventListener('click', () => {
                styleButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
        });

        analyzeBtn.addEventListener('click', async () => {
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جار التحليل...`;
            analysisResultContainer.classList.add('d-none');
            
            const selectedStyle = document.querySelector('.analysis-toggle-btn.active').dataset.style;
            const counts = { victory: document.getElementById('victory-count').textContent, slip: document.getElementById('slip-count').textContent, relapse: document.getElementById('relapse-count').textContent, absence: document.getElementById('absence-count').textContent, };
            let personaPrompt = "";
            switch (selectedStyle) {
                case 'leader': personaPrompt = "بصفتك قائد ملهم يخاطب أحد أبطاله، حلل بيانات الأداء هذي. استخدم لغة قوية ومفعمة بالفخر وركز على الانتصارات كدليل على العزيمة والإصرار. اجعل التحليل بمثابة وسام شرف وتقدير للمعركة التي يخوضها."; break;
                case 'advisor': default: personaPrompt = "بصفتك مدرب شخصي وناصح أمين، حلل بيانات الأداء هذي لشخص يحاول يتعافى من إدمان."; break;
            }
            let prompt = `${personaPrompt} بيانات الأداء الإجمالية: - أيام الانتصار: ${counts.victory} - أيام الزلات: ${counts.slip} - أيام الانتكاسات: ${counts.relapse} - أيام الغياب: ${counts.absence}. عطني تقرير مختصر وداعم. التزم بالقواعد هذي بدقة: 1. اللهجة: تكلم باللهجة السعودية العامية فقط. 2. التنسيق: لا تستخدم أي تشكيل أو علامات ترقيم أبداً. 3. الأسلوب: خل كلامك طبيعي كأنك تسولف مع واحد تعرفه. 4. المحتوى: عطني تحليل مناسب للشخصية اللي طلبتها.`;
            if (previousAnalyses.length > 0) prompt += `\nالتحليلات اللي عطيتها قبل هي: "${previousAnalyses.join('", "')}". لا تكرر نفس الكلام وعطني تحليل جديد ومختلف.`;
            const result = await callGeminiAPI(prompt);
            if(result && !previousAnalyses.includes(result)) {
                previousAnalyses.push(result);
                if (previousAnalyses.length > 5) previousAnalyses.shift(); 
            }
            analysisResultText.textContent = result;
            analysisResultContainer.classList.remove('d-none');
            setRandomBackground(analyzeFrame, 'analysis'); 
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '✨ إعادة تحليل أدائي';
        });

        async function initializeCalendar() {
            await getHabitData();
            await renderCalendar();

            setRandomBackground(analyzeFrame, 'analysis');

            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            document.querySelectorAll('#addStatusModal button[data-status]').forEach(button => {
                button.addEventListener('click', async () => {
                    const status = button.dataset.status;
                    const dateString = toDateString(new Date());
                    const currentData = await getHabitData();
                    currentData[dateString] = status;
                    await saveHabitData(currentData);
                    addStatusModal.hide();
                    await renderCalendar();
                });
            });
        }
    </script>
    
    <!-- Loading Spinner -->
    <div id="loading-spinner-overlay" class="loading-spinner-overlay">
        <div class="loading-spinner"></div>
    </div>
    <!-- End Loading Spinner -->
    
</body>
</html>
