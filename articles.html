<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>العادات | لا أبرح حتى أبلغ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00a884;
            --danger-color: #ff5c5c;
            --background-color: #121212;
            --card-background: #1e1e1e;
            --text-color: #FAFAFA;
            --secondary-text-color: #CCCCCC;
            --border-color: #383838;
            --primary-glow: rgba(0, 168, 132, 0.5);
        }
        body, html {
            margin: 0; padding: 0; font-family: 'Tajawal', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?w=1920&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            position: fixed; width: 100%; height: 100%; overflow: hidden;
        }
        .page { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .bottom-nav { 
            display: flex; justify-content: space-around; padding: 0.5rem 0; 
            background-color: rgba(30, 30, 30, 0.5); backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); box-shadow: 0 -2px 15px rgba(0,0,0,0.3); 
            position: fixed; bottom: 0; width: 100%; z-index: 100; 
            border-top: 1px solid rgba(56, 56, 56, 0.5);
        }
        
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text-color); text-decoration: none; font-size: 0.75rem; cursor: pointer; width: 14%; height: 50px; justify-content: center; transition: color 0.3s ease; }
        .nav-item:hover { color: var(--text-color); }
        .nav-item i { font-size: 1.5rem; margin-bottom: 4px; transition: transform 0.3s ease; }
        .nav-item:hover i { transform: translateY(-3px); }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.special-item { transform: translateY(-20px); position: relative; }
        .special-item .icon-background { background: linear-gradient(135deg, #00a884, #00c896); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px var(--primary-glow); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .special-item:hover .icon-background { transform: scale(1.1); box-shadow: 0 6px 20px var(--primary-glow); }
        .special-item i { color: white; font-size: 2rem; margin: 0; }

        .chat-notification-badge {
            position: absolute; top: -8px; right: 25px; background-color: var(--danger-color);
            color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 13px;
            font-weight: bold; display: none; justify-content: center; align-items: center;
            border: 2px solid var(--card-background); z-index: 1;
        }

        #habits-section-wrapper { 
            background-color: transparent; flex-grow: 1; overflow-y: auto; 
            padding: 20px; padding-bottom: 90px;
        }
        
        .page-header { 
            display: flex; justify-content: space-between; align-items: center; padding: 1rem; 
            background-color: rgba(18, 18, 18, 0.5); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; position: relative; z-index: 2; 
        }
        .page-header h5 { text-shadow: 0 0 10px var(--primary-glow); font-weight: 700; margin: 0; }
        .header-btn { background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer; }

        .form-control { background-color: var(--background-color); border-color: var(--border-color); border-radius: 10px; padding: 12px; color: var(--text-color); }
        .form-control::placeholder { color: var(--secondary-text-color); opacity: 0.7; }
        .form-control:focus { background-color: var(--background-color); border-color: var(--primary-color); color: var(--text-color); box-shadow: 0 0 0 0.25rem var(--primary-glow); }
        
        .modal-content { background-color: var(--card-background); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 20px; }
        .modal-header { border-bottom-color: var(--border-color); }
        .modal-title { color: #FFFFFF; font-weight: 700; }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        
        #app-lock-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(18, 18, 18, 0.95); z-index: 2000;
            display: none; flex-direction: column; justify-content: center;
            align-items: center; backdrop-filter: blur(10px);
        }
        .lock-container { text-align: center; padding: 2rem; background-color: var(--card-background); border-radius: 15px; border: 1px solid var(--border-color); }
        .lock-container .icon { font-size: 4rem; color: var(--primary-color); margin-bottom: 1rem; }
        #passcode-input { max-width: 200px; margin: 1.5rem auto; letter-spacing: 1.5rem; font-size: 1.5rem; text-align: center; direction: ltr; }
        #passcode-input::placeholder { letter-spacing: normal; }
        #unlock-btn { width: 100%; max-width: 200px; }
        #passcode-error { display: none; color: var(--danger-color); font-size: 0.9rem; margin-top: 1rem; }
        
        body.solid-black-bg { background-image: none !important; background-color: #000000 !important; }
        body.gradient-blue-bg { background-image: linear-gradient(135deg, #0f2027, #203a43, #2c5364) !important; }

        .habit-card { 
            margin-bottom: 1rem; background-color: rgba(30, 30, 30, 0.75); 
            border: 1px solid var(--border-color); box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: 15px; overflow: hidden; transition: all 0.3s ease;
            display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem;
        }
        .habit-card.completed { background-color: rgba(0, 168, 132, 0.2); border-color: var(--primary-color); }
        .habit-card .form-check-input {
            width: 1.8em; height: 1.8em; cursor: pointer; border-color: var(--border-color);
            background-color: var(--background-color);
        }
        .habit-card .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
        .habit-info { display: flex; align-items: center; }
        .habit-info i { font-size: 1.5rem; color: var(--primary-color); }
        .habit-name { font-size: 1.1rem; font-weight: 500; margin-right: 1rem; }
        
        #habit-stats-summary {
            background-color: rgba(30, 30, 30, 0.75) !important; border: 1px solid var(--border-color) !important;
            border-radius: 15px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            font-weight: 500; font-size: 1.2rem;
        }

        #icon-picker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 1rem; max-height: 200px; overflow-y: auto; padding: 10px; background-color: rgba(0,0,0,0.2); border-radius: 10px;}
        .icon-picker-item { font-size: 1.8rem; text-align: center; padding: 10px; border-radius: 10px; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; border: 2px solid transparent; }
        .icon-picker-item:hover { background-color: var(--border-color); transform: scale(1.1); }
        .icon-picker-item.selected { background-color: var(--primary-glow); border-color: var(--primary-color); }

        .habit-stat-item { background-color: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 10px; display: flex; align-items: center; justify-content: space-between;}
        
        #statsModal .modal-content {
            background-color: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .stat-card-glass {
            border-radius: 20px;
            padding: 1.5rem;
            color: white;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: transform 0.3s ease;
        }

        .stat-card-glass:hover { transform: translateY(-5px); }
        .grad-1 { background: linear-gradient(135deg, rgba(255, 102, 102, 0.4), rgba(255, 153, 102, 0.3)); }
        .grad-2 { background: linear-gradient(135deg, rgba(52, 152, 219, 0.4), rgba(41, 128, 185, 0.3)); }
        .grad-3 { background: linear-gradient(135deg, rgba(26, 188, 156, 0.4), rgba(22, 160, 133, 0.3)); }
        .grad-4 { background: linear-gradient(135deg, rgba(155, 89, 182, 0.4), rgba(142, 68, 173, 0.3)); }
        .stat-card-glass .icon { font-size: 2.5rem; opacity: 0.9; }
        .stat-card-glass .content .title { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.25rem; opacity: 0.9; }
        .stat-card-glass .content .value { font-size: 2.2rem; font-weight: 700; line-height: 1; }
        
        #onboarding-section {
            background-color: rgba(30, 30, 30, 0.75);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .suggested-habit-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            transition: background-color 0.3s ease;
        }
        .suggested-habit-card:hover { background-color: rgba(0,0,0,0.4); }
        .add-suggested-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2rem;
            line-height: 1;
            transition: transform 0.2s ease;
        }
        .add-suggested-btn:hover { transform: scale(1.1); }
        
        .bi-custom-islamic-prayer {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.125em;
            background-color: currentColor;
            -webkit-mask-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='currentColor'%3e%3cpath d='M13.5 15.5h-11V6.2C2.5 3.5 4.9 1 8 1s5.5 2.5 5.5 5.2v8.3z M4 14h8V6.2c0-2.2-1.8-4-4-4s-4 1.8-4 4V14z'/%3e%3cpath d='M8 4.5a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm0 3c-1.5 0-2 .5-2 3s.5 3 2 3 2-1.5 2-3-.5-3-2-3zm0 1.5c.8 0 1 .7 1 1.5s-.2 1.5-1 1.5-1-.7-1-1.5.2-1.5 1-1.5z'/%3e%3c/svg%3e");
            mask-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='currentColor'%3e%3cpath d='M13.5 15.5h-11V6.2C2.5 3.5 4.9 1 8 1s5.5 2.5 5.5 5.2v8.3z M4 14h8V6.2c0-2.2-1.8-4-4-4s-4 1.8-4 4V14z'/%3e%3cpath d='M8 4.5a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm0 3c-1.5 0-2 .5-2 3s.5 3 2 3 2-1.5 2-3-.5-3-2-3zm0 1.5c.8 0 1 .7 1 1.5s-.2 1.5-1 1.5-1-.7-1-1.5.2-1.5 1-1.5z'/%3e%3c/svg%3e");
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-size: 1em 1em;
            mask-repeat: no-repeat;
            mask-size: 1em 1em;
        }
    </style>
</head>
<body>
    <div id="app-lock-overlay">
        <div class="lock-container">
            <i class="bi bi-shield-lock-fill icon"></i>
            <h5>التطبيق مقفل</h5>
            <p class="text-secondary small">أدخل رمز المرور للمتابعة</p>
            <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="form-control" id="passcode-input" placeholder="----">
            <div id="passcode-error">رمز المرور غير صحيح</div>
            <button id="unlock-btn" class="btn btn-primary mt-2">فتح القفل</button>
        </div>
    </div>

    <div id="habits-page" class="page">
        <header class="page-header">
             <div style="width: 40px;"></div>
            <h5 class="m-0">العادات</h5>
            <button id="open-stats-btn" class="header-btn" data-bs-toggle="modal" data-bs-target="#statsModal" style="width: 40px;">
                <i class="bi bi-bar-chart-line-fill"></i>
            </button>
        </header>

        <div id="habits-section-wrapper">
            <div class="container">
                <div id="habit-stats-summary" class="mb-4 p-3 text-center">...</div>
                <button type="button" id="main-add-habit-btn" class="btn btn-success w-100 mb-4 p-3" data-bs-toggle="modal" data-bs-target="#addHabitModal">
                    <i class="bi bi-plus-lg me-2"></i> إضافة عادة جديدة
                </button>
                <div id="onboarding-section" style="display: none;">
                    <h5 class="text-center mb-4">ابدأ رحلتك باختيار عادة جاهزة</h5>
                    <div id="suggested-habits-list"></div>
                </div>
                <div id="habits-list"></div>
            </div>
        </div>

        <nav class="bottom-nav">
            <a href="main.html" class="nav-item"><i class="bi bi-house-door-fill"></i><span>الرئيسية</span></a>
            <a href="diaries.html" class="nav-item"><i class="bi bi-book-fill"></i><span>اليوميات</span></a>
            <a href="articles.html" class="nav-item active"><i class="bi bi-check2-square"></i><span>العادات</span></a>
            <a href="chat.html" class="nav-item special-item">
                <div class="icon-background"><i class="bi bi-chat-dots-fill"></i></div>
                <span>دردشة</span>
                <span class="chat-notification-badge"></span>
            </a>
            <a href="follow-up.html" class="nav-item"><i class="bi bi-signpost-split-fill"></i><span>المتابعة</span></a>
            <a href="library.html" class="nav-item"><i class="bi bi-collection-fill"></i><span>المكتبة</span></a>
            <a href="settings.html" class="nav-item"><i class="bi bi-gear-fill"></i><span>الاعدادات</span></a>
        </nav>
    </div>

    <div class="modal fade" id="addHabitModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة عادة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                     <form id="add-habit-form">
                        <div class="mb-3">
                            <label for="habit-name-input" class="form-label">اسم العادة</label>
                            <input type="text" id="habit-name-input" class="form-control" placeholder="مثال: القراءة لمدة 15 دقيقة" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">اختر أيقونة</label>
                            <div id="icon-picker-grid"></div>
                        </div>
                         <div id="habit-modal-error" class="text-danger small mt-2" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" id="save-habit-button" class="btn btn-success">حفظ العادة</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">تأكيد الحذف</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    هل أنت متأكد من رغبتك في حذف هذه العادة؟ سيتم حذف جميع سجلاتها بشكل دائم.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">حذف</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إحصائيات العادات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="stats-grid mb-4">
                        <div class="stat-card-glass grad-1">
                            <div class="icon"><i class="bi bi-trophy-fill"></i></div>
                            <div class="content">
                                <div class="title">أطول سلسلة مستمرة</div>
                                <div class="value" id="stats-longest-streak">0</div>
                            </div>
                        </div>
                        <div class="stat-card-glass grad-2">
                            <div class="icon"><i class="bi bi-fire"></i></div>
                            <div class="content">
                                <div class="title">السلسلة الحالية</div>
                                <div class="value" id="stats-current-streak">0</div>
                            </div>
                        </div>
                        <div class="stat-card-glass grad-3">
                            <div class="icon"><i class="bi bi-pie-chart-fill"></i></div>
                            <div class="content">
                                <div class="title">معدل الإنجاز</div>
                                <div class="value" id="stats-completion-rate">0%</div>
                            </div>
                        </div>
                        <div class="stat-card-glass grad-4">
                            <div class="icon"><i class="bi bi-calendar-check-fill"></i></div>
                            <div class="content">
                                <div class="title">معدل النجاح الشهري</div>
                                <div class="value" id="stats-monthly-rate">0%</div>
                            </div>
                        </div>
                    </div>
                    <h6 class="mb-3 mt-4">الأداء الأسبوعي</h6>
                    <div><canvas id="weekly-chart"></canvas></div>
                    
                    <div class="row mt-4">
                        <div class="col-lg-6 mb-3 mb-lg-0">
                             <h6 class="mb-3"><i class="bi bi-check2-circle-fill me-2"></i>تحليل الإنجاز</h6>
                             <div id="habit-breakdown" class="d-grid gap-2"></div>
                        </div>
                        <div class="col-lg-6">
                            <h6 class="mb-3"><i class="bi bi-link-45deg me-2"></i>أطول سلسلة لكل عادة</h6>
                            <div id="habit-streaks-breakdown" class="d-grid gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, Timestamp, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGgZmhJ_mMezlf7xElisvzJ8l9D758d4g",
            authDomain: "my-chat-app-daaf8.firebaseapp.com",
            projectId: "my-chat-app-daaf8",
            storageBucket: "my-chat-app-daaf8.firebasestorage.app",
            messagingSenderId: "789086064752",
            appId: "1:789086064752:web:d081f1b6832dabca1d64b5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global Notification & Theme Logic ---
        function initializeGlobalChatNotifications(userId) { /* ... no changes ... */ }
        function applyBackgroundPreference() {
            const savedTheme = localStorage.getItem('appBackgroundTheme') || 'default';
            const body = document.body;
            
            body.classList.remove('solid-black-bg', 'gradient-blue-bg');
            
            if (savedTheme === 'solid-black') {
                body.classList.add('solid-black-bg');
            } else if (savedTheme === 'gradient-blue') {
                body.classList.add('gradient-blue-bg');
            }
        }
        applyBackgroundPreference();

        // --- App Lock Logic (No changes) ---
        const appLockOverlay = document.getElementById('app-lock-overlay');
        const passcodeError = document.getElementById('passcode-error');
        const unlockBtn = document.getElementById('unlock-btn');
        const passcodeInput = document.getElementById('passcode-input');
        const RELOCK_TIME = 3 * 60 * 1000;
        function getLockData() { try { return JSON.parse(localStorage.getItem('app_lock_config')) || { enabled: false, passcode: null }; } catch (e) { return { enabled: false, passcode: null }; } }
        function initializeAppLock() { const lockData = getLockData(); if (!lockData.enabled) return; const lastUnlock = localStorage.getItem('app_last_unlock') || 0; const timeSinceUnlock = Date.now() - lastUnlock; if (timeSinceUnlock >= RELOCK_TIME) { appLockOverlay.style.display = 'flex'; } }
        function handleUnlock() { const enteredPasscode = passcodeInput.value; const lockData = getLockData(); passcodeError.style.display = 'none'; if (enteredPasscode === lockData.passcode) { localStorage.setItem('app_last_unlock', Date.now()); appLockOverlay.style.display = 'none'; passcodeInput.value = ''; } else { passcodeError.style.display = 'block'; passcodeInput.classList.add('is-invalid'); setTimeout(() => passcodeInput.classList.remove('is-invalid'), 1000); } }
        unlockBtn.addEventListener('click', handleUnlock);
        passcodeInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleUnlock(); });
        
        // =======================================================
        // HABIT TRACKER LOGIC
        // =======================================================
        const habitsList = document.getElementById('habits-list');
        const habitStatsSummary = document.getElementById('habit-stats-summary');
        const addHabitModalEl = document.getElementById('addHabitModal');
        const addHabitModal = new bootstrap.Modal(addHabitModalEl);
        const saveHabitButton = document.getElementById('save-habit-button');
        const habitNameInput = document.getElementById('habit-name-input');
        const iconPickerGrid = document.getElementById('icon-picker-grid');
        let selectedIcon = null;
        let weeklyChart = null;
        
        const mainAddHabitBtn = document.getElementById('main-add-habit-btn');
        const onboardingSection = document.getElementById('onboarding-section');
        const suggestedHabitsList = document.getElementById('suggested-habits-list');
        const deleteConfirmModalEl = document.getElementById('deleteConfirmModal');
        const deleteConfirmModal = new bootstrap.Modal(deleteConfirmModalEl);
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        let habitIdToDelete = null; 

        let currentUser = null;
        let isUserAnonymous = true;
        let userHabitData = { habits: [], history: {} };
        let unsubscribeFromFirestore = null;

        const icons = [ 
            'bi-book-fill', 'bi-alarm-fill', 'bi-apple', 'bi-bicycle', 'bi-brightness-high-fill', 'bi-calendar-check-fill', 'bi-camera-fill', 'bi-chat-dots-fill', 'bi-cloud-moon-fill', 'bi-controller', 'bi-cup-hot-fill', 'bi-dribbble', 'bi-droplet-fill', 'bi-earbuds', 'bi-emoji-smile-fill', 'bi-film', 'bi-flag-fill', 'bi-flower1', 'bi-fuel-pump-fill', 'bi-geo-alt-fill', 'bi-gift-fill', 'bi-graph-up-arrow', 'bi-headphones', 'bi-heart-pulse-fill', 'bi-house-heart-fill', 'bi-journal-richtext', 'bi-lightbulb-fill', 'bi-mic-fill', 'bi-moon-stars-fill', 'bi-custom-islamic-prayer', 'bi-music-note-beamed', 'bi-palette-fill', 'bi-peace-fill', 'bi-pen-fill', 'bi-person-walking', 'bi-piggy-bank-fill', 'bi-plant-fill', 'bi-puzzle-fill', 'bi-recycle', 'bi-shield-check', 'bi-shop', 'bi-slash-circle-fill', 'bi-speedometer2', 'bi-star-fill', 'bi-sunglasses', 'bi-sunrise-fill', 'bi-tree-fill', 'bi-trophy-fill', 'bi-universal-access', 'bi-wallet-fill', 'bi-water', 'bi-mortarboard-fill', 'bi-briefcase-fill', 'bi-cash-coin', 'bi-clipboard2-check-fill', 'bi-code-slash', 'bi-credit-card-fill', 'bi-door-open-fill', 'bi-envelope-fill', 'bi-hammer', 'bi-hourglass-split', 'bi-kanban-fill', 'bi-list-task', 'bi-paint-bucket', 'bi-phone-fill', 'bi-scissors', 'bi-search', 'bi-shield-shaded', 'bi-sort-down', 'bi-cone-striped', 'bi-key-fill', 'bi-lungs-fill', 'bi-bandaid-fill', 'bi-basket-fill', 'bi-bell-slash-fill', 'bi-bluetooth', 'bi-body-text', 'bi-brilliance', 'bi-calendar3-week-fill', 'bi-capslock-fill', 'bi-chat-heart-fill', 'bi-cloud-drizzle-fill', 'bi-compass-fill', 'bi-crop', 'bi-diamond-fill', 'bi-displayport-fill', 'bi-eraser-fill', 'bi-eye-fill', 'bi-filter-circle-fill', 'bi-fullscreen', 'bi-gem', 'bi-wind', 'bi-people-fill', 'bi-brush-fill', 'bi-cart-fill', 'bi-pc-display-horizontal', 'bi-capsule', 'bi-sunset-fill', 'bi-speaker-fill', 'bi-vector-pen', 'bi-wrench-adjustable', 'bi-newspaper', 'bi-graph-up', 'bi-suit-heart-fill', 'bi-camera-reels-fill', 'bi-person-hearts', 'bi-moisture', 'bi-egg-fried', 'bi-book-half', 'bi-currency-dollar', 'bi-box2-heart-fill'
        ];

        async function saveData(data) {
            userHabitData = data; 
            if (isUserAnonymous) {
                localStorage.setItem('habitsApp_data_v2', JSON.stringify(data));
                renderHabits();
            } else if (currentUser) {
                const userDocRef = doc(db, 'users', currentUser.uid, 'habitsData', 'main');
                await setDoc(userDocRef, data);
            }
        }

        function renderHabits() {
            const todayStr = new Date().toISOString().split('T')[0];
            const data = userHabitData;
            
            if (!data.habits || data.habits.length === 0) {
                mainAddHabitBtn.style.display = 'none';
                onboardingSection.style.display = 'block';
                habitsList.innerHTML = ''; 
                renderSuggestedHabits();
            } else {
                mainAddHabitBtn.style.display = 'block';
                onboardingSection.style.display = 'none';
                const completedToday = data.history ? (data.history[todayStr] || []) : [];
                habitsList.innerHTML = ''; 
                data.habits.forEach(habit => {
                    const isCompleted = completedToday.includes(habit.id);
                    const card = document.createElement('div');
                    card.className = `habit-card ${isCompleted ? 'completed' : ''}`;
                    card.dataset.id = habit.id;
                    card.innerHTML = `<div class="habit-info"><i class="bi ${habit.icon || 'bi-star-fill'}"></i><span class="habit-name">${habit.name}</span></div><div class="d-flex align-items-center"><button class="btn btn-sm delete-habit-btn p-0 ms-3" style="background-color: transparent; border: none; color: var(--danger-color); font-size: 1.1rem;" title="حذف العادة"><i class="bi bi-trash"></i></button><div class="form-check"><input class="form-check-input" type="checkbox" ${isCompleted ? 'checked' : ''}></div></div>`;
                    habitsList.appendChild(card);
                });
            }
            updateSummaryStats();
        }
        
        function renderSuggestedHabits() {
            const suggestions = [
                { name: 'قراءة يومية', icon: 'bi-book-fill' },
                { name: 'شرب الماء', icon: 'bi-droplet-fill' },
                { name: 'أذكار الصباح والمساء', icon: 'bi-custom-islamic-prayer' },
                { name: 'تمرين رياضي', icon: 'bi-bicycle' }
            ];
            suggestedHabitsList.innerHTML = '';
            suggestions.forEach(s => {
                const card = document.createElement('div');
                card.className = 'suggested-habit-card';
                card.innerHTML = `
                    <span><i class="bi ${s.icon} me-2"></i> ${s.name}</span>
                    <button class="add-suggested-btn" data-name="${s.name}" data-icon="${s.icon}">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                `;
                suggestedHabitsList.appendChild(card);
            });
        }

        async function addSuggestedHabit(name, icon) {
            const newData = JSON.parse(JSON.stringify(userHabitData));
            newData.habits = newData.habits || [];
            const newHabit = { id: Date.now().toString(), name: name, icon: icon, createdAt: new Date().toISOString().split('T')[0] };
            newData.habits.push(newHabit);
            await saveData(newData);
        }

        function updateSummaryStats() {
            const todayStr = new Date().toISOString().split('T')[0];
            const data = userHabitData;
            const completedCount = data.history ? (data.history[todayStr] || []).length : 0;
            const totalCount = data.habits ? data.habits.length : 0;
            habitStatsSummary.textContent = `العادات المنجزة اليوم: ${completedCount} / ${totalCount}`;
        }
        
        async function toggleHabit(habitId) {
            const todayStr = new Date().toISOString().split('T')[0];
            const newData = JSON.parse(JSON.stringify(userHabitData));
            newData.history = newData.history || {};
            newData.history[todayStr] = newData.history[todayStr] || [];
            
            const completedToday = newData.history[todayStr];
            const habitIndex = completedToday.indexOf(habitId);
            if (habitIndex > -1) { 
                completedToday.splice(habitIndex, 1); 
            } else { 
                completedToday.push(habitId); 
            }
            await saveData(newData);
        }

        function openDeleteModal(habitId) {
            habitIdToDelete = habitId;
            deleteConfirmModal.show();
        }

        async function executeDelete() {
            if (!habitIdToDelete) return;
            const newData = JSON.parse(JSON.stringify(userHabitData));
            newData.habits = newData.habits.filter(habit => habit.id !== habitIdToDelete);
            if (newData.history) {
                Object.keys(newData.history).forEach(date => {
                    newData.history[date] = newData.history[date].filter(id => id !== habitIdToDelete);
                    if (newData.history[date].length === 0) {
                        delete newData.history[date];
                    }
                });
            }
            await saveData(newData);
            habitIdToDelete = null;
            deleteConfirmModal.hide();
        }

        async function saveNewHabit() {
            const habitName = habitNameInput.value.trim();
            const errorEl = document.getElementById('habit-modal-error');
            errorEl.style.display = 'none';

            if (!habitName) { errorEl.textContent = "الرجاء إدخال اسم العادة."; errorEl.style.display = 'block'; return; }
            if (!selectedIcon) { errorEl.textContent = "الرجاء اختيار أيقونة."; errorEl.style.display = 'block'; return; }

            const newData = JSON.parse(JSON.stringify(userHabitData));
            newData.habits = newData.habits || [];
            const newHabit = { id: Date.now().toString(), name: habitName, icon: selectedIcon, createdAt: new Date().toISOString().split('T')[0] };
            newData.habits.push(newHabit);
            
            await saveData(newData);
            addHabitModal.hide();
        }
        
        function calculateAndDisplayStats() {
            const data = userHabitData;
            const habitBreakdownContainer = document.getElementById('habit-breakdown');
            const habitStreaksContainer = document.getElementById('habit-streaks-breakdown');

            if (!data.habits || data.habits.length === 0) {
                 document.getElementById('stats-longest-streak').textContent = 0;
                 document.getElementById('stats-current-streak').textContent = 0;
                 document.getElementById('stats-completion-rate').textContent = `0%`;
                 document.getElementById('stats-monthly-rate').textContent = `0%`;
                 if(weeklyChart) weeklyChart.destroy();
                 const noDataMsg = '<p class="text-center text-secondary">لا توجد بيانات لعرضها.</p>';
                 habitBreakdownContainer.innerHTML = noDataMsg;
                 habitStreaksContainer.innerHTML = noDataMsg;
                return;
            }

            const sortedDates = Object.keys(data.history).sort();
            let longestStreak = 0, currentStreak = 0;
            let totalCompletions = 0, totalPossibleCompletions = 0;
            if (sortedDates.length > 0) {
                let lastDate = new Date(sortedDates[0]);
                lastDate.setDate(lastDate.getDate() - 1);
                for (const dateStr of sortedDates) {
                    const currentDate = new Date(dateStr);
                    const habitsOnDate = data.habits.filter(h => h.createdAt <= dateStr);
                    if (habitsOnDate.length === 0) continue;
                    
                    const completedOnDate = data.history[dateStr] || [];
                    totalCompletions += completedOnDate.length;
                    totalPossibleCompletions += habitsOnDate.length;

                    const diffDays = Math.round((currentDate - lastDate) / (1000 * 60 * 60 * 24));

                    if (completedOnDate.length === habitsOnDate.length && completedOnDate.length > 0) {
                        if (diffDays === 1) { currentStreak++; } else { currentStreak = 1; }
                    } else { longestStreak = Math.max(longestStreak, currentStreak); currentStreak = 0; }
                    longestStreak = Math.max(longestStreak, currentStreak);
                    lastDate = currentDate;
                }
            }
            const today = new Date();
            const lastHistoryDate = sortedDates.length > 0 ? new Date(sortedDates[sortedDates.length - 1]) : null;
            if (lastHistoryDate) {
                const diffFromLast = (today.setHours(0,0,0,0) - lastHistoryDate.setHours(0,0,0,0)) / (1000 * 60 * 60 * 24);
                if (diffFromLast > 1) { currentStreak = 0; }
            } else { currentStreak = 0; }
            
            const completionRate = totalPossibleCompletions > 0 ? Math.round((totalCompletions / totalPossibleCompletions) * 100) : 0;
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            let monthlyCompletions = 0;
            let monthlyPossible = 0;
            for (const dateStr of sortedDates) {
                const date = new Date(dateStr);
                if (date.getFullYear() === currentYear && date.getMonth() === currentMonth) {
                    const habitsOnDate = data.habits.filter(h => h.createdAt <= dateStr);
                    if (habitsOnDate.length > 0) {
                        monthlyPossible += habitsOnDate.length;
                        monthlyCompletions += (data.history[dateStr] || []).length;
                    }
                }
            }
            const monthlySuccessRate = monthlyPossible > 0 ? Math.round((monthlyCompletions / monthlyPossible) * 100) : 0;

            document.getElementById('stats-longest-streak').textContent = longestStreak;
            document.getElementById('stats-current-streak').textContent = currentStreak;
            document.getElementById('stats-completion-rate').textContent = `${completionRate}%`;
            document.getElementById('stats-monthly-rate').textContent = `${monthlySuccessRate}%`;

            const labels = [];
            const chartData = [];
            const baseDate = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(baseDate);
                date.setDate(baseDate.getDate() - i); 
                
                const dateStr = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('ar-EG', { weekday: 'short' }));
                chartData.push((data.history[dateStr] || []).length);
            }
            const ctx = document.getElementById('weekly-chart').getContext('2d');
            if(weeklyChart) weeklyChart.destroy();
            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'العادات المنجزة', data: chartData, backgroundColor: 'rgba(0, 168, 132, 0.6)', borderColor: 'rgba(0, 168, 132, 1)', borderWidth: 1, borderRadius: 5 }] },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
            
            habitBreakdownContainer.innerHTML = '';
            habitStreaksContainer.innerHTML = '';
            data.habits.forEach(habit => {
                const completionCount = Object.values(data.history).filter(day => day.includes(habit.id)).length;
                const item = document.createElement('div');
                item.className = 'habit-stat-item';
                item.innerHTML = `<span><i class="bi ${habit.icon} me-2"></i>${habit.name}</span><span class="fw-bold">${completionCount} مرة</span>`;
                habitBreakdownContainer.appendChild(item);

                // --- STREAK LOGIC CORRECTION START ---
                let longestHabitStreak = 0;
                let currentHabitStreak = 0;

                // First, get all the dates this specific habit was completed, and make sure they're sorted.
                const habitCompletionDates = sortedDates.filter(date =>
                    date >= habit.createdAt && (data.history[date] || []).includes(habit.id)
                );

                if (habitCompletionDates.length > 0) {
                    // Start the first streak. Any single completion is a streak of 1.
                    currentHabitStreak = 1;
                    longestHabitStreak = 1;

                    // Loop through the completion dates starting from the second one.
                    for (let i = 1; i < habitCompletionDates.length; i++) {
                        const prevDate = new Date(habitCompletionDates[i - 1]);
                        const currentDate = new Date(habitCompletionDates[i]);
                        
                        const diffDays = Math.round((currentDate - prevDate) / (1000 * 60 * 60 * 24));

                        if (diffDays === 1) {
                            // The dates are consecutive, so the streak continues.
                            currentHabitStreak++;
                        } else {
                            // The streak was broken. Compare the streak that just ended with the longest one so far.
                            longestHabitStreak = Math.max(longestHabitStreak, currentHabitStreak);
                            // Start a new streak from 1 for the current completion day.
                            currentHabitStreak = 1;
                        }
                    }
                    // After the loop, do one last check to account for the final streak.
                    longestHabitStreak = Math.max(longestHabitStreak, currentHabitStreak);
                }
                // --- STREAK LOGIC CORRECTION END ---

                const streakItem = document.createElement('div');
                streakItem.className = 'habit-stat-item';
                streakItem.innerHTML = `<span><i class="bi ${habit.icon} me-2"></i>${habit.name}</span><span class="fw-bold">${longestHabitStreak} أيام</span>`;
                habitStreaksContainer.appendChild(streakItem);
            });
        }


        function populateIconPicker() {
            iconPickerGrid.innerHTML = '';
            icons.forEach(iconClass => {
                const iconItem = document.createElement('i');
                iconItem.className = `bi ${iconClass} icon-picker-item`;
                iconItem.dataset.icon = iconClass;
                iconPickerGrid.appendChild(iconItem);
            });
        }
        
        function initializeHabitTracker() {
            populateIconPicker();
            document.getElementById('open-stats-btn').addEventListener('click', calculateAndDisplayStats);
            saveHabitButton.addEventListener('click', saveNewHabit);
            
            habitsList.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') { 
                    const habitId = e.target.closest('.habit-card').dataset.id; 
                    toggleHabit(habitId); 
                }
            });

            habitsList.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-habit-btn');
                if (deleteButton) {
                    const habitId = deleteButton.closest('.habit-card').dataset.id;
                    openDeleteModal(habitId);
                }
            });
            confirmDeleteBtn.addEventListener('click', executeDelete);
            
            suggestedHabitsList.addEventListener('click', (e) => {
                const addButton = e.target.closest('.add-suggested-btn');
                if (addButton) {
                    addSuggestedHabit(addButton.dataset.name, addButton.dataset.icon);
                }
            });

            iconPickerGrid.addEventListener('click', (e) => {
                if (e.target.dataset.icon) {
                    const current = iconPickerGrid.querySelector('.selected');
                    if(current) current.classList.remove('selected');
                    e.target.classList.add('selected');
                    selectedIcon = e.target.dataset.icon;
                }
            });
            addHabitModalEl.addEventListener('hidden.bs.modal', () => {
                 habitNameInput.value = '';
                 selectedIcon = null;
                 const currentSelected = iconPickerGrid.querySelector('.selected');
                 if (currentSelected) currentSelected.classList.remove('selected');
                 document.getElementById('habit-modal-error').style.display = 'none';
            });
        }
        
        onAuthStateChanged(auth, async (user) => {
            initializeAppLock();
            setInterval(() => { if (document.visibilityState === 'visible') { localStorage.setItem('app_last_unlock', Date.now()); } }, 60 * 1000);
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') { initializeAppLock(); } });
            if (user) { initializeGlobalChatNotifications(user.uid); }
            
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }

            currentUser = user;
            isUserAnonymous = !user || user.isAnonymous;

            if (isUserAnonymous) {
                const localDataString = localStorage.getItem('habitsApp_data_v2');
                userHabitData = localDataString ? JSON.parse(localDataString) : { habits: [], history: {} };
                renderHabits(); 
            } else {
                const userDocRef = doc(db, 'users', user.uid, 'habitsData', 'main');

                const localDataString = localStorage.getItem('habitsApp_data_v2');
                if (localDataString) {
                    const localData = JSON.parse(localDataString);
                    if (localData.habits && localData.habits.length > 0) {
                        await setDoc(userDocRef, localData, { merge: true }); 
                        localStorage.removeItem('habitsApp_data_v2'); 
                    }
                }

                unsubscribeFromFirestore = onSnapshot(userDocRef, (docSnap) => {
                    userHabitData = docSnap.exists() ? docSnap.data() : { habits: [], history: {} };
                    renderHabits();
                });
            }
            initializeHabitTracker(); 
        });
    </script>
</body>
</html>

